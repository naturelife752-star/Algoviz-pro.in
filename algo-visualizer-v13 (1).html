<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlgoViz v2 ‚Äî Algorithm Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0f; --surface:#12121a; --card:#1a1a26; --accent:#00f5c4;
  --accent2:#ff6b6b; --accent3:#ffd93d; --accent4:#a78bfa;
  --text:#e8e8f0; --muted:#6b6b8a; --border:#2a2a3e;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;
  background-image:linear-gradient(rgba(0,245,196,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,196,.03) 1px,transparent 1px);
  background-size:60px 60px;z-index:0;pointer-events:none;}

header{position:relative;z-index:10;padding:20px 40px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.logo{font-size:1.5rem;font-weight:800;letter-spacing:-1px;}
.logo span{color:var(--accent);}
.logo sup{font-size:.6rem;color:var(--accent3);vertical-align:super;}
.tagline{color:var(--muted);font-size:.75rem;font-family:'Space Mono',monospace;}

/* NAV TABS */
.nav-tabs{position:relative;z-index:10;display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--surface);}
.nav-tab{padding:14px 28px;cursor:pointer;font-family:'Space Mono',monospace;font-size:.78rem;color:var(--muted);border:none;background:transparent;border-bottom:2px solid transparent;transition:all .2s;}
.nav-tab:hover{color:var(--text);}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}

.page{display:none;position:relative;z-index:10;}
.page.active{display:block;}

/* ===== SINGLE VISUALIZER ===== */
.main{max-width:1100px;margin:0 auto;padding:32px 24px;}
.algo-tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:28px;}
.algo-tab{padding:8px 18px;border-radius:99px;border:1.5px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Space Mono',monospace;font-size:.72rem;transition:all .2s;}
.algo-tab:hover{border-color:var(--accent);color:var(--accent);}
.algo-tab.active{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:700;}

.viz-container{background:var(--surface);border:1px solid var(--border);border-radius:20px;overflow:hidden;margin-bottom:24px;}
.viz-toolbar{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.viz-toolbar label{font-size:.75rem;color:var(--muted);font-family:'Space Mono',monospace;}
.viz-toolbar input[type=range]{accent-color:var(--accent);width:100px;}
.btn{padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-family:'Space Mono',monospace;font-size:.75rem;font-weight:700;transition:all .15s;}
.btn-primary{background:var(--accent);color:var(--bg);}
.btn-primary:hover{opacity:.85;transform:translateY(-1px);}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
canvas{display:block;background:var(--bg);width:100%;height:200px;}
.stats-bar{display:flex;gap:20px;padding:12px 20px;border-top:1px solid var(--border);background:var(--card);flex-wrap:wrap;}
.stat{font-family:'Space Mono',monospace;font-size:.75rem;}
.stat span{color:var(--accent);font-weight:700;}
.legend{display:flex;gap:16px;flex-wrap:wrap;padding:0 20px 12px;font-size:.72rem;font-family:'Space Mono',monospace;color:var(--muted);}
.legend-item{display:flex;align-items:center;gap:5px;}
.legend-dot{width:12px;height:12px;border-radius:3px;}
.step-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 20px;margin-bottom:24px;font-family:'Space Mono',monospace;font-size:.8rem;min-height:56px;line-height:1.6;position:relative;overflow:hidden;}
.step-box::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);border-radius:3px 0 0 3px;}
.step-label{color:var(--accent);font-weight:700;margin-bottom:4px;font-size:.65rem;letter-spacing:2px;}

.panels{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;}
@media(max-width:768px){.panels{grid-template-columns:1fr;}}
.code-panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.code-header{padding:10px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);}
.dot{width:9px;height:9px;border-radius:50%;}
pre{padding:16px 18px;font-family:'Space Mono',monospace;font-size:.72rem;line-height:1.9;overflow-x:auto;background:transparent;color:var(--text);}
.code-line{display:block;transition:background .2s;border-radius:4px;padding:0 4px;margin:0 -4px;}
.code-line.active{background:rgba(0,245,196,.13);color:var(--accent);}
.kw{color:#c792ea;}.fn{color:#82aaff;}.cm{color:var(--muted);}.num{color:var(--accent3);}.op{color:var(--accent2);}

.cx-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;}
.cx-card h3{font-size:.9rem;margin-bottom:14px;color:var(--accent);}
.cx-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.cx-item{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:12px;text-align:center;}
.cx-label{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:5px;}
.cx-val{font-size:.95rem;font-weight:700;color:var(--text);font-family:'Space Mono',monospace;}
.cx-val.bad{color:var(--accent2);}.cx-val.ok{color:var(--accent3);}.cx-val.good{color:var(--accent);}

/* ===== PASTE CODE PAGE ===== */
.paste-main{max-width:900px;margin:0 auto;padding:32px 24px;}
.paste-hero{text-align:center;margin-bottom:32px;}
.paste-hero h2{font-size:2rem;font-weight:800;letter-spacing:-1px;margin-bottom:8px;}
.paste-hero h2 em{color:var(--accent);font-style:normal;}
.paste-hero p{color:var(--muted);font-size:.9rem;}
.editor-area{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px;}
.editor-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);}
.editor-header span{font-family:'Space Mono',monospace;font-size:.75rem;color:var(--muted);}
textarea{width:100%;background:var(--bg);color:var(--text);border:none;outline:none;padding:20px;font-family:'Space Mono',monospace;font-size:.8rem;line-height:1.8;resize:vertical;min-height:260px;}
.parse-result{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px;display:none;}
.parse-result.visible{display:block;}
.parse-result h3{font-size:.9rem;margin-bottom:12px;color:var(--accent3);}
.detected-items{display:flex;flex-wrap:wrap;gap:8px;}
.detected-badge{padding:6px 14px;border-radius:99px;font-family:'Space Mono',monospace;font-size:.72rem;background:var(--surface);border:1px solid var(--accent);color:var(--accent);cursor:pointer;transition:all .2s;}
.detected-badge:hover{background:var(--accent);color:var(--bg);}
.parse-viz-container{margin-top:20px;}
.info-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px;}
.info-box h3{color:var(--accent4);font-size:.9rem;margin-bottom:10px;}
.info-box p{color:var(--muted);font-size:.8rem;line-height:1.7;font-family:'Space Mono',monospace;}
.sample-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}

/* ===== COMPARE PAGE ===== */
.compare-main{max-width:1300px;margin:0 auto;padding:32px 24px;}
.compare-hero{text-align:center;margin-bottom:28px;}
.compare-hero h2{font-size:2rem;font-weight:800;letter-spacing:-1px;margin-bottom:8px;}
.compare-hero h2 em{color:var(--accent);font-style:normal;}
.compare-selectors{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:28px;}
.compare-select-group{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 20px;display:flex;flex-direction:column;gap:8px;min-width:200px;}
.compare-select-group label{font-size:.7rem;color:var(--muted);font-family:'Space Mono',monospace;letter-spacing:1px;}
select{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-family:'Space Mono',monospace;font-size:.78rem;outline:none;cursor:pointer;}
select:focus{border-color:var(--accent);}
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
@media(max-width:900px){.compare-grid{grid-template-columns:1fr;}}
.compare-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
.compare-panel-header{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.compare-panel-header h3{font-size:.9rem;font-weight:700;}
.compare-panel-header h3 span{color:var(--accent);}
.compare-canvas{display:block;background:var(--bg);width:100%;height:200px;}
.compare-stats{display:flex;gap:16px;padding:10px 16px;background:var(--card);flex-wrap:wrap;border-top:1px solid var(--border);}
.compare-step-msg{padding:10px 16px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);min-height:44px;border-top:1px solid var(--border);}
.race-bar-container{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px;}
.race-bar-container h3{font-size:.85rem;color:var(--accent);margin-bottom:14px;font-family:'Space Mono',monospace;}
.race-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.race-label{width:140px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);text-align:right;}
.race-track{flex:1;background:var(--surface);border-radius:99px;height:20px;overflow:hidden;position:relative;border:1px solid var(--border);}
.race-fill{height:100%;border-radius:99px;transition:width .15s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-family:'Space Mono',monospace;font-size:.65rem;font-weight:700;color:var(--bg);}

/* ===== SLIDE VIEW ===== */
.slide-page { max-width: 1100px; margin: 0 auto; padding: 24px 24px 48px; }
.slide-algo-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 24px; }

.slide-deck {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  overflow: hidden;
  box-shadow: 0 0 60px rgba(0,245,196,0.06);
  margin-bottom: 20px;
}

/* Slide header */
.slide-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 28px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
  flex-wrap: wrap; gap: 10px;
}
.slide-algo-name { font-size: 1rem; font-weight: 800; letter-spacing: -0.5px; }
.slide-algo-name span { color: var(--accent); }
.slide-counter {
  font-family: 'Space Mono', monospace; font-size: .78rem; color: var(--muted);
  background: var(--surface); padding: 6px 14px; border-radius: 99px;
  border: 1px solid var(--border);
}
.slide-phase-badge {
  padding: 5px 14px; border-radius: 99px;
  font-family: 'Space Mono', monospace; font-size: .68rem; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
}

/* Main slide body */
.slide-body { display: grid; grid-template-columns: 1fr 340px; min-height: 480px; }
@media(max-width: 860px){ .slide-body { grid-template-columns: 1fr; } }

.slide-left { padding: 32px 28px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 24px; }

/* Big title explanation */
.slide-title-line {
  font-size: clamp(1.1rem, 2.5vw, 1.6rem);
  font-weight: 800; letter-spacing: -0.5px; line-height: 1.2;
}
.slide-title-line em { font-style: normal; color: var(--accent); }

/* Array visual - large rectangles */
.slide-array-area { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 12px; }
.slide-cells { display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-start; }
.slide-cell {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  transition: transform 0.25s cubic-bezier(.34,1.56,.64,1);
}
.slide-cell-box {
  width: 62px; height: 62px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700;
  border: 2.5px solid;
  transition: all 0.25s cubic-bezier(.34,1.56,.64,1);
  position: relative;
}
.slide-cell-idx {
  font-family: 'Space Mono', monospace; font-size: .65rem; color: var(--muted);
}
.slide-cell.active .slide-cell-box { transform: translateY(-8px); }
.slide-cell.bounce .slide-cell-box { animation: cellBounce .4s ease; }
@keyframes cellBounce {
  0%{transform:translateY(0);}
  40%{transform:translateY(-14px);}
  70%{transform:translateY(-5px);}
  100%{transform:translateY(-8px);}
}

/* Swap arrow animation */
.slide-swap-arrow {
  display: flex; align-items: center; justify-content: center; gap: 4px;
  font-family: 'Space Mono', monospace; font-size: .72rem;
  color: var(--accent2); margin-top: 4px;
  animation: fadeIn .3s ease;
}
@keyframes fadeIn { from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;} }

/* Step explanation box */
.slide-explain {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 14px; padding: 18px 20px;
}
.slide-explain-label {
  font-family: 'Space Mono', monospace; font-size: .62rem;
  color: var(--accent); letter-spacing: 2px; font-weight: 700; margin-bottom: 8px;
}
.slide-explain-text {
  font-size: 1rem; line-height: 1.6; color: var(--text);
  font-family: 'Space Mono', monospace; font-size: .82rem;
}

/* Pseudocode highlight */
.slide-pseudocode {
  background: var(--bg); border-radius: 10px; padding: 14px 16px;
  font-family: 'Space Mono', monospace; font-size: .74rem; line-height: 1.9;
  border: 1px solid var(--border); margin-top: 8px;
}
.slide-pseudo-line { display: block; border-radius: 4px; padding: 1px 6px; margin: 0 -6px; color: var(--muted); transition: all .2s; }
.slide-pseudo-line.active { background: rgba(0,245,196,.15); color: var(--accent); font-weight: 700; }

/* Right panel */
.slide-right { padding: 24px 20px; display: flex; flex-direction: column; gap: 20px; background: var(--bg); }

.slide-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.slide-stat-item {
  background: var(--card); border: 1px solid var(--border); border-radius: 10px;
  padding: 12px; text-align: center;
}
.slide-stat-label { font-family: 'Space Mono', monospace; font-size: .62rem; color: var(--muted); margin-bottom: 4px; }
.slide-stat-val { font-family: 'Space Mono', monospace; font-size: 1.4rem; font-weight: 700; color: var(--accent); }

/* Progress timeline */
.slide-timeline { position: relative; }
.slide-timeline-label { font-family: 'Space Mono', monospace; font-size: .65rem; color: var(--muted); margin-bottom: 8px; letter-spacing: 1px; }
.slide-progress-track {
  background: var(--surface); border-radius: 99px; height: 8px;
  border: 1px solid var(--border); overflow: hidden;
}
.slide-progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent4));
  border-radius: 99px; transition: width .3s ease;
}
.slide-progress-markers { display: flex; justify-content: space-between; margin-top: 6px; }
.slide-progress-marker { font-family: 'Space Mono', monospace; font-size: .6rem; color: var(--muted); }

/* Complexity mini card */
.slide-complexity { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; }
.slide-complexity h4 { font-family: 'Space Mono', monospace; font-size: .68rem; color: var(--accent); margin-bottom: 10px; letter-spacing: 1px; }
.slide-cx-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--border); }
.slide-cx-row:last-child { border: none; }
.slide-cx-key { font-family: 'Space Mono', monospace; font-size: .68rem; color: var(--muted); }
.slide-cx-v { font-family: 'Space Mono', monospace; font-size: .75rem; font-weight: 700; }

/* Did You Know */
.slide-tip {
  background: linear-gradient(135deg, rgba(167,139,250,.1), rgba(0,245,196,.06));
  border: 1px solid rgba(167,139,250,.3); border-radius: 12px; padding: 14px 16px;
}
.slide-tip-label { font-family: 'Space Mono', monospace; font-size: .62rem; color: var(--accent4); margin-bottom: 6px; letter-spacing: 1px; font-weight: 700; }
.slide-tip-text { font-family: 'Space Mono', monospace; font-size: .72rem; color: var(--muted); line-height: 1.6; }

/* Footer nav */
.slide-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 28px; border-top: 1px solid var(--border);
  background: var(--card); flex-wrap: wrap; gap: 12px;
}
.slide-nav-btns { display: flex; gap: 8px; align-items: center; }
.slide-nav-btn {
  width: 44px; height: 44px; border-radius: 10px; border: 1.5px solid var(--border);
  background: var(--surface); color: var(--text); cursor: pointer;
  font-size: 1.1rem; transition: all .15s; display: flex; align-items: center; justify-content: center;
}
.slide-nav-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); transform: scale(1.08); }
.slide-nav-btn:disabled { opacity: .3; cursor: not-allowed; }
.slide-play-btn {
  padding: 10px 28px; border-radius: 10px; border: none;
  background: var(--accent); color: var(--bg); cursor: pointer;
  font-family: 'Space Mono', monospace; font-size: .82rem; font-weight: 700;
  transition: all .15s;
}
.slide-play-btn:hover { opacity: .85; transform: translateY(-1px); }
.slide-speed-row { display: flex; align-items: center; gap: 8px; font-family: 'Space Mono', monospace; font-size: .72rem; color: var(--muted); }
.slide-speed-row input { accent-color: var(--accent); width: 90px; }

/* ===== VOICE SECTION ===== */
.voice-bar {
  display:flex; align-items:center; gap:10px; padding:12px 28px;
  border-bottom:1px solid var(--border); background:var(--bg);
  flex-wrap:wrap;
}
.voice-bar-label { font-family:'Space Mono',monospace; font-size:.68rem; color:var(--muted); letter-spacing:1px; }
.lang-btn {
  padding:6px 16px; border-radius:99px; border:1.5px solid var(--border);
  background:transparent; color:var(--muted); cursor:pointer;
  font-family:'Space Mono',monospace; font-size:.72rem; transition:all .2s;
}
.lang-btn.active { background:var(--accent4); color:#fff; border-color:var(--accent4); font-weight:700; }
.lang-btn:hover:not(.active) { border-color:var(--accent4); color:var(--accent4); }
.speak-btn {
  padding:7px 18px; border-radius:8px; border:none;
  background:var(--card); color:var(--text); cursor:pointer;
  font-family:'Space Mono',monospace; font-size:.75rem; font-weight:700;
  border:1.5px solid var(--border); transition:all .2s; display:flex; align-items:center; gap:6px;
}
.speak-btn:hover { border-color:var(--accent4); color:var(--accent4); }
.speak-btn.speaking { border-color:var(--accent4); color:var(--accent4); background:rgba(167,139,250,.1); }
.speak-btn .wave { display:inline-flex; gap:2px; align-items:flex-end; height:14px; }
.speak-btn .wave span {
  width:3px; background:var(--accent4); border-radius:2px;
  animation:waveAnim 0.6s ease-in-out infinite alternate;
}
.speak-btn .wave span:nth-child(2){animation-delay:.1s;}
.speak-btn .wave span:nth-child(3){animation-delay:.2s;}
.speak-btn .wave span:nth-child(4){animation-delay:.15s;}
@keyframes waveAnim{from{height:3px;}to{height:14px;}}
.voice-text-bubble {
  background:var(--card); border:1px solid rgba(167,139,250,.35);
  border-radius:12px; padding:12px 18px; margin:0 28px 0;
  font-family:'Space Mono',monospace; font-size:.78rem; line-height:1.6;
  color:var(--text); display:none; position:relative;
}
.voice-text-bubble::before {
  content:'üîä'; position:absolute; top:-12px; left:16px;
  background:var(--bg); padding:0 4px; font-size:.8rem;
}
.voice-lang-tag {
  position:absolute; top:-10px; right:16px;
  background:var(--accent4); color:#fff;
  font-size:.6rem; padding:2px 8px; border-radius:99px;
  font-family:'Space Mono',monospace; font-weight:700;
}
/* Save image btn */
.save-img-btn {
  padding:7px 16px; border-radius:8px; border:1.5px solid var(--border);
  background:var(--card); color:var(--text); cursor:pointer;
  font-family:'Space Mono',monospace; font-size:.72rem; font-weight:700;
  transition:all .2s;
}
.save-img-btn:hover { border-color:var(--accent3); color:var(--accent3); }
.save-all-btn {
  padding:7px 16px; border-radius:8px; border:none;
  background:var(--accent3); color:var(--bg); cursor:pointer;
  font-family:'Space Mono',monospace; font-size:.72rem; font-weight:700;
  transition:all .2s;
}
.save-all-btn:hover { opacity:.85; }

/* ===== DATA STRUCTURES & PROGRAMS ===== */
.ds-main,.prog-main{max-width:1100px;margin:0 auto;padding:28px 24px 48px;}
.ds-hero{text-align:center;margin-bottom:28px;}
.ds-hero h2{font-size:clamp(1.6rem,4vw,2.5rem);font-weight:800;letter-spacing:-1px;margin-bottom:6px;}
.ds-hero h2 em{color:var(--accent);font-style:normal;}
.ds-hero p{color:var(--muted);font-size:.9rem;}
.ds-category-tabs,.prog-cats{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:18px;}
.ds-cat-btn{padding:9px 20px;border-radius:99px;border:1.5px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Space Mono',monospace;font-size:.75rem;transition:all .2s;}
.ds-cat-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.ds-cat-btn.active{background:var(--accent2);color:#fff;border-color:var(--accent2);font-weight:700;}
.ds-subtype-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:14px;min-height:36px;}
.ds-sub-btn{padding:6px 16px;border-radius:99px;border:1.5px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Space Mono',monospace;font-size:.72rem;transition:all .2s;}
.ds-sub-btn:hover{border-color:var(--accent3);color:var(--accent3);}
.ds-sub-btn.active{background:var(--accent3);color:var(--bg);border-color:var(--accent3);font-weight:700;}
.ds-ops-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:16px;}
.ds-op-btn{padding:8px 18px;border-radius:8px;border:1.5px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-family:'Space Mono',monospace;font-size:.75rem;transition:all .2s;}
.ds-op-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,245,196,.06);}
.ds-op-btn.active{background:rgba(0,245,196,.12);border-color:var(--accent);color:var(--accent);font-weight:700;}
.ds-input-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:16px;}
.ds-viz-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px;}
#ds-canvas{height:260px;}
.ds-step-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;margin-bottom:20px;font-family:'Space Mono',monospace;font-size:.8rem;line-height:1.6;position:relative;overflow:hidden;}
.ds-step-box::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent2);}
.ds-step-label{color:var(--accent2);font-weight:700;font-size:.62rem;letter-spacing:2px;margin-bottom:5px;}
.ds-panels{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
@media(max-width:700px){.ds-panels{grid-template-columns:1fr;}}
.ds-info-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 20px;}
.ds-info-card h3{font-size:.9rem;color:var(--accent2);margin-bottom:10px;}
.prog-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:20px;}
.prog-card{background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;cursor:pointer;transition:all .2s;text-align:center;}
.prog-card:hover{border-color:var(--accent4);transform:translateY(-2px);box-shadow:0 4px 20px rgba(167,139,250,.15);}
.prog-card.active{border-color:var(--accent4);background:rgba(167,139,250,.1);}
.prog-card-icon{font-size:1.6rem;margin-bottom:6px;}
.prog-card-name{font-family:'Space Mono',monospace;font-size:.75rem;font-weight:700;color:var(--text);}
.prog-card-desc{font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);margin-top:3px;}
.search-result-item{padding:12px 18px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:12px;transition:background .15s;}
.search-result-item:hover{background:var(--surface);}
.search-result-item:last-child{border:none;}
.sr-icon{font-size:1.1rem;}.sr-name{font-family:'Space Mono',monospace;font-size:.8rem;font-weight:700;color:var(--text);}
.sr-cat{font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);}
.sr-badge{padding:2px 8px;border-radius:99px;font-family:'Space Mono',monospace;font-size:.6rem;font-weight:700;margin-left:auto;}
</style>
</head>
<body>
<header>
  <div>
    <div class="logo">Algo<span>Viz</span><sup>v2</sup></div>
    <div class="tagline">// see your algorithms think</div>
  </div>
</header>

<!-- GLOBAL SEARCH BAR -->
<div id="global-search-bar" style="background:var(--surface);border-bottom:1px solid var(--border);padding:10px 32px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;">
  <span style="font-size:1rem;">üîç</span>
  <input type="text" id="global-search" placeholder="Search algorithms, data structures, programs... (e.g. 'stack push', 'prime', 'linked list')"
    style="flex:1;background:var(--card);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 16px;font-family:'Space Mono',monospace;font-size:.8rem;outline:none;transition:border .2s;"
    oninput="globalSearch(this.value)" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
  <button onclick="clearSearch()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;padding:4px;">‚úï</button>
  <div id="search-results-dropdown" style="display:none;position:absolute;top:52px;left:32px;right:32px;background:var(--card);border:1px solid var(--border);border-radius:12px;max-height:320px;overflow-y:auto;z-index:200;box-shadow:0 8px 40px rgba(0,0,0,.5);"></div>
</div>

<div class="nav-tabs">
  <button class="nav-tab active" onclick="showPage('single',this)">‚ö° Visualizer</button>
  <button class="nav-tab" onclick="showPage('slide',this)">üéì Slide View</button>
  <button class="nav-tab" onclick="showPage('ds',this)">üóÇ Data Structures</button>
  <button class="nav-tab" onclick="showPage('programs',this)">üí° Programs</button>
  <button class="nav-tab" onclick="showPage('paste',this)">üìã Paste Code</button>
  <button class="nav-tab" onclick="showPage('compare',this)">‚öñÔ∏è Compare</button>
</div>

<!-- ========== PAGE: SINGLE ========== -->
<div class="page active" id="page-single">
<div class="main">
  <div class="algo-tabs" id="single-algo-tabs">
    <button class="algo-tab active" onclick="selectAlgo('selection',this)">Selection</button>
    <button class="algo-tab" onclick="selectAlgo('bubble',this)">Bubble</button>
    <button class="algo-tab" onclick="selectAlgo('insertion',this)">Insertion</button>
    <button class="algo-tab" onclick="selectAlgo('merge',this)">Merge</button>
    <button class="algo-tab" onclick="selectAlgo('quick',this)">Quick</button>
    <button class="algo-tab" onclick="selectAlgo('heap',this)">Heap</button>
    <button class="algo-tab" onclick="selectAlgo('shell',this)">Shell</button>
    <button class="algo-tab" onclick="selectAlgo('counting',this)">Counting</button>
    <button class="algo-tab" onclick="selectAlgo('radix',this)">Radix</button>
    <button class="algo-tab" onclick="selectAlgo('tim',this)">Tim</button>
    <button class="algo-tab" onclick="selectAlgo('cycle',this)">Cycle</button>
    <button class="algo-tab" onclick="selectAlgo('binary',this)">Binary Search</button>
    <button class="algo-tab" onclick="selectAlgo('linear',this)">Linear Search</button>
    <button class="algo-tab" onclick="selectAlgo('jump',this)">Jump Search</button>
    <button class="algo-tab" onclick="selectAlgo('interpolation',this)">Interpolation</button>
  </div>

  <!-- ====== QUICK RECAP CARD ====== -->
  <div id="algo-recap-card" style="background:linear-gradient(135deg,rgba(167,139,250,.08),rgba(0,245,196,.05));border:1px solid rgba(167,139,250,.25);border-radius:18px;padding:20px 24px;margin-bottom:22px;position:relative;overflow:hidden;">
    <div style="position:absolute;top:0;right:0;width:140px;height:140px;background:radial-gradient(circle,rgba(167,139,250,.12),transparent 70%);pointer-events:none;"></div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
      <span style="font-family:'Space Mono',monospace;font-size:.62rem;color:var(--accent4);letter-spacing:2px;font-weight:700;">üìñ QUICK RECAP</span>
      <span id="recap-algo-badge" style="padding:3px 12px;border-radius:99px;background:rgba(167,139,250,.2);border:1px solid rgba(167,139,250,.4);font-family:'Space Mono',monospace;font-size:.68rem;color:var(--accent4);font-weight:700;">Selection Sort</span>
      <!-- Voice bar for recap -->
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
        <button class="lang-btn active" id="viz-lang-en" onclick="vizSetLang('en')" style="font-size:.65rem;padding:4px 10px;">üá¨üáß EN</button>
        <button class="lang-btn" id="viz-lang-hi" onclick="vizSetLang('hi')" style="font-size:.65rem;padding:4px 10px;">üáÆüá≥ HI</button>
        <button class="speak-btn" onclick="vizSpeakRecap()" style="font-size:.68rem;padding:5px 12px;">üîä Speak</button>
        <button class="speak-btn" onclick="if(synth)synth.cancel()" style="font-size:.68rem;padding:5px 12px;border-color:var(--accent2);color:var(--accent2);">‚èπ</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div>
        <div style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent4);letter-spacing:1px;margin-bottom:6px;">üìå DEFINITION</div>
        <div id="recap-definition" style="font-family:'Space Mono',monospace;font-size:.78rem;color:var(--text);line-height:1.7;"></div>
      </div>
      <div>
        <div style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent4);letter-spacing:1px;margin-bottom:6px;">‚öôÔ∏è HOW IT WORKS</div>
        <div id="recap-how" style="font-family:'Space Mono',monospace;font-size:.78rem;color:var(--muted);line-height:1.7;"></div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;" id="recap-tags"></div>
  </div>

  <!-- ====== USER ARRAY INPUT ====== -->
  <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 20px;margin-bottom:18px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <span style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent3);letter-spacing:2px;font-weight:700;">üéØ YOUR ARRAY</span>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-secondary" onclick="vizGenRandom()" style="font-size:.68rem;padding:5px 10px;">‚ö° Random</button>
        <button class="btn btn-secondary" onclick="vizGenSorted()" style="font-size:.68rem;padding:5px 10px;">‚Üë Sorted</button>
        <button class="btn btn-secondary" onclick="vizGenReversed()" style="font-size:.68rem;padding:5px 10px;">‚Üì Reversed</button>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
      <div style="flex:1;min-width:200px;">
        <label style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);display:block;margin-bottom:4px;">VALUES (comma-separated integers)</label>
        <input type="text" id="viz-array-input" placeholder="e.g. 64, 25, 12, 22, 11"
          style="width:100%;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;font-family:'Space Mono',monospace;font-size:.82rem;outline:none;"
          onfocus="this.style.borderColor='var(--accent3)'" onblur="this.style.borderColor='var(--border)'" oninput="vizParseArray()">
        <div id="viz-array-err" style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent2);margin-top:4px;display:none;"></div>
      </div>
      <div id="viz-search-target-wrap" style="display:none;min-width:130px;">
        <label style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);display:block;margin-bottom:4px;">SEARCH TARGET</label>
        <input type="number" id="viz-search-target"
          style="width:100%;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;font-family:'Space Mono',monospace;font-size:.82rem;outline:none;"
          onfocus="this.style.borderColor='var(--accent3)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <button class="btn btn-primary" onclick="vizApplyArray()" style="padding:8px 18px;">‚úì Apply</button>
    </div>
    <div id="viz-array-preview" style="margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;"></div>
  </div>

  <div class="viz-container">
    <div class="viz-toolbar">
      <button class="btn btn-primary" id="playBtn" onclick="playPause()">‚ñ∂ Play</button>
      <button class="btn btn-secondary" onclick="resetViz()">‚Ü∫ Reset</button>
      <button class="btn btn-secondary" onclick="stepForward()">Step ‚Üí</button>
      <button class="btn btn-secondary" onclick="randomize()">‚ö° Random</button>
      <button class="btn" onclick="openInSlideView()" style="background:rgba(167,139,250,.18);border:1.5px solid rgba(167,139,250,.5);color:#a78bfa;font-family:'Space Mono',monospace;font-size:.72rem;padding:7px 13px;border-radius:8px;cursor:pointer;" title="Send this array + algorithm to Slide View">üéì Open in Slide View</button>
      <div style="display:flex;align-items:center;gap:6px;">
        <label>Speed</label>
        <input type="range" id="speedSlider" min="1" max="10" value="5" oninput="updateSpeed()">
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <label>Size</label>
        <input type="range" id="sizeSlider" min="6" max="30" value="14" oninput="changeSize()">
      </div>
    </div>
    <canvas id="viz-canvas"></canvas>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#00f5c4"></div>Sorted/Found</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ff6b6b"></div>Comparing</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ffd93d"></div>Min/Pivot/Target</div>
      <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div>Range</div>
      <div class="legend-item"><div class="legend-dot" style="background:#3a3a6e"></div>Unsorted</div>
    </div>
    <div class="stats-bar">
      <div class="stat">Comparisons: <span id="cmpCount">0</span></div>
      <div class="stat">Swaps: <span id="swapCount">0</span></div>
      <div class="stat">Step: <span id="stepCount">0</span>/<span id="totalSteps">0</span></div>
      <div class="stat">Status: <span id="statusText">Ready</span></div>
    </div>
  </div>

  <div class="step-box">
    <div class="step-label">CURRENT STEP</div>
    <div id="step-text">Press Play or Step ‚Üí to begin.</div>
  </div>

  <div class="panels">
    <div class="code-panel">
      <div class="code-header" style="flex-wrap:wrap;gap:8px;">
        <div style="display:flex;align-items:center;gap:5px;">
          <div class="dot" style="background:#ff6b6b"></div>
          <div class="dot" style="background:#ffd93d"></div>
          <div class="dot" style="background:#00f5c4"></div>
          <span style="margin-left:8px" id="code-title">selection_sort.py</span>
        </div>
        <!-- Language selector -->
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-left:auto;" id="viz-lang-tabs">
          <button class="algo-tab active" style="padding:4px 10px;font-size:.65rem;" onclick="vizCodeLang('python',this)">üêç Python</button>
          <button class="algo-tab" style="padding:4px 10px;font-size:.65rem;" onclick="vizCodeLang('cpp',this)">‚ö° C++</button>
          <button class="algo-tab" style="padding:4px 10px;font-size:.65rem;" onclick="vizCodeLang('c',this)">üîß C</button>
          <button class="algo-tab" style="padding:4px 10px;font-size:.65rem;" onclick="vizCodeLang('java',this)">‚òï Java</button>
          <button class="algo-tab" style="padding:4px 10px;font-size:.65rem;" onclick="vizCodeLang('javascript',this)">üåê JS</button>
        </div>
      </div>
      <pre id="code-display"></pre>
    </div>
    <div class="cx-card">
      <h3 id="cx-title">Selection Sort</h3>
      <div class="cx-grid">
        <div class="cx-item"><div class="cx-label">BEST</div><div class="cx-val bad" id="cx-best">O(n¬≤)</div></div>
        <div class="cx-item"><div class="cx-label">AVERAGE</div><div class="cx-val bad" id="cx-avg">O(n¬≤)</div></div>
        <div class="cx-item"><div class="cx-label">WORST</div><div class="cx-val bad" id="cx-worst">O(n¬≤)</div></div>
        <div class="cx-item"><div class="cx-label">SPACE</div><div class="cx-val good" id="cx-space">O(1)</div></div>
        <div class="cx-item"><div class="cx-label">STABLE</div><div class="cx-val ok" id="cx-stable">No</div></div>
        <div class="cx-item"><div class="cx-label">IN-PLACE</div><div class="cx-val good" id="cx-inplace">Yes</div></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ========== PAGE: SLIDE VIEW ========== -->
<div class="page" id="page-slide">
<div class="slide-page">

  <!-- Algo selector -->
  <div class="slide-algo-row" id="slide-algo-tabs">
    <button class="algo-tab active" onclick="slideSelectAlgo('selection',this)">Selection</button>
    <button class="algo-tab" onclick="slideSelectAlgo('bubble',this)">Bubble</button>
    <button class="algo-tab" onclick="slideSelectAlgo('insertion',this)">Insertion</button>
    <button class="algo-tab" onclick="slideSelectAlgo('merge',this)">Merge</button>
    <button class="algo-tab" onclick="slideSelectAlgo('quick',this)">Quick</button>
    <button class="algo-tab" onclick="slideSelectAlgo('heap',this)">Heap</button>
    <button class="algo-tab" onclick="slideSelectAlgo('shell',this)">Shell</button>
    <button class="algo-tab" onclick="slideSelectAlgo('counting',this)">Counting</button>
    <button class="algo-tab" onclick="slideSelectAlgo('radix',this)">Radix</button>
    <button class="algo-tab" onclick="slideSelectAlgo('tim',this)">Tim</button>
    <button class="algo-tab" onclick="slideSelectAlgo('binary',this)">Binary Search</button>
    <button class="algo-tab" onclick="slideSelectAlgo('linear',this)">Linear Search</button>
    <button class="algo-tab" onclick="slideSelectAlgo('jump',this)">Jump Search</button>
    <button class="algo-tab" onclick="slideSelectAlgo('interpolation',this)">Interpolation</button>
  </div>

  <!-- Sync banner ‚Äî shown when array is synced from Visualizer -->
  <div id="slide-sync-banner" style="display:none;background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.35);border-radius:12px;padding:10px 18px;margin-bottom:14px;display:none;align-items:center;gap:12px;flex-wrap:wrap;">
    <span style="font-size:1rem;">üîó</span>
    <span style="font-family:'Space Mono',monospace;font-size:.75rem;color:#a78bfa;font-weight:700;">SYNCED FROM VISUALIZER</span>
    <span id="slide-sync-info" style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);"></span>
    <button onclick="slideRandomize()" style="margin-left:auto;background:none;border:1px solid rgba(167,139,250,.4);color:#a78bfa;font-family:'Space Mono',monospace;font-size:.68rem;padding:4px 12px;border-radius:6px;cursor:pointer;">‚ö° Use New Random Array</button>
  </div>

  <!-- SLIDE DECK -->
  <div class="slide-deck">

    <!-- Header -->
    <div class="slide-header">
      <div class="slide-algo-name" id="sl-algo-name">Selection <span>Sort</span></div>
      <span class="slide-phase-badge" id="sl-phase-badge" style="background:rgba(0,245,196,.15);color:var(--accent);border:1px solid rgba(0,245,196,.3);">COMPARING</span>
      <div class="slide-counter" id="sl-counter">Slide 1 of 1</div>
    </div>

    <!-- Voice Bar -->
    <div class="voice-bar">
      <span class="voice-bar-label">üéô VOICE</span>
      <button class="lang-btn active" id="lang-en" onclick="setLang('en')">üá¨üáß English</button>
      <button class="lang-btn" id="lang-hi" onclick="setLang('hi')">üáÆüá≥ Hindi</button>
      <button class="speak-btn" id="speak-btn" onclick="speakCurrent()">
        <span id="speak-icon">üîä</span> <span id="speak-label">Speak Step</span>
      </button>
      <label style="display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.7rem;color:var(--muted);cursor:pointer;">
        <input type="checkbox" id="auto-speak" style="accent-color:var(--accent4);"> Auto-speak
      </label>
      <button class="speak-btn" onclick="stopSpeaking()" style="border-color:var(--accent2);color:var(--accent2);">‚èπ Stop</button>
    </div>
    <!-- Voice bubble -->
    <div class="voice-text-bubble" id="voice-bubble">
      <div class="voice-lang-tag" id="voice-lang-tag">EN</div>
      <div id="voice-bubble-text"></div>
    </div>

    <!-- Body -->
    <div class="slide-body">

      <!-- LEFT: visual + explanation -->
      <div class="slide-left">
        <!-- Big step title -->
        <div class="slide-title-line" id="sl-title">Press Play to start the lesson</div>

        <!-- Array cells -->
        <div class="slide-array-area">
          <div class="slide-cells" id="sl-cells"></div>
          <div id="sl-swap-arrow" class="slide-swap-arrow" style="display:none;"></div>
        </div>

        <!-- Explanation -->
        <div class="slide-explain">
          <div class="slide-explain-label">WHAT IS HAPPENING</div>
          <div class="slide-explain-text" id="sl-explain">Ready to start. Choose an algorithm above and press Play or use arrow keys.</div>
        </div>

        <!-- Pseudocode -->
        <div class="slide-pseudocode" id="sl-pseudocode"></div>
      </div>

      <!-- RIGHT: stats + info -->
      <div class="slide-right">

        <!-- Stats -->
        <div class="slide-stat-grid">
          <div class="slide-stat-item">
            <div class="slide-stat-label">COMPARISONS</div>
            <div class="slide-stat-val" id="sl-cmps">0</div>
          </div>
          <div class="slide-stat-item">
            <div class="slide-stat-label">SWAPS</div>
            <div class="slide-stat-val" id="sl-swps">0</div>
          </div>
          <div class="slide-stat-item">
            <div class="slide-stat-label">STEP</div>
            <div class="slide-stat-val" id="sl-step-num">0</div>
          </div>
          <div class="slide-stat-item">
            <div class="slide-stat-label">SORTED</div>
            <div class="slide-stat-val" id="sl-sorted-pct">0%</div>
          </div>
        </div>

        <!-- Progress -->
        <div class="slide-timeline">
          <div class="slide-timeline-label">PROGRESS</div>
          <div class="slide-progress-track">
            <div class="slide-progress-fill" id="sl-progress" style="width:0%"></div>
          </div>
          <div class="slide-progress-markers">
            <span class="slide-progress-marker">Start</span>
            <span class="slide-progress-marker">25%</span>
            <span class="slide-progress-marker">50%</span>
            <span class="slide-progress-marker">75%</span>
            <span class="slide-progress-marker">Done</span>
          </div>
        </div>

        <!-- Complexity -->
        <div class="slide-complexity">
          <h4>‚è± COMPLEXITY</h4>
          <div class="slide-cx-row"><span class="slide-cx-key">Best Case</span><span class="slide-cx-v" id="sl-cx-best">‚Äî</span></div>
          <div class="slide-cx-row"><span class="slide-cx-key">Average</span><span class="slide-cx-v" id="sl-cx-avg">‚Äî</span></div>
          <div class="slide-cx-row"><span class="slide-cx-key">Worst Case</span><span class="slide-cx-v" id="sl-cx-worst">‚Äî</span></div>
          <div class="slide-cx-row"><span class="slide-cx-key">Space</span><span class="slide-cx-v" id="sl-cx-space">‚Äî</span></div>
          <div class="slide-cx-row"><span class="slide-cx-key">Stable</span><span class="slide-cx-v" id="sl-cx-stable">‚Äî</span></div>
        </div>

        <!-- Tip -->
        <div class="slide-tip">
          <div class="slide-tip-label">üí° DID YOU KNOW</div>
          <div class="slide-tip-text" id="sl-tip">Select an algorithm to see a fun fact!</div>
        </div>
      </div>
    </div>

    <!-- Footer nav -->
    <div class="slide-footer">
      <div class="slide-nav-btns">
        <button class="slide-nav-btn" id="sl-first-btn" onclick="slideGo(0)" title="First">‚èÆ</button>
        <button class="slide-nav-btn" id="sl-prev-btn" onclick="slidePrev()" title="Previous (‚Üê)">‚óÄ</button>
        <button class="slide-play-btn" id="sl-play-btn" onclick="slidePlayPause()">‚ñ∂ Play</button>
        <button class="slide-nav-btn" id="sl-next-btn" onclick="slideNext()" title="Next (‚Üí)">‚ñ∂</button>
        <button class="slide-nav-btn" id="sl-last-btn" onclick="slideGoLast()" title="Last">‚è≠</button>
      </div>
      <div class="slide-speed-row">
        <span>Speed</span>
        <input type="range" id="sl-speed" min="1" max="8" value="3">
        <span id="sl-speed-label">Medium</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="btn btn-secondary" onclick="slideRandomize()" style="font-size:.72rem;padding:7px 14px;">‚ö° New Array</button>
        <button class="btn" onclick="goBackToVisualizer()" style="background:rgba(0,245,196,.1);border:1.5px solid rgba(0,245,196,.3);color:var(--accent);font-family:'Space Mono',monospace;font-size:.72rem;padding:7px 14px;border-radius:8px;cursor:pointer;">‚ö° Back to Visualizer</button>
        <button class="save-img-btn" onclick="saveSlideImage()">üì∏ Save Slide</button>
        <button class="save-all-btn" onclick="saveAllSlides()">üíæ Export All Slides</button>
        <div class="slide-kbd-hint"><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> navigate &nbsp; <kbd>Space</kbd> play/pause</div>
      </div>
    </div>

  </div>
</div>
</div>

<!-- ========== PAGE: DATA STRUCTURES ========== -->
<div class="page" id="page-ds">
<div class="ds-main">

  <div class="ds-hero">
    <h2>Data Structure <em>Visualizer</em></h2>
    <p>Pick a structure and operation ‚Äî watch it animate step by step</p>
  </div>

  <!-- Category tabs -->
  <div class="ds-category-tabs">
    <button class="ds-cat-btn active" onclick="dsSelectCategory('array',this)">üì¶ Array</button>
    <button class="ds-cat-btn" onclick="dsSelectCategory('linkedlist',this)">üîó Linked List</button>
    <button class="ds-cat-btn" onclick="dsSelectCategory('stack',this)">üìö Stack</button>
    <button class="ds-cat-btn" onclick="dsSelectCategory('queue',this)">üö∂ Queue</button>
  </div>

  <!-- Sub-type tabs -->
  <div class="ds-subtype-row" id="ds-subtype-row"></div>

  <!-- Operation buttons -->
  <div class="ds-ops-row" id="ds-ops-row"></div>

  <!-- Input row -->
  <div class="ds-input-row" id="ds-input-row" style="display:none;">
    <input type="number" id="ds-val-input" placeholder="Enter value" style="width:130px;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 14px;font-family:'Space Mono',monospace;font-size:.85rem;outline:none;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
    <input type="number" id="ds-pos-input" placeholder="Position (opt.)" style="width:160px;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 14px;font-family:'Space Mono',monospace;font-size:.85rem;outline:none;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
    <button class="btn btn-primary" onclick="dsExecuteOp()">‚ñ∂ Execute</button>
    <button class="btn btn-secondary" onclick="dsReset()">‚Ü∫ Reset</button>
  </div>

  <!-- Visualization canvas area -->
  <div class="ds-viz-box" id="ds-viz-box">
    <canvas id="ds-canvas" style="display:block;width:100%;background:var(--bg);"></canvas>
  </div>

  <!-- Step log -->
  <div class="ds-step-box">
    <div class="ds-step-label">OPERATION LOG</div>
    <div id="ds-step-text">Select a data structure and operation above to begin.</div>
  </div>

  <!-- Info + code panels -->
  <div class="ds-panels">
    <div class="ds-info-card" id="ds-info-card">
      <h3 id="ds-info-title">Array</h3>
      <div id="ds-info-body" style="font-family:'Space Mono',monospace;font-size:.78rem;color:var(--muted);line-height:1.8;"></div>
    </div>
    <div class="code-panel" style="flex:1;">
      <div class="code-header">
        <div class="dot" style="background:#ff6b6b"></div>
        <div class="dot" style="background:#ffd93d"></div>
        <div class="dot" style="background:#00f5c4"></div>
        <span style="margin-left:8px" id="ds-code-title">array.py</span>
      </div>
      <pre id="ds-code-display" style="font-size:.72rem;"></pre>
    </div>
  </div>

  <!-- INTERVIEW QUESTIONS SECTION -->
  <div style="margin-top:32px;">
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px;flex-wrap:wrap;">
      <div style="font-size:1.4rem;font-weight:800;letter-spacing:-0.5px;">üéØ Interview <em style="color:var(--accent4);font-style:normal;">Questions</em></div>
      <span style="font-family:'Space Mono',monospace;font-size:.65rem;background:rgba(167,139,250,.15);color:var(--accent4);border:1px solid rgba(167,139,250,.3);padding:3px 10px;border-radius:99px;">400+ Questions</span>
      <div style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;">
        <button class="ds-sub-btn active" onclick="iqFilter('all',this)" id="iq-all">All</button>
        <button class="ds-sub-btn" onclick="iqFilter('easy',this)" style="border-color:#00f5c4;color:#00f5c4;" id="iq-easy">üü¢ Easy</button>
        <button class="ds-sub-btn" onclick="iqFilter('medium',this)" style="border-color:#ffd93d;color:#ffd93d;" id="iq-med">üü° Medium</button>
        <button class="ds-sub-btn" onclick="iqFilter('hard',this)" style="border-color:#ff6b6b;color:#ff6b6b;" id="iq-hard">üî¥ Hard</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;" id="iq-cat-row">
      <button class="ds-op-btn active" onclick="iqCat('array',this)">üì¶ Array</button>
      <button class="ds-op-btn" onclick="iqCat('linkedlist',this)">üîó Linked List</button>
      <button class="ds-op-btn" onclick="iqCat('stack',this)">üìö Stack</button>
      <button class="ds-op-btn" onclick="iqCat('queue',this)">üö∂ Queue</button>
      <button class="ds-op-btn" onclick="iqCat('tree',this)">üå≥ Tree</button>
      <button class="ds-op-btn" onclick="iqCat('graph',this)">üï∏ Graph</button>
      <button class="ds-op-btn" onclick="iqCat('hash',this)">üóù Hashing</button>
      <button class="ds-op-btn" onclick="iqCat('heap',this)">‚õ∞ Heap</button>
    </div>
    <!-- Search -->
    <div style="position:relative;margin-bottom:14px;">
      <input type="text" id="iq-search" placeholder="üîé Search questions... (e.g. 'two sum', 'reverse', 'cycle')"
        style="width:100%;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:10px;padding:10px 16px;font-family:'Space Mono',monospace;font-size:.8rem;outline:none;"
        oninput="iqSearch(this.value)" onfocus="this.style.borderColor='var(--accent4)'" onblur="this.style.borderColor='var(--border)'">
    </div>
    <div style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);margin-bottom:10px;" id="iq-count-label"></div>
    <div id="iq-list" style="display:flex;flex-direction:column;gap:8px;"></div>
    <div style="text-align:center;margin-top:16px;">
      <button class="btn btn-secondary" id="iq-load-more" onclick="iqLoadMore()" style="display:none;">Load More Questions</button>
    </div>
  </div>

</div>
</div>

<!-- ========== IQ QUESTION VISUALIZATION MODAL ========== -->
<div id="iq-viz-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:999;overflow-y:auto;padding:20px;">
  <div style="max-width:920px;margin:0 auto;background:var(--card);border:1.5px solid var(--border);border-radius:20px;overflow:hidden;">
    <!-- Modal Header -->
    <div style="padding:18px 24px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;">
      <div style="flex:1;">
        <div id="iqv-badge" style="display:inline-block;font-family:'Space Mono',monospace;font-size:.6rem;padding:2px 10px;border-radius:99px;margin-bottom:6px;"></div>
        <div id="iqv-title" style="font-size:1.05rem;font-weight:800;color:var(--text);line-height:1.4;"></div>
        <div id="iqv-companies" style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);margin-top:4px;"></div>
      </div>
      <button onclick="closeIqViz()" style="background:rgba(255,107,107,.15);border:1px solid rgba(255,107,107,.4);color:#ff6b6b;font-family:'Space Mono',monospace;font-size:.75rem;padding:7px 14px;border-radius:8px;cursor:pointer;white-space:nowrap;">‚úï Close</button>
    </div>

    <!-- Controls bar -->
    <div style="padding:12px 24px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <button id="iqv-play-btn" onclick="iqvPlayPause()" style="background:var(--accent);color:var(--bg);font-family:'Space Mono',monospace;font-size:.75rem;font-weight:700;padding:8px 18px;border:none;border-radius:8px;cursor:pointer;">‚ñ∂ Play</button>
      <button onclick="iqvReset()" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-family:'Space Mono',monospace;font-size:.75rem;padding:8px 14px;border-radius:8px;cursor:pointer;">‚Ü∫ Reset</button>
      <button onclick="iqvStepForward()" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-family:'Space Mono',monospace;font-size:.75rem;padding:8px 14px;border-radius:8px;cursor:pointer;">Step ‚Üí</button>
      <label style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);">Speed</label>
      <input type="range" id="iqv-speed" min="1" max="8" value="4" style="accent-color:var(--accent);width:80px;">
      <div style="margin-left:auto;display:flex;gap:16px;">
        <div style="text-align:center;"><div style="font-family:'Space Mono',monospace;font-size:.6rem;color:var(--muted);">STEP</div><div id="iqv-step-num" style="font-family:'Space Mono',monospace;font-size:.9rem;font-weight:700;color:var(--accent);">0</div></div>
        <div style="text-align:center;"><div style="font-family:'Space Mono',monospace;font-size:.6rem;color:var(--muted);">TOTAL</div><div id="iqv-total-steps" style="font-family:'Space Mono',monospace;font-size:.9rem;font-weight:700;color:var(--muted);">0</div></div>
      </div>
    </div>

    <!-- Canvas area -->
    <div style="padding:16px 24px 8px;">
      <canvas id="iqv-canvas" style="width:100%;height:160px;display:block;background:var(--bg);border-radius:12px;"></canvas>
    </div>

    <!-- Step message -->
    <div style="padding:8px 24px 4px;">
      <div id="iqv-step-msg" style="font-family:'Space Mono',monospace;font-size:.78rem;color:var(--accent);min-height:28px;padding:8px 14px;background:rgba(0,245,196,.06);border-radius:8px;border-left:3px solid var(--accent);">Press Play to start visualization</div>
    </div>

    <!-- Progress bar -->
    <div style="padding:4px 24px 12px;">
      <div style="height:4px;background:var(--surface);border-radius:99px;overflow:hidden;">
        <div id="iqv-progress" style="height:100%;background:var(--accent);border-radius:99px;width:0%;transition:width .2s;"></div>
      </div>
    </div>

    <!-- Body: Code + Approach -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid var(--border);">
      <!-- Code panel -->
      <div style="border-right:1px solid var(--border);padding:0;">
        <div style="padding:10px 18px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
          <div class="dot" style="background:#ff6b6b;width:10px;height:10px;border-radius:50%;"></div>
          <div class="dot" style="background:#ffd93d;width:10px;height:10px;border-radius:50%;"></div>
          <div class="dot" style="background:#00f5c4;width:10px;height:10px;border-radius:50%;"></div>
          <span id="iqv-code-title" style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);margin-left:6px;">solution.py</span>
        </div>
        <pre id="iqv-code" style="padding:16px 18px;font-family:'Space Mono',monospace;font-size:.7rem;color:#b0b0cc;line-height:1.7;overflow-x:auto;max-height:260px;overflow-y:auto;white-space:pre-wrap;"></pre>
      </div>

      <!-- Approach panel -->
      <div style="padding:16px 18px;">
        <div style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent4);font-weight:700;margin-bottom:8px;">üí° APPROACH</div>
        <div id="iqv-approach" style="font-family:'Space Mono',monospace;font-size:.73rem;color:var(--text);line-height:1.7;"></div>
        <div style="margin-top:14px;font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent4);font-weight:700;">üìà COMPLEXITY</div>
        <div id="iqv-complexity" style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);margin-top:5px;line-height:1.7;"></div>
        <div style="margin-top:14px;font-family:'Space Mono',monospace;font-size:.65rem;color:var(--accent4);font-weight:700;">üí° HINT</div>
        <div id="iqv-hint" style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--text);margin-top:5px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== PAGE: PROGRAMS ========== -->
<div class="page" id="page-programs">
<div class="prog-main">

  <div class="ds-hero">
    <h2>Common Programs <em>Visualizer</em></h2>
    <p>See classic programs run step by step with full explanation</p>
  </div>

  <!-- Program categories -->
  <div class="prog-cats">
    <button class="ds-cat-btn active" onclick="progSelectCat('number',this)">üî¢ Number Programs</button>
    <button class="ds-cat-btn" onclick="progSelectCat('pattern',this)">‚≠ê Patterns</button>
    <button class="ds-cat-btn" onclick="progSelectCat('math',this)">‚ûï Math Programs</button>
    <button class="ds-cat-btn" onclick="progSelectCat('string',this)">üî§ String Programs</button>
  </div>

  <!-- Program list -->
  <div class="prog-list" id="prog-list"></div>

  <!-- INPUT ROW ‚Äî changes based on category -->
  <div id="prog-input-row" style="display:none;margin-bottom:16px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 20px;">
    <div style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--accent4);letter-spacing:1px;font-weight:700;margin-bottom:12px;">üì• INPUT</div>
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
      <!-- Number/Math input -->
      <div id="prog-num-inputs" style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
        <div>
          <label style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);display:block;margin-bottom:4px;" id="prog-n-label">N</label>
          <input type="number" id="prog-n-input" placeholder="e.g. 20" min="1" max="500"
            style="width:130px;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 14px;font-family:'Space Mono',monospace;font-size:.85rem;outline:none;"
            onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
        </div>
        <div id="prog-n2-wrap" style="display:none;">
          <label style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);display:block;margin-bottom:4px;" id="prog-n2-label">Second Number</label>
          <input type="number" id="prog-n2-input" placeholder="e.g. 8" min="1" max="1000"
            style="width:150px;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 14px;font-family:'Space Mono',monospace;font-size:.85rem;outline:none;"
            onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
        </div>
      </div>
      <!-- String input ‚Äî shown only for string programs -->
      <div id="prog-str-inputs" style="display:none;gap:10px;flex-wrap:wrap;">
        <div>
          <label style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);display:block;margin-bottom:4px;">String / Word</label>
          <input type="text" id="prog-str-input" placeholder="e.g. hello" maxlength="40"
            style="width:200px;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 14px;font-family:'Space Mono',monospace;font-size:.85rem;outline:none;text-transform:lowercase;"
            onfocus="this.style.borderColor='var(--accent4)'" onblur="this.style.borderColor='var(--border)'">
        </div>
        <div id="prog-str2-wrap" style="display:none;">
          <label style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);display:block;margin-bottom:4px;">Second Word</label>
          <input type="text" id="prog-str2-input" placeholder="e.g. world" maxlength="40"
            style="width:200px;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:9px 14px;font-family:'Space Mono',monospace;font-size:.85rem;outline:none;text-transform:lowercase;"
            onfocus="this.style.borderColor='var(--accent4)'" onblur="this.style.borderColor='var(--border)'">
        </div>
      </div>
      <!-- Action buttons -->
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:4px;">
        <button class="btn btn-primary" onclick="runProgram()">‚ñ∂ Run</button>
        <button class="btn btn-secondary" onclick="stepProgram()">Step ‚Üí</button>
        <button class="btn btn-secondary" onclick="resetProgram()">‚Ü∫ Reset</button>
        <div style="display:flex;align-items:center;gap:6px;">
          <label style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);">Speed</label>
          <input type="range" id="prog-speed" min="1" max="10" value="5" style="accent-color:var(--accent);width:80px;">
        </div>
      </div>
    </div>
  </div>

  <!-- VOICE BAR for programs -->
  <div id="prog-voice-bar" style="display:none;background:var(--card);border:1px solid rgba(167,139,250,.3);border-radius:12px;padding:10px 16px;margin-bottom:16px;display:none;align-items:center;gap:10px;flex-wrap:wrap;">
    <span style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--accent4);letter-spacing:1px;">üéô VOICE</span>
    <button class="lang-btn active" id="prog-lang-en" onclick="progSetLang('en')">üá¨üáß English</button>
    <button class="lang-btn" id="prog-lang-hi" onclick="progSetLang('hi')">üáÆüá≥ Hindi</button>
    <button class="speak-btn" id="prog-speak-btn" onclick="progSpeakCurrent()">üîä <span id="prog-speak-label">Speak Step</span></button>
    <label style="display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.7rem;color:var(--muted);cursor:pointer;">
      <input type="checkbox" id="prog-auto-speak" style="accent-color:var(--accent4);"> Auto-speak
    </label>
    <button class="speak-btn" onclick="progStopSpeak()" style="border-color:var(--accent2);color:var(--accent2);">‚èπ Stop</button>
    <div id="prog-voice-bubble" style="display:none;flex:1;min-width:200px;background:rgba(167,139,250,.08);border:1px solid rgba(167,139,250,.3);border-radius:8px;padding:8px 12px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--text);line-height:1.5;"></div>
  </div>

  <!-- PATTERN DISPLAY ‚Äî canvas-based centered display -->
  <div id="prog-pattern-area" style="display:none;margin-bottom:20px;">
    <div class="ds-viz-box" style="min-height:280px;padding:0;">
      <canvas id="prog-pattern-canvas" style="display:block;width:100%;min-height:280px;background:var(--bg);"></canvas>
    </div>
  </div>

  <!-- Visual output area (chips for numbers/math/string) -->
  <div id="prog-viz-area" style="display:none;margin-bottom:20px;">
    <div class="ds-viz-box">
      <div id="prog-visual" style="padding:20px 24px;min-height:120px;font-family:'Space Mono',monospace;font-size:.85rem;line-height:1.8;word-break:break-all;"></div>
    </div>
  </div>

  <!-- Step explanation -->
  <div class="ds-step-box" id="prog-step-box" style="display:none;">
    <div class="ds-step-label">CURRENT STEP</div>
    <div id="prog-step-text">Select a program and press Run.</div>
  </div>

  <!-- Code panel -->
  <div id="prog-code-area" style="display:none;">
    <div class="code-panel">
      <div class="code-header">
        <div class="dot" style="background:#ff6b6b"></div>
        <div class="dot" style="background:#ffd93d"></div>
        <div class="dot" style="background:#00f5c4"></div>
        <span style="margin-left:8px" id="prog-code-title">program.py</span>
      </div>
      <pre id="prog-code-display"></pre>
    </div>
  </div>

</div>
</div>

<!-- ========== PAGE: PASTE CODE ========== -->
<div class="page" id="page-paste">
<div class="paste-main">
  <div class="paste-hero">
    <h2>Paste Your <em>Python Code</em></h2>
    <p>Paste code ‚Üí syntax check ‚Üí set input ‚Üí visualize live</p>
  </div>

  <!-- LANGUAGE SELECTOR -->
  <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
    <span style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--muted);">Language:</span>
    <select id="paste-lang-select" onchange="onLangChange()" style="background:var(--card);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:7px 14px;font-family:'Space Mono',monospace;font-size:.78rem;outline:none;cursor:pointer;">
      <option value="python">üêç Python</option>
      <option value="cpp">‚ö° C++</option>
      <option value="c">üîß C</option>
      <option value="java">‚òï Java</option>
      <option value="javascript">üåê JavaScript</option>
      <option value="csharp">üíé C#</option>
    </select>
    <span id="paste-lang-hint" style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);"></span>
  </div>

  <!-- EDITOR WITH LINE NUMBERS -->
  <div class="editor-area">
    <div class="editor-header">
      <div style="display:flex;align-items:center;gap:10px;">
        <span id="paste-file-label">üìÑ your_algorithm.py</span>
        <span id="syntax-badge" style="display:none;padding:3px 10px;border-radius:99px;font-size:.68rem;font-family:'Space Mono',monospace;font-weight:700;"></span>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary" onclick="clearPasteCode()">Clear</button>
        <button id="ai-fix-btn" class="btn" onclick="aiFixCode()" style="display:none;background:rgba(167,139,250,.15);border:1.5px solid rgba(167,139,250,.4);color:var(--accent4);">ü§ñ AI Fix</button>
      </div>
    </div>
    <div style="display:flex;background:var(--bg);min-height:180px;">
      <div id="line-numbers" style="padding:20px 10px 20px 14px;font-family:'Space Mono',monospace;font-size:.78rem;line-height:1.8;color:#3a3a5e;text-align:right;min-width:42px;user-select:none;border-right:1px solid var(--border);white-space:pre;"></div>
      <textarea id="paste-code" style="flex:1;border-radius:0;border:none;min-height:180px;" placeholder="# Paste your Python sorting or searching algorithm here...
# Example:
def my_sort(arr):
    for i in range(len(arr)):
        for j in range(i+1, len(arr)):
            if arr[j] < arr[i]:
                arr[i], arr[j] = arr[j], arr[i]
    return arr" oninput="onCodeInput()" onscroll="syncScroll()" onkeydown="handleTab(event)"></textarea>
    </div>
    <div id="error-overlay" style="display:none;padding:0;border-top:1px solid rgba(255,107,107,0.3);">
      <div id="error-lines-list"></div>
    </div>
  </div>

  <!-- ANALYSIS PANEL -->
  <div id="analysis-panel" style="display:none;margin-bottom:20px;">
    <div id="analysis-content"></div>
  </div>

  <!-- INPUT ARRAY SECTION -->
  <div id="input-section" style="display:none;margin-bottom:20px;">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
        <h3 style="font-size:.9rem;color:var(--accent4);">üéØ Set Your Input Array</h3>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="genRandomInput()">‚ö° Random</button>
          <button class="btn btn-secondary" onclick="genSortedInput()">‚Üë Sorted</button>
          <button class="btn btn-secondary" onclick="genReversedInput()">‚Üì Reversed</button>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <div style="flex:1;min-width:220px;">
          <label style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);display:block;margin-bottom:6px;">ARRAY VALUES (comma-separated)</label>
          <input type="text" id="array-input" placeholder="e.g. 64, 25, 12, 22, 11"
            style="width:100%;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:10px 14px;font-family:'Space Mono',monospace;font-size:.82rem;outline:none;transition:border .2s;"
            oninput="validateArrayInput()" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
          <div id="array-error" style="font-family:'Space Mono',monospace;font-size:.7rem;color:var(--accent2);margin-top:5px;display:none;"></div>
        </div>
        <div id="search-target-group" style="display:none;min-width:140px;">
          <label style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);display:block;margin-bottom:6px;">SEARCH TARGET</label>
          <input type="number" id="target-input" placeholder="e.g. 22"
            style="width:100%;background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:8px;padding:10px 14px;font-family:'Space Mono',monospace;font-size:.82rem;outline:none;"
            onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
        </div>
      </div>
      <div id="array-preview" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
  </div>

  <!-- GENERATE BUTTON -->
  <div id="generate-section" style="display:none;margin-bottom:28px;text-align:center;">
    <button class="btn btn-primary" id="generate-btn" onclick="generateVisualization()"
      style="padding:14px 40px;font-size:.95rem;border-radius:12px;box-shadow:0 0 30px rgba(0,245,196,0.3);">
      ‚ú® Generate Visualization
    </button>
    <div style="margin-top:10px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);" id="gen-hint"></div>
  </div>

  <!-- SAMPLES -->
  <div class="info-box">
    <h3>üí° Try a sample</h3>
    <p>Pick a sample to load and instantly analyze it.</p>
    <div class="sample-btns">
      <button class="btn btn-secondary" onclick="loadSample('selection')">Selection Sort</button>
      <button class="btn btn-secondary" onclick="loadSample('bubble')">Bubble Sort</button>
      <button class="btn btn-secondary" onclick="loadSample('insertion')">Insertion Sort</button>
      <button class="btn btn-secondary" onclick="loadSample('heap')">Heap Sort</button>
      <button class="btn btn-secondary" onclick="loadSample('quick')">Quick Sort</button>
      <button class="btn btn-secondary" onclick="loadSample('binary')">Binary Search</button>
      <button class="btn btn-secondary" onclick="loadBrokenSample()" style="border-color:var(--accent2);color:var(--accent2);">‚ùå Broken Code</button>
    </div>
  </div>

  <!-- VIZ OUTPUT -->
  <div id="parse-viz-container"></div>
</div>
</div>

<!-- ========== PAGE: COMPARE ========== -->
<div class="page" id="page-compare">
<div class="compare-main">
  <div class="compare-hero">
    <h2>Side-by-Side <em>Comparison</em></h2>
    <p style="color:var(--muted);font-size:.9rem">Race two algorithms on the same array ‚Äî see who wins</p>
  </div>

  <div class="compare-selectors">
    <div class="compare-select-group">
      <label>ALGORITHM A</label>
      <select id="algoA" onchange="initCompare()">
        <option value="selection">Selection Sort</option>
        <option value="bubble">Bubble Sort</option>
        <option value="insertion">Insertion Sort</option>
        <option value="merge" selected>Merge Sort</option>
        <option value="quick">Quick Sort</option>
        <option value="heap">Heap Sort</option>
        <option value="shell">Shell Sort</option>
        <option value="counting">Counting Sort</option>
      </select>
    </div>
    <div style="display:flex;align-items:center;font-size:1.5rem;color:var(--muted);padding-top:22px;">VS</div>
    <div class="compare-select-group">
      <label>ALGORITHM B</label>
      <select id="algoB" onchange="initCompare()">
        <option value="selection" selected>Selection Sort</option>
        <option value="bubble">Bubble Sort</option>
        <option value="insertion">Insertion Sort</option>
        <option value="merge">Merge Sort</option>
        <option value="quick">Quick Sort</option>
        <option value="heap">Heap Sort</option>
        <option value="shell">Shell Sort</option>
        <option value="counting">Counting Sort</option>
      </select>
    </div>
    <div class="compare-select-group">
      <label>ARRAY SIZE</label>
      <select id="compareSize" onchange="initCompare()">
        <option value="8">8 elements</option>
        <option value="14" selected>14 elements</option>
        <option value="20">20 elements</option>
        <option value="28">28 elements</option>
      </select>
    </div>
  </div>

  <div style="display:flex;gap:12px;justify-content:center;margin-bottom:24px;flex-wrap:wrap;">
    <button class="btn btn-primary" id="cmpPlayBtn" onclick="comparePlayPause()">‚ñ∂ Race!</button>
    <button class="btn btn-secondary" onclick="initCompare()">‚Ü∫ New Array</button>
    <button class="btn btn-secondary" onclick="compareStepForward()">Step Both ‚Üí</button>
    <div style="display:flex;align-items:center;gap:8px;">
      <label style="font-family:'Space Mono',monospace;font-size:.75rem;color:var(--muted);">Speed</label>
      <input type="range" id="cmpSpeed" min="1" max="10" value="5" style="accent-color:var(--accent);width:100px;">
    </div>
  </div>

  <div class="race-bar-container" id="race-bars">
    <h3>LIVE RACE ‚Äî Comparisons</h3>
    <div class="race-row">
      <div class="race-label" id="raceALabel">Merge Sort</div>
      <div class="race-track"><div class="race-fill" id="raceFillA" style="width:0%;background:var(--accent)">0</div></div>
    </div>
    <div class="race-row">
      <div class="race-label" id="raceBLabel">Selection Sort</div>
      <div class="race-track"><div class="race-fill" id="raceFillB" style="width:0%;background:var(--accent2)">0</div></div>
    </div>
  </div>

  <div class="compare-grid">
    <div class="compare-panel">
      <div class="compare-panel-header">
        <h3 id="panelATitle"><span>A</span> ‚Äî Merge Sort</h3>
        <div class="stat" style="font-size:.72rem;">Cmps: <span id="cmpA">0</span> | Swaps: <span id="swpA">0</span></div>
      </div>
      <canvas class="compare-canvas" id="canvasA"></canvas>
      <div class="compare-step-msg" id="msgA">Ready</div>
    </div>
    <div class="compare-panel">
      <div class="compare-panel-header">
        <h3 id="panelBTitle"><span style="color:var(--accent2)">B</span> ‚Äî Selection Sort</h3>
        <div class="stat" style="font-size:.72rem;">Cmps: <span id="cmpB">0</span> | Swaps: <span id="swpB">0</span></div>
      </div>
      <canvas class="compare-canvas" id="canvasB"></canvas>
      <div class="compare-step-msg" id="msgB">Ready</div>
    </div>
  </div>

  <div id="winner-banner" style="display:none;text-align:center;padding:20px;background:var(--card);border:1px solid var(--accent);border-radius:14px;margin-bottom:20px;">
    <div style="font-size:1.5rem;font-weight:800;" id="winner-text"></div>
    <div style="color:var(--muted);font-family:'Space Mono',monospace;font-size:.8rem;margin-top:8px;" id="winner-stats"></div>
  </div>
</div>
</div>

<script>
// ============================================================
// ALGORITHM DEFINITIONS
// ============================================================
const SAMPLES = {
  selection:`def selection_sort(arr):
    n = len(arr)
    for i in range(n):
        min_idx = i
        for j in range(i+1, n):
            if arr[j] < arr[min_idx]:
                min_idx = j
        arr[i], arr[min_idx] = arr[min_idx], arr[i]
    return arr`,
  bubble:`def bubble_sort(arr):
    n = len(arr)
    for i in range(n):
        swapped = False
        for j in range(n-i-1):
            if arr[j] > arr[j+1]:
                arr[j], arr[j+1] = arr[j+1], arr[j]
                swapped = True
        if not swapped:
            break
    return arr`,
  insertion:`def insertion_sort(arr):
    for i in range(1, len(arr)):
        key = arr[i]
        j = i - 1
        while j >= 0 and arr[j] > key:
            arr[j+1] = arr[j]
            j -= 1
        arr[j+1] = key
    return arr`,
  heap:`def heap_sort(arr):
    n = len(arr)
    for i in range(n//2-1, -1, -1):
        heapify(arr, n, i)
    for i in range(n-1, 0, -1):
        arr[0], arr[i] = arr[i], arr[0]
        heapify(arr, i, 0)
    return arr

def heapify(arr, n, i):
    largest = i
    l, r = 2*i+1, 2*i+2
    if l < n and arr[l] > arr[largest]:
        largest = l
    if r < n and arr[r] > arr[largest]:
        largest = r
    if largest != i:
        arr[i], arr[largest] = arr[largest], arr[i]
        heapify(arr, n, largest)`,
  quick:`def quick_sort(arr, low=0, high=None):
    if high is None: high = len(arr)-1
    if low < high:
        pi = partition(arr, low, high)
        quick_sort(arr, low, pi-1)
        quick_sort(arr, pi+1, high)
    return arr

def partition(arr, low, high):
    pivot = arr[high]
    i = low - 1
    for j in range(low, high):
        if arr[j] <= pivot:
            i += 1
            arr[i], arr[j] = arr[j], arr[i]
    arr[i+1], arr[high] = arr[high], arr[i+1]
    return i+1`,
  binary:`def binary_search(arr, target):
    left, right = 0, len(arr)-1
    while left <= right:
        mid = (left + right) // 2
        if arr[mid] == target:
            return mid
        elif arr[mid] < target:
            left = mid + 1
        else:
            right = mid - 1
    return -1`
};

// ============================================================
// MULTI-LANGUAGE CODE DATABASE
// ============================================================
let currentVizLang = 'python';

const LANG_FILE_EXT = {python:'py', cpp:'cpp', c:'c', java:'java', javascript:'js'};

const ALGO_MULTILANG = {
  selection:{
    python:`def selection_sort(arr):
    n = len(arr)
    for i in range(n):
        min_idx = i
        for j in range(i+1, n):
            if arr[j] < arr[min_idx]:
                min_idx = j
        arr[i], arr[min_idx] = arr[min_idx], arr[i]
    return arr`,
    cpp:`void selectionSort(int arr[], int n) {
    for (int i = 0; i < n-1; i++) {
        int min_idx = i;
        for (int j = i+1; j < n; j++)
            if (arr[j] < arr[min_idx])
                min_idx = j;
        swap(arr[min_idx], arr[i]);
    }
}`,
    c:`void selectionSort(int arr[], int n) {
    for (int i = 0; i < n-1; i++) {
        int min_idx = i;
        for (int j = i+1; j < n; j++)
            if (arr[j] < arr[min_idx])
                min_idx = j;
        int temp = arr[min_idx];
        arr[min_idx] = arr[i];
        arr[i] = temp;
    }
}`,
    java:`void selectionSort(int[] arr) {
    int n = arr.length;
    for (int i = 0; i < n-1; i++) {
        int min_idx = i;
        for (int j = i+1; j < n; j++)
            if (arr[j] < arr[min_idx])
                min_idx = j;
        int temp = arr[min_idx];
        arr[min_idx] = arr[i];
        arr[i] = temp;
    }
}`,
    javascript:`function selectionSort(arr) {
    const n = arr.length;
    for (let i = 0; i < n-1; i++) {
        let minIdx = i;
        for (let j = i+1; j < n; j++)
            if (arr[j] < arr[minIdx]) minIdx = j;
        [arr[i], arr[minIdx]] = [arr[minIdx], arr[i]];
    }
    return arr;
}`
  },
  bubble:{
    python:`def bubble_sort(arr):
    n = len(arr)
    for i in range(n):
        swapped = False
        for j in range(n-i-1):
            if arr[j] > arr[j+1]:
                arr[j], arr[j+1] = arr[j+1], arr[j]
                swapped = True
        if not swapped:
            break
    return arr`,
    cpp:`void bubbleSort(int arr[], int n) {
    for (int i = 0; i < n-1; i++) {
        bool swapped = false;
        for (int j = 0; j < n-i-1; j++) {
            if (arr[j] > arr[j+1]) {
                swap(arr[j], arr[j+1]);
                swapped = true;
            }
        }
        if (!swapped) break;
    }
}`,
    c:`void bubbleSort(int arr[], int n) {
    for (int i = 0; i < n-1; i++) {
        int swapped = 0;
        for (int j = 0; j < n-i-1; j++) {
            if (arr[j] > arr[j+1]) {
                int tmp = arr[j];
                arr[j] = arr[j+1];
                arr[j+1] = tmp;
                swapped = 1;
            }
        }
        if (!swapped) break;
    }
}`,
    java:`void bubbleSort(int[] arr) {
    int n = arr.length;
    for (int i = 0; i < n-1; i++) {
        boolean swapped = false;
        for (int j = 0; j < n-i-1; j++) {
            if (arr[j] > arr[j+1]) {
                int tmp = arr[j]; arr[j] = arr[j+1]; arr[j+1] = tmp;
                swapped = true;
            }
        }
        if (!swapped) break;
    }
}`,
    javascript:`function bubbleSort(arr) {
    const n = arr.length;
    for (let i = 0; i < n-1; i++) {
        let swapped = false;
        for (let j = 0; j < n-i-1; j++) {
            if (arr[j] > arr[j+1]) {
                [arr[j], arr[j+1]] = [arr[j+1], arr[j]];
                swapped = true;
            }
        }
        if (!swapped) break;
    }
    return arr;
}`
  },
  insertion:{
    python:`def insertion_sort(arr):
    for i in range(1, len(arr)):
        key = arr[i]
        j = i - 1
        while j >= 0 and arr[j] > key:
            arr[j+1] = arr[j]
            j -= 1
        arr[j+1] = key
    return arr`,
    cpp:`void insertionSort(int arr[], int n) {
    for (int i = 1; i < n; i++) {
        int key = arr[i];
        int j = i - 1;
        while (j >= 0 && arr[j] > key) {
            arr[j+1] = arr[j];
            j--;
        }
        arr[j+1] = key;
    }
}`,
    c:`void insertionSort(int arr[], int n) {
    for (int i = 1; i < n; i++) {
        int key = arr[i], j = i - 1;
        while (j >= 0 && arr[j] > key) {
            arr[j+1] = arr[j];
            j--;
        }
        arr[j+1] = key;
    }
}`,
    java:`void insertionSort(int[] arr) {
    int n = arr.length;
    for (int i = 1; i < n; i++) {
        int key = arr[i], j = i - 1;
        while (j >= 0 && arr[j] > key) {
            arr[j+1] = arr[j]; j--;
        }
        arr[j+1] = key;
    }
}`,
    javascript:`function insertionSort(arr) {
    for (let i = 1; i < arr.length; i++) {
        let key = arr[i], j = i - 1;
        while (j >= 0 && arr[j] > key) {
            arr[j+1] = arr[j]; j--;
        }
        arr[j+1] = key;
    }
    return arr;
}`
  },
  merge:{
    python:`def merge_sort(arr):
    if len(arr) <= 1:
        return arr
    mid = len(arr) // 2
    left = merge_sort(arr[:mid])
    right = merge_sort(arr[mid:])
    return merge(left, right)

def merge(left, right):
    result, i, j = [], 0, 0
    while i < len(left) and j < len(right):
        if left[i] <= right[j]:
            result.append(left[i]); i += 1
        else:
            result.append(right[j]); j += 1
    return result + left[i:] + right[j:]`,
    cpp:`void merge(int arr[], int l, int m, int r) {
    vector<int> L(arr+l, arr+m+1), R(arr+m+1, arr+r+1);
    int i=0, j=0, k=l;
    while(i<L.size() && j<R.size())
        arr[k++] = L[i]<=R[j] ? L[i++] : R[j++];
    while(i<L.size()) arr[k++] = L[i++];
    while(j<R.size()) arr[k++] = R[j++];
}
void mergeSort(int arr[], int l, int r) {
    if(l < r) {
        int m = (l+r)/2;
        mergeSort(arr, l, m);
        mergeSort(arr, m+1, r);
        merge(arr, l, m, r);
    }
}`,
    c:`void merge(int arr[], int l, int m, int r) {
    int n1=m-l+1, n2=r-m;
    int L[n1], R[n2];
    for(int i=0;i<n1;i++) L[i]=arr[l+i];
    for(int j=0;j<n2;j++) R[j]=arr[m+1+j];
    int i=0,j=0,k=l;
    while(i<n1&&j<n2) arr[k++]=L[i]<=R[j]?L[i++]:R[j++];
    while(i<n1) arr[k++]=L[i++];
    while(j<n2) arr[k++]=R[j++];
}`,
    java:`void mergeSort(int[] arr, int l, int r) {
    if (l < r) {
        int m = (l+r)/2;
        mergeSort(arr, l, m);
        mergeSort(arr, m+1, r);
        merge(arr, l, m, r);
    }
}
void merge(int[] arr, int l, int m, int r) {
    int[] left = Arrays.copyOfRange(arr, l, m+1);
    int[] right = Arrays.copyOfRange(arr, m+1, r+1);
    int i=0, j=0, k=l;
    while(i<left.length && j<right.length)
        arr[k++] = left[i]<=right[j] ? left[i++] : right[j++];
    while(i<left.length) arr[k++] = left[i++];
    while(j<right.length) arr[k++] = right[j++];
}`,
    javascript:`function mergeSort(arr) {
    if (arr.length <= 1) return arr;
    const mid = Math.floor(arr.length / 2);
    const left = mergeSort(arr.slice(0, mid));
    const right = mergeSort(arr.slice(mid));
    return merge(left, right);
}
function merge(left, right) {
    const result = []; let i=0, j=0;
    while(i<left.length && j<right.length)
        result.push(left[i]<=right[j] ? left[i++] : right[j++]);
    return [...result, ...left.slice(i), ...right.slice(j)];
}`
  },
  quick:{
    python:`def quick_sort(arr, low, high):
    if low < high:
        pi = partition(arr, low, high)
        quick_sort(arr, low, pi-1)
        quick_sort(arr, pi+1, high)

def partition(arr, low, high):
    pivot = arr[high]
    i = low - 1
    for j in range(low, high):
        if arr[j] <= pivot:
            i += 1
            arr[i], arr[j] = arr[j], arr[i]
    arr[i+1], arr[high] = arr[high], arr[i+1]
    return i+1`,
    cpp:`int partition(int arr[], int low, int high) {
    int pivot = arr[high], i = low - 1;
    for (int j = low; j < high; j++)
        if (arr[j] <= pivot)
            swap(arr[++i], arr[j]);
    swap(arr[i+1], arr[high]);
    return i+1;
}
void quickSort(int arr[], int low, int high) {
    if (low < high) {
        int pi = partition(arr, low, high);
        quickSort(arr, low, pi-1);
        quickSort(arr, pi+1, high);
    }
}`,
    c:`int partition(int arr[], int low, int high) {
    int pivot = arr[high], i = low - 1, tmp;
    for (int j = low; j < high; j++) {
        if (arr[j] <= pivot) {
            i++;
            tmp=arr[i]; arr[i]=arr[j]; arr[j]=tmp;
        }
    }
    tmp=arr[i+1]; arr[i+1]=arr[high]; arr[high]=tmp;
    return i+1;
}`,
    java:`int partition(int[] arr, int low, int high) {
    int pivot = arr[high], i = low - 1;
    for (int j = low; j < high; j++) {
        if (arr[j] <= pivot) {
            int tmp = arr[++i]; arr[i] = arr[j]; arr[j] = tmp;
        }
    }
    int tmp = arr[i+1]; arr[i+1] = arr[high]; arr[high] = tmp;
    return i+1;
}`,
    javascript:`function quickSort(arr, low=0, high=arr.length-1) {
    if (low < high) {
        const pi = partition(arr, low, high);
        quickSort(arr, low, pi-1);
        quickSort(arr, pi+1, high);
    }
    return arr;
}
function partition(arr, low, high) {
    const pivot = arr[high]; let i = low - 1;
    for (let j = low; j < high; j++)
        if (arr[j] <= pivot) [arr[++i], arr[j]] = [arr[j], arr[i]];
    [arr[i+1], arr[high]] = [arr[high], arr[i+1]];
    return i+1;
}`
  },
  heap:{
    python:`def heap_sort(arr):
    n = len(arr)
    for i in range(n//2-1, -1, -1):
        heapify(arr, n, i)
    for i in range(n-1, 0, -1):
        arr[0], arr[i] = arr[i], arr[0]
        heapify(arr, i, 0)

def heapify(arr, n, i):
    largest = i
    l, r = 2*i+1, 2*i+2
    if l < n and arr[l] > arr[largest]: largest = l
    if r < n and arr[r] > arr[largest]: largest = r
    if largest != i:
        arr[i], arr[largest] = arr[largest], arr[i]
        heapify(arr, n, largest)`,
    cpp:`void heapify(int arr[], int n, int i) {
    int largest = i, l = 2*i+1, r = 2*i+2;
    if (l<n && arr[l]>arr[largest]) largest=l;
    if (r<n && arr[r]>arr[largest]) largest=r;
    if (largest != i) {
        swap(arr[i], arr[largest]);
        heapify(arr, n, largest);
    }
}
void heapSort(int arr[], int n) {
    for (int i=n/2-1; i>=0; i--) heapify(arr,n,i);
    for (int i=n-1; i>0; i--) {
        swap(arr[0], arr[i]); heapify(arr,i,0);
    }
}`,
    c:`void heapify(int arr[], int n, int i) {
    int largest=i, l=2*i+1, r=2*i+2, tmp;
    if(l<n && arr[l]>arr[largest]) largest=l;
    if(r<n && arr[r]>arr[largest]) largest=r;
    if(largest!=i){
        tmp=arr[i];arr[i]=arr[largest];arr[largest]=tmp;
        heapify(arr,n,largest);
    }
}`,
    java:`void heapSort(int[] arr) {
    int n = arr.length;
    for (int i=n/2-1; i>=0; i--) heapify(arr,n,i);
    for (int i=n-1; i>0; i--) {
        int tmp=arr[0]; arr[0]=arr[i]; arr[i]=tmp;
        heapify(arr,i,0);
    }
}
void heapify(int[] arr, int n, int i) {
    int largest=i, l=2*i+1, r=2*i+2;
    if(l<n && arr[l]>arr[largest]) largest=l;
    if(r<n && arr[r]>arr[largest]) largest=r;
    if(largest!=i){
        int tmp=arr[i]; arr[i]=arr[largest]; arr[largest]=tmp;
        heapify(arr,n,largest);
    }
}`,
    javascript:`function heapSort(arr) {
    const n = arr.length;
    for (let i=Math.floor(n/2)-1; i>=0; i--) heapify(arr,n,i);
    for (let i=n-1; i>0; i--) {
        [arr[0],arr[i]]=[arr[i],arr[0]]; heapify(arr,i,0);
    }
    return arr;
}
function heapify(arr,n,i) {
    let largest=i, l=2*i+1, r=2*i+2;
    if(l<n&&arr[l]>arr[largest]) largest=l;
    if(r<n&&arr[r]>arr[largest]) largest=r;
    if(largest!==i){ [arr[i],arr[largest]]=[arr[largest],arr[i]]; heapify(arr,n,largest);}
}`
  },
  shell:{
    python:`def shell_sort(arr):
    n, gap = len(arr), len(arr)//2
    while gap > 0:
        for i in range(gap, n):
            temp = arr[i]
            j = i
            while j >= gap and arr[j-gap] > temp:
                arr[j] = arr[j-gap]
                j -= gap
            arr[j] = temp
        gap //= 2
    return arr`,
    cpp:`void shellSort(int arr[], int n) {
    for (int gap=n/2; gap>0; gap/=2)
        for (int i=gap; i<n; i++) {
            int temp=arr[i], j=i;
            while(j>=gap && arr[j-gap]>temp) {
                arr[j]=arr[j-gap]; j-=gap;
            }
            arr[j]=temp;
        }
}`,
    c:`void shellSort(int arr[], int n) {
    for (int gap=n/2; gap>0; gap/=2)
        for (int i=gap; i<n; i++) {
            int temp=arr[i], j=i;
            while(j>=gap && arr[j-gap]>temp) {
                arr[j]=arr[j-gap]; j-=gap;
            }
            arr[j]=temp;
        }
}`,
    java:`void shellSort(int[] arr) {
    int n = arr.length;
    for (int gap=n/2; gap>0; gap/=2)
        for (int i=gap; i<n; i++) {
            int temp=arr[i], j=i;
            while(j>=gap && arr[j-gap]>temp) {
                arr[j]=arr[j-gap]; j-=gap;
            }
            arr[j]=temp;
        }
}`,
    javascript:`function shellSort(arr) {
    const n = arr.length;
    for (let gap=Math.floor(n/2); gap>0; gap=Math.floor(gap/2))
        for (let i=gap; i<n; i++) {
            let temp=arr[i], j=i;
            while(j>=gap && arr[j-gap]>temp) {
                arr[j]=arr[j-gap]; j-=gap;
            }
            arr[j]=temp;
        }
    return arr;
}`
  },
  counting:{
    python:`def counting_sort(arr):
    max_val = max(arr)
    count = [0] * (max_val + 1)
    for num in arr:
        count[num] += 1
    result = []
    for i, c in enumerate(count):
        result.extend([i] * c)
    return result`,
    cpp:`void countingSort(int arr[], int n) {
    int mx = *max_element(arr, arr+n);
    vector<int> cnt(mx+1, 0);
    for(int i=0;i<n;i++) cnt[arr[i]]++;
    int idx=0;
    for(int i=0;i<=mx;i++)
        while(cnt[i]--) arr[idx++]=i;
}`,
    c:`void countingSort(int arr[], int n) {
    int mx=arr[0];
    for(int i=1;i<n;i++) if(arr[i]>mx) mx=arr[i];
    int cnt[mx+1]; memset(cnt,0,sizeof(cnt));
    for(int i=0;i<n;i++) cnt[arr[i]]++;
    int idx=0;
    for(int i=0;i<=mx;i++) while(cnt[i]--) arr[idx++]=i;
}`,
    java:`void countingSort(int[] arr) {
    int max = Arrays.stream(arr).max().getAsInt();
    int[] count = new int[max+1];
    for (int x : arr) count[x]++;
    int idx = 0;
    for (int i=0; i<=max; i++)
        while (count[i]-- > 0) arr[idx++] = i;
}`,
    javascript:`function countingSort(arr) {
    const max = Math.max(...arr);
    const count = new Array(max+1).fill(0);
    for (const x of arr) count[x]++;
    const result = [];
    count.forEach((c,i) => { while(c--) result.push(i); });
    return result;
}`
  },
  radix:{
    python:`def radix_sort(arr):
    max_val = max(arr)
    exp = 1
    while max_val // exp > 0:
        counting_sort_exp(arr, exp)
        exp *= 10

def counting_sort_exp(arr, exp):
    n = len(arr)
    output = [0] * n
    count = [0] * 10
    for i in arr: count[(i//exp)%10] += 1
    for i in range(1,10): count[i] += count[i-1]
    for i in range(n-1,-1,-1):
        idx = (arr[i]//exp)%10
        output[count[idx]-1] = arr[i]; count[idx] -= 1
    for i in range(n): arr[i] = output[i]`,
    cpp:`void countExp(int arr[], int n, int exp) {
    int output[n], count[10]={};
    for(int i=0;i<n;i++) count[(arr[i]/exp)%10]++;
    for(int i=1;i<10;i++) count[i]+=count[i-1];
    for(int i=n-1;i>=0;i--) output[--count[(arr[i]/exp)%10]]=arr[i];
    for(int i=0;i<n;i++) arr[i]=output[i];
}
void radixSort(int arr[], int n) {
    int mx=*max_element(arr,arr+n);
    for(int e=1;mx/e>0;e*=10) countExp(arr,n,e);
}`,
    c:`void radixSort(int arr[], int n) {
    int mx=arr[0];
    for(int i=1;i<n;i++) if(arr[i]>mx) mx=arr[i];
    for(int exp=1; mx/exp>0; exp*=10) {
        int output[n], count[10]={};
        for(int i=0;i<n;i++) count[(arr[i]/exp)%10]++;
        for(int i=1;i<10;i++) count[i]+=count[i-1];
        for(int i=n-1;i>=0;i--) output[--count[(arr[i]/exp)%10]]=arr[i];
        for(int i=0;i<n;i++) arr[i]=output[i];
    }
}`,
    java:`void radixSort(int[] arr) {
    int max = Arrays.stream(arr).max().getAsInt();
    for (int exp=1; max/exp>0; exp*=10) {
        int[] output = new int[arr.length];
        int[] count = new int[10];
        for (int x: arr) count[(x/exp)%10]++;
        for (int i=1;i<10;i++) count[i]+=count[i-1];
        for (int i=arr.length-1;i>=0;i--)
            output[--count[(arr[i]/exp)%10]]=arr[i];
        System.arraycopy(output,0,arr,0,arr.length);
    }
}`,
    javascript:`function radixSort(arr) {
    const max = Math.max(...arr);
    for (let exp=1; Math.floor(max/exp)>0; exp*=10) {
        const output=new Array(arr.length).fill(0), cnt=new Array(10).fill(0);
        arr.forEach(v=>cnt[Math.floor(v/exp)%10]++);
        for(let i=1;i<10;i++) cnt[i]+=cnt[i-1];
        for(let i=arr.length-1;i>=0;i--)
            output[--cnt[Math.floor(arr[i]/exp)%10]]=arr[i];
        arr.splice(0,arr.length,...output);
    }
    return arr;
}`
  },
  tim:{
    python:`RUN = 32
def insertion_sort(arr, l, r):
    for i in range(l+1, r+1):
        key = arr[i]; j = i-1
        while j >= l and arr[j] > key:
            arr[j+1] = arr[j]; j -= 1
        arr[j+1] = key

def tim_sort(arr):
    n = len(arr)
    for i in range(0, n, RUN):
        insertion_sort(arr, i, min(i+RUN-1, n-1))
    size = RUN
    while size < n:
        # merge runs...
        size *= 2`,
    cpp:`const int RUN = 32;
void insertionSort(int arr[], int l, int r) {
    for(int i=l+1;i<=r;i++){
        int key=arr[i],j=i-1;
        while(j>=l&&arr[j]>key){arr[j+1]=arr[j];j--;}
        arr[j+1]=key;
    }
}
void timSort(int arr[], int n) {
    for(int i=0;i<n;i+=RUN)
        insertionSort(arr,i,min(i+RUN-1,n-1));
    for(int size=RUN;size<n;size*=2){
        // merge each pair of runs
    }
}`,
    c:`#define RUN 32
void timSort(int arr[], int n) {
    for(int i=0;i<n;i+=RUN){
        int r=i+RUN-1<n-1?i+RUN-1:n-1;
        for(int k=i+1;k<=r;k++){
            int key=arr[k],j=k-1;
            while(j>=i&&arr[j]>key){arr[j+1]=arr[j];j--;}
            arr[j+1]=key;
        }
    }
    // then merge runs...
}`,
    java:`static final int RUN = 32;
void timSort(int[] arr) {
    int n = arr.length;
    for (int i=0; i<n; i+=RUN) {
        int r = Math.min(i+RUN-1, n-1);
        for (int k=i+1;k<=r;k++){
            int key=arr[k], j=k-1;
            while(j>=i&&arr[j]>key){arr[j+1]=arr[j];j--;}
            arr[j+1]=key;
        }
    }
    // then merge the sorted runs
}`,
    javascript:`const RUN = 32;
function timSort(arr) {
    const n = arr.length;
    for (let i=0; i<n; i+=RUN) {
        const r = Math.min(i+RUN-1, n-1);
        for (let k=i+1;k<=r;k++){
            let key=arr[k], j=k-1;
            while(j>=i&&arr[j]>key){arr[j+1]=arr[j];j--;}
            arr[j+1]=key;
        }
    }
    // merge the sorted runs
    return arr;
}`
  },
  cycle:{
    python:`def cycle_sort(arr):
    writes = 0
    for cycle_start in range(len(arr)-1):
        item = arr[cycle_start]
        pos = cycle_start
        for i in range(cycle_start+1, len(arr)):
            if arr[i] < item: pos += 1
        while item != arr[pos]:
            arr[pos], item = item, arr[pos]
            writes += 1
    return writes`,
    cpp:`int cycleSort(int arr[], int n) {
    int writes = 0;
    for(int cs=0;cs<n-1;cs++){
        int item=arr[cs], pos=cs;
        for(int i=cs+1;i<n;i++) if(arr[i]<item) pos++;
        if(pos==cs) continue;
        while(item==arr[pos]) pos++;
        swap(arr[pos],item); writes++;
        while(pos!=cs){
            pos=cs;
            for(int i=cs+1;i<n;i++) if(arr[i]<item) pos++;
            while(item==arr[pos]) pos++;
            swap(arr[pos],item); writes++;
        }
    }
    return writes;
}`,
    c:`int cycleSort(int arr[], int n) {
    int writes=0;
    for(int cs=0;cs<n-1;cs++){
        int item=arr[cs],pos=cs,tmp;
        for(int i=cs+1;i<n;i++) if(arr[i]<item) pos++;
        if(pos==cs) continue;
        while(item==arr[pos]) pos++;
        tmp=arr[pos]; arr[pos]=item; item=tmp; writes++;
    }
    return writes;
}`,
    java:`int cycleSort(int[] arr) {
    int writes = 0;
    for (int cs=0; cs<arr.length-1; cs++) {
        int item=arr[cs], pos=cs;
        for (int i=cs+1;i<arr.length;i++) if(arr[i]<item) pos++;
        if(pos==cs) continue;
        while(item==arr[pos]) pos++;
        int tmp=arr[pos]; arr[pos]=item; item=tmp; writes++;
    }
    return writes;
}`,
    javascript:`function cycleSort(arr) {
    let writes = 0;
    for (let cs=0; cs<arr.length-1; cs++) {
        let item=arr[cs], pos=cs;
        for (let i=cs+1;i<arr.length;i++) if(arr[i]<item) pos++;
        if(pos===cs) continue;
        while(item===arr[pos]) pos++;
        [arr[pos],item]=[item,arr[pos]]; writes++;
    }
    return writes;
}`
  },
  binary:{
    python:`def binary_search(arr, target):
    left, right = 0, len(arr)-1
    while left <= right:
        mid = (left + right) // 2
        if arr[mid] == target:
            return mid
        elif arr[mid] < target:
            left = mid + 1
        else:
            right = mid - 1
    return -1  # Not found`,
    cpp:`int binarySearch(int arr[], int n, int target) {
    int left=0, right=n-1;
    while (left <= right) {
        int mid = (left+right)/2;
        if (arr[mid]==target) return mid;
        else if (arr[mid]<target) left=mid+1;
        else right=mid-1;
    }
    return -1;
}`,
    c:`int binarySearch(int arr[], int n, int target) {
    int left=0, right=n-1;
    while(left<=right){
        int mid=(left+right)/2;
        if(arr[mid]==target) return mid;
        if(arr[mid]<target) left=mid+1;
        else right=mid-1;
    }
    return -1;
}`,
    java:`int binarySearch(int[] arr, int target) {
    int left=0, right=arr.length-1;
    while (left<=right) {
        int mid = (left+right)/2;
        if (arr[mid]==target) return mid;
        else if (arr[mid]<target) left=mid+1;
        else right=mid-1;
    }
    return -1;
}`,
    javascript:`function binarySearch(arr, target) {
    let left=0, right=arr.length-1;
    while (left<=right) {
        const mid = Math.floor((left+right)/2);
        if (arr[mid]===target) return mid;
        else if (arr[mid]<target) left=mid+1;
        else right=mid-1;
    }
    return -1;
}`
  },
  linear:{
    python:`def linear_search(arr, target):
    for i, val in enumerate(arr):
        if val == target:
            return i
    return -1  # Not found`,
    cpp:`int linearSearch(int arr[], int n, int target) {
    for (int i=0; i<n; i++)
        if (arr[i]==target) return i;
    return -1;
}`,
    c:`int linearSearch(int arr[], int n, int target) {
    for (int i=0; i<n; i++)
        if (arr[i]==target) return i;
    return -1;
}`,
    java:`int linearSearch(int[] arr, int target) {
    for (int i=0; i<arr.length; i++)
        if (arr[i]==target) return i;
    return -1;
}`,
    javascript:`function linearSearch(arr, target) {
    for (let i=0; i<arr.length; i++)
        if (arr[i]===target) return i;
    return -1;
}`
  },
  jump:{
    python:`import math
def jump_search(arr, target):
    n = len(arr)
    step = int(math.sqrt(n))
    prev = 0
    while arr[min(step,n)-1] < target:
        prev = step
        step += int(math.sqrt(n))
        if prev >= n: return -1
    while arr[prev] < target:
        prev += 1
        if prev == min(step, n): return -1
    if arr[prev] == target: return prev
    return -1`,
    cpp:`int jumpSearch(int arr[], int n, int target) {
    int step=sqrt(n), prev=0;
    while(arr[min(step,n)-1]<target){
        prev=step; step+=sqrt(n);
        if(prev>=n) return -1;
    }
    while(arr[prev]<target){
        if(++prev==min(step,n)) return -1;
    }
    return arr[prev]==target ? prev : -1;
}`,
    c:`int jumpSearch(int arr[], int n, int target) {
    int step=(int)sqrt(n), prev=0;
    while(arr[(step<n?step:n)-1]<target){
        prev=step; step+=(int)sqrt(n);
        if(prev>=n) return -1;
    }
    while(arr[prev]<target) if(++prev==(step<n?step:n)) return -1;
    return arr[prev]==target?prev:-1;
}`,
    java:`int jumpSearch(int[] arr, int target) {
    int n=arr.length, step=(int)Math.sqrt(n), prev=0;
    while(arr[Math.min(step,n)-1]<target){
        prev=step; step+=(int)Math.sqrt(n);
        if(prev>=n) return -1;
    }
    while(arr[prev]<target) if(++prev==Math.min(step,n)) return -1;
    return arr[prev]==target ? prev : -1;
}`,
    javascript:`function jumpSearch(arr, target) {
    const n=arr.length, step=Math.floor(Math.sqrt(n));
    let prev=0, curr=step;
    while(curr<n && arr[curr-1]<target){ prev=curr; curr+=step; }
    for(let i=prev; i<Math.min(curr,n); i++)
        if(arr[i]===target) return i;
    return -1;
}`
  },
  interpolation:{
    python:`def interpolation_search(arr, target):
    lo, hi = 0, len(arr)-1
    while lo<=hi and target>=arr[lo] and target<=arr[hi]:
        pos = lo + (target-arr[lo])*(hi-lo)//(arr[hi]-arr[lo])
        if arr[pos]==target: return pos
        if arr[pos]<target: lo=pos+1
        else: hi=pos-1
    return -1`,
    cpp:`int interpolationSearch(int arr[], int n, int target) {
    int lo=0, hi=n-1;
    while(lo<=hi && target>=arr[lo] && target<=arr[hi]){
        int pos=lo+(long long)(target-arr[lo])*(hi-lo)/(arr[hi]-arr[lo]);
        if(arr[pos]==target) return pos;
        if(arr[pos]<target) lo=pos+1;
        else hi=pos-1;
    }
    return -1;
}`,
    c:`int interpolationSearch(int arr[], int n, int target) {
    int lo=0, hi=n-1;
    while(lo<=hi&&target>=arr[lo]&&target<=arr[hi]){
        int pos=lo+(int)((long long)(target-arr[lo])*(hi-lo)/(arr[hi]-arr[lo]));
        if(arr[pos]==target) return pos;
        if(arr[pos]<target) lo=pos+1;
        else hi=pos-1;
    }
    return -1;
}`,
    java:`int interpolationSearch(int[] arr, int target) {
    int lo=0, hi=arr.length-1;
    while(lo<=hi && target>=arr[lo] && target<=arr[hi]){
        int pos=lo+(int)((long)(target-arr[lo])*(hi-lo)/(arr[hi]-arr[lo]));
        if(arr[pos]==target) return pos;
        if(arr[pos]<target) lo=pos+1;
        else hi=pos-1;
    }
    return -1;
}`,
    javascript:`function interpolationSearch(arr, target) {
    let lo=0, hi=arr.length-1;
    while(lo<=hi && target>=arr[lo] && target<=arr[hi]){
        const pos=lo+Math.floor((target-arr[lo])*(hi-lo)/(arr[hi]-arr[lo]));
        if(arr[pos]===target) return pos;
        if(arr[pos]<target) lo=pos+1;
        else hi=pos-1;
    }
    return -1;
}`
  }
};

// Language switcher for code panel
function vizCodeLang(lang, el) {
  currentVizLang = lang;
  document.querySelectorAll('#viz-lang-tabs .algo-tab').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  renderCodeMultiLang('code-display', curAlgo, lang);
  // Update file extension in title
  const ext = LANG_FILE_EXT[lang]||'txt';
  const base = curAlgo === 'binary' ? 'binary_search' : curAlgo === 'linear' ? 'linear_search' :
               curAlgo === 'jump' ? 'jump_search' : curAlgo === 'interpolation' ? 'interpolation_search' :
               curAlgo + '_sort';
  document.getElementById('code-title').textContent = base + '.' + ext;
}

function renderCodeMultiLang(elId, name, lang) {
  lang = lang || currentVizLang;
  const pre = document.getElementById(elId);
  if (!pre) return;
  const multiCode = ALGO_MULTILANG[name];
  if (multiCode && multiCode[lang]) {
    const code = multiCode[lang];
    const lines = code.split('\n');
    pre.innerHTML = lines.map((line, i) =>
      `<span class="code-line" id="${elId}-cl${i}">${escapeHtml(line)||'&nbsp;'}</span>`
    ).join('\n');
  } else {
    // Fallback to original Python highlighted code
    renderCode(elId, name);
  }
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

const ALGOS = {
  selection:{
    title:'selection_sort.py',name:'Selection Sort',
    best:'O(n¬≤)',avg:'O(n¬≤)',worst:'O(n¬≤)',space:'O(1)',stable:'No',inplace:'Yes',
    bc:'bad',ac:'bad',wc:'bad',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">selection_sort</span>(arr):`,l:0},
      {t:`    n = <span class="fn">len</span>(arr)`,l:1},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(n):`,l:2},
      {t:`        min_idx = i`,l:3},
      {t:`        <span class="kw">for</span> j <span class="kw">in</span> <span class="fn">range</span>(i+<span class="num">1</span>, n):`,l:4},
      {t:`            <span class="kw">if</span> arr[j] <span class="op"><</span> arr[min_idx]:`,l:5},
      {t:`                min_idx = j`,l:6},
      {t:`        arr[i], arr[min_idx] = arr[min_idx], arr[i]`,l:7},
      {t:`    <span class="kw">return</span> arr`,l:8},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      for(let i=0;i<n;i++){
        s.push({a:[...a],cmp:[],hi:i,su:i-1,l:3,msg:`i=${i}: setting min_idx=${i}`});
        let mi=i;
        for(let j=i+1;j<n;j++){
          s.push({a:[...a],cmp:[j,mi],hi:mi,su:i-1,l:5,msg:`Compare arr[${j}]=${a[j]} < arr[${mi}]=${a[mi]}?`});
          if(a[j]<a[mi]){mi=j;s.push({a:[...a],cmp:[j],hi:mi,su:i-1,l:6,msg:`New min at index ${mi}, value=${a[mi]}`});}
        }
        s.push({a:[...a],cmp:[i,mi],hi:mi,su:i-1,l:7,msg:`Swap arr[${i}]=${a[i]} ‚Üî arr[${mi}]=${a[mi]}`});
        [a[i],a[mi]]=[a[mi],a[i]];
        s.push({a:[...a],cmp:[],hi:-1,su:i,l:7,msg:`Position ${i} sorted ‚úì value=${a[i]}`});
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:8,msg:`‚úÖ Array fully sorted!`});
      return s;
    }
  },
  bubble:{
    title:'bubble_sort.py',name:'Bubble Sort',
    best:'O(n)',avg:'O(n¬≤)',worst:'O(n¬≤)',space:'O(1)',stable:'Yes',inplace:'Yes',
    bc:'good',ac:'bad',wc:'bad',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">bubble_sort</span>(arr):`,l:0},
      {t:`    n = <span class="fn">len</span>(arr)`,l:1},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(n):`,l:2},
      {t:`        swapped = <span class="kw">False</span>`,l:3},
      {t:`        <span class="kw">for</span> j <span class="kw">in</span> <span class="fn">range</span>(n-i-<span class="num">1</span>):`,l:4},
      {t:`            <span class="kw">if</span> arr[j] <span class="op">></span> arr[j+<span class="num">1</span>]:`,l:5},
      {t:`                arr[j],arr[j+<span class="num">1</span>] = arr[j+<span class="num">1</span>],arr[j]`,l:6},
      {t:`        <span class="kw">if not</span> swapped: <span class="kw">break</span>`,l:7},
      {t:`    <span class="kw">return</span> arr`,l:8},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      for(let i=0;i<n;i++){
        let sw=false;
        for(let j=0;j<n-i-1;j++){
          s.push({a:[...a],cmp:[j,j+1],hi:j,su:n-i,l:5,msg:`Compare arr[${j}]=${a[j]} > arr[${j+1}]=${a[j+1]}?`});
          if(a[j]>a[j+1]){[a[j],a[j+1]]=[a[j+1],a[j]];sw=true;s.push({a:[...a],cmp:[j,j+1],hi:-1,su:n-i,l:6,msg:`Swap! ${a[j+1]} bubbles right`});}
        }
        s.push({a:[...a],cmp:[],hi:-1,su:n-i-1,l:7,msg:`Pass ${i+1} complete. ${i+1} largest placed.`});
        if(!sw)break;
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:8,msg:`‚úÖ Sorted!`});
      return s;
    }
  },
  insertion:{
    title:'insertion_sort.py',name:'Insertion Sort',
    best:'O(n)',avg:'O(n¬≤)',worst:'O(n¬≤)',space:'O(1)',stable:'Yes',inplace:'Yes',
    bc:'good',ac:'bad',wc:'bad',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">insertion_sort</span>(arr):`,l:0},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(<span class="num">1</span>, <span class="fn">len</span>(arr)):`,l:1},
      {t:`        key = arr[i]`,l:2},
      {t:`        j = i - <span class="num">1</span>`,l:3},
      {t:`        <span class="kw">while</span> j >= <span class="num">0</span> <span class="kw">and</span> arr[j] <span class="op">></span> key:`,l:4},
      {t:`            arr[j+<span class="num">1</span>] = arr[j]`,l:5},
      {t:`            j -= <span class="num">1</span>`,l:6},
      {t:`        arr[j+<span class="num">1</span>] = key`,l:7},
      {t:`    <span class="kw">return</span> arr`,l:8},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      for(let i=1;i<n;i++){
        const key=a[i];let j=i-1;
        s.push({a:[...a],cmp:[i],hi:i,su:i-1,l:2,msg:`Pick key=${key} at index ${i}`});
        while(j>=0&&a[j]>key){
          s.push({a:[...a],cmp:[j,j+1],hi:i,su:i-1,l:4,msg:`arr[${j}]=${a[j]} > key=${key}, shift right`});
          a[j+1]=a[j];j--;
          s.push({a:[...a],cmp:[j+1],hi:j+2,su:i-1,l:5,msg:`Shifted to position ${j+2}`});
        }
        a[j+1]=key;
        s.push({a:[...a],cmp:[],hi:j+1,su:i,l:7,msg:`Inserted key=${key} at position ${j+1}`});
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:8,msg:`‚úÖ Sorted!`});
      return s;
    }
  },
  merge:{
    title:'merge_sort.py',name:'Merge Sort',
    best:'O(n log n)',avg:'O(n log n)',worst:'O(n log n)',space:'O(n)',stable:'Yes',inplace:'No',
    bc:'good',ac:'good',wc:'good',sc:'ok',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">merge_sort</span>(arr):`,l:0},
      {t:`    <span class="kw">if</span> <span class="fn">len</span>(arr) <= <span class="num">1</span>: <span class="kw">return</span> arr`,l:1},
      {t:`    mid = <span class="fn">len</span>(arr) // <span class="num">2</span>`,l:2},
      {t:`    left = <span class="fn">merge_sort</span>(arr[:mid])`,l:3},
      {t:`    right = <span class="fn">merge_sort</span>(arr[mid:])`,l:4},
      {t:`    <span class="kw">return</span> <span class="fn">merge</span>(left, right)`,l:5},
      {t:``,l:6},
      {t:`<span class="kw">def</span> <span class="fn">merge</span>(left, right):`,l:7},
      {t:`    result, i, j = [], <span class="num">0</span>, <span class="num">0</span>`,l:8},
      {t:`    <span class="kw">while</span> i < <span class="fn">len</span>(left) <span class="kw">and</span> j < <span class="fn">len</span>(right):`,l:9},
      {t:`        result.append(left[i] <span class="kw">if</span> left[i]<=right[j] <span class="kw">else</span> right[j])`,l:10},
    ],
    gen(arr){
      const s=[],a=[...arr];
      function ms(array,offset){
        if(array.length<=1)return array;
        const mid=Math.floor(array.length/2);
        const L=ms(array.slice(0,mid),offset);
        const R=ms(array.slice(mid),offset+mid);
        return mg(L,R,offset);
      }
      function mg(L,R,off){
        const res=[];let i=0,j=0;
        while(i<L.length&&j<R.length){
          s.push({a:[...a],cmp:[off+i,off+L.length+j],hi:-1,su:-1,l:10,msg:`Merge: ${L[i]} vs ${R[j]}`});
          if(L[i]<=R[j]){res.push(L[i]);i++;}else{res.push(R[j]);j++;}
        }
        const merged=[...res,...L.slice(i),...R.slice(j)];
        for(let k=0;k<merged.length;k++)a[off+k]=merged[k];
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:5,msg:`Merged ${merged.length} elements at offset ${off}`});
        return merged;
      }
      ms(a,0);
      s.push({a:[...a],cmp:[],hi:-1,su:a.length-1,l:5,msg:`‚úÖ Merge sort complete!`});
      return s;
    }
  },
  quick:{
    title:'quick_sort.py',name:'Quick Sort',
    best:'O(n log n)',avg:'O(n log n)',worst:'O(n¬≤)',space:'O(log n)',stable:'No',inplace:'Yes',
    bc:'good',ac:'good',wc:'bad',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">quick_sort</span>(arr, low, high):`,l:0},
      {t:`    <span class="kw">if</span> low < high:`,l:1},
      {t:`        pi = <span class="fn">partition</span>(arr, low, high)`,l:2},
      {t:`        <span class="fn">quick_sort</span>(arr, low, pi-<span class="num">1</span>)`,l:3},
      {t:`        <span class="fn">quick_sort</span>(arr, pi+<span class="num">1</span>, high)`,l:4},
      {t:`<span class="kw">def</span> <span class="fn">partition</span>(arr, low, high):`,l:5},
      {t:`    pivot = arr[high]; i = low - <span class="num">1</span>`,l:6},
      {t:`    <span class="kw">for</span> j <span class="kw">in</span> <span class="fn">range</span>(low, high):`,l:7},
      {t:`        <span class="kw">if</span> arr[j] <= pivot:`,l:8},
      {t:`            i+=<span class="num">1</span>; arr[i],arr[j]=arr[j],arr[i]`,l:9},
    ],
    gen(arr){
      const s=[],a=[...arr];
      function qs(lo,hi){
        if(lo<hi){const pi=pt(lo,hi);qs(lo,pi-1);qs(pi+1,hi);}
      }
      function pt(lo,hi){
        const pv=a[hi];let i=lo-1;
        s.push({a:[...a],cmp:[hi],hi:hi,su:-1,l:6,msg:`Pivot=${pv} at index ${hi}`});
        for(let j=lo;j<hi;j++){
          s.push({a:[...a],cmp:[j,hi],hi:hi,su:-1,l:8,msg:`arr[${j}]=${a[j]} <= pivot=${pv}?`});
          if(a[j]<=pv){i++;[a[i],a[j]]=[a[j],a[i]];s.push({a:[...a],cmp:[i,j],hi:hi,su:-1,l:9,msg:`Swap positions ${i} and ${j}`});}
        }
        [a[i+1],a[hi]]=[a[hi],a[i+1]];
        s.push({a:[...a],cmp:[],hi:i+1,su:-1,l:9,msg:`Pivot placed at index ${i+1}`});
        return i+1;
      }
      qs(0,a.length-1);
      s.push({a:[...a],cmp:[],hi:-1,su:a.length-1,l:4,msg:`‚úÖ Quick sort complete!`});
      return s;
    }
  },
  heap:{
    title:'heap_sort.py',name:'Heap Sort',
    best:'O(n log n)',avg:'O(n log n)',worst:'O(n log n)',space:'O(1)',stable:'No',inplace:'Yes',
    bc:'good',ac:'good',wc:'good',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">heap_sort</span>(arr):`,l:0},
      {t:`    n = <span class="fn">len</span>(arr)`,l:1},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(n//<span class="num">2</span>-<span class="num">1</span>, -<span class="num">1</span>, -<span class="num">1</span>):`,l:2},
      {t:`        <span class="fn">heapify</span>(arr, n, i)`,l:3},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(n-<span class="num">1</span>, <span class="num">0</span>, -<span class="num">1</span>):`,l:4},
      {t:`        arr[<span class="num">0</span>], arr[i] = arr[i], arr[<span class="num">0</span>]`,l:5},
      {t:`        <span class="fn">heapify</span>(arr, i, <span class="num">0</span>)`,l:6},
      {t:`<span class="kw">def</span> <span class="fn">heapify</span>(arr, n, i):`,l:7},
      {t:`    largest=i; l,r = <span class="num">2</span>*i+<span class="num">1</span>, <span class="num">2</span>*i+<span class="num">2</span>`,l:8},
      {t:`    <span class="kw">if</span> l<n <span class="kw">and</span> arr[l]>arr[largest]: largest=l`,l:9},
      {t:`    <span class="kw">if</span> largest!=i: arr[i],arr[largest]=arr[largest],arr[i]`,l:10},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      function heapify(sz,i){
        let lg=i,l=2*i+1,r=2*i+2;
        s.push({a:[...a],cmp:[i,l<sz?l:i],hi:lg,su:-1,l:9,msg:`Heapify at ${i}: check children ${l},${r}`});
        if(l<sz&&a[l]>a[lg])lg=l;
        if(r<sz&&a[r]>a[lg])lg=r;
        if(lg!==i){
          s.push({a:[...a],cmp:[i,lg],hi:lg,su:-1,l:10,msg:`Swap ${a[i]} and ${a[lg]} to maintain heap`});
          [a[i],a[lg]]=[a[lg],a[i]];
          heapify(sz,lg);
        }
      }
      for(let i=Math.floor(n/2)-1;i>=0;i--){s.push({a:[...a],cmp:[],hi:i,su:-1,l:3,msg:`Build heap: heapify at ${i}`});heapify(n,i);}
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:4,msg:`Max-heap built! Now extract elements.`});
      for(let i=n-1;i>0;i--){
        s.push({a:[...a],cmp:[0,i],hi:0,su:i,l:5,msg:`Swap root ${a[0]} with last unsorted ${a[i]}`});
        [a[0],a[i]]=[a[i],a[0]];
        heapify(i,0);
        s.push({a:[...a],cmp:[],hi:-1,su:i,l:6,msg:`Element ${a[i]} placed at position ${i}`});
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:6,msg:`‚úÖ Heap sort complete!`});
      return s;
    }
  },
  shell:{
    title:'shell_sort.py',name:'Shell Sort',
    best:'O(n log n)',avg:'O(n log¬≤ n)',worst:'O(n¬≤)',space:'O(1)',stable:'No',inplace:'Yes',
    bc:'good',ac:'ok',wc:'bad',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">shell_sort</span>(arr):`,l:0},
      {t:`    n, gap = <span class="fn">len</span>(arr), <span class="fn">len</span>(arr)//<span class="num">2</span>`,l:1},
      {t:`    <span class="kw">while</span> gap > <span class="num">0</span>:`,l:2},
      {t:`        <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(gap, n):`,l:3},
      {t:`            temp = arr[i]`,l:4},
      {t:`            j = i`,l:5},
      {t:`            <span class="kw">while</span> j>=gap <span class="kw">and</span> arr[j-gap]>temp:`,l:6},
      {t:`                arr[j] = arr[j-gap]; j -= gap`,l:7},
      {t:`            arr[j] = temp`,l:8},
      {t:`        gap //= <span class="num">2</span>`,l:9},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      let gap=Math.floor(n/2);
      while(gap>0){
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:2,msg:`Gap = ${gap}`});
        for(let i=gap;i<n;i++){
          let temp=a[i],j=i;
          s.push({a:[...a],cmp:[i],hi:i,su:-1,l:4,msg:`temp=${temp} at index ${i}`});
          while(j>=gap&&a[j-gap]>temp){
            s.push({a:[...a],cmp:[j,j-gap],hi:-1,su:-1,l:6,msg:`arr[${j-gap}]=${a[j-gap]} > temp=${temp}, shift`});
            a[j]=a[j-gap];j-=gap;
          }
          a[j]=temp;
          s.push({a:[...a],cmp:[],hi:j,su:-1,l:8,msg:`Placed temp=${temp} at ${j}`});
        }
        gap=Math.floor(gap/2);
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:9,msg:`‚úÖ Shell sort complete!`});
      return s;
    }
  },
  counting:{
    title:'counting_sort.py',name:'Counting Sort',
    best:'O(n+k)',avg:'O(n+k)',worst:'O(n+k)',space:'O(k)',stable:'Yes',inplace:'No',
    bc:'good',ac:'good',wc:'good',sc:'ok',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">counting_sort</span>(arr):`,l:0},
      {t:`    max_val = <span class="fn">max</span>(arr)`,l:1},
      {t:`    count = [<span class="num">0</span>] * (max_val + <span class="num">1</span>)`,l:2},
      {t:`    <span class="kw">for</span> num <span class="kw">in</span> arr:`,l:3},
      {t:`        count[num] += <span class="num">1</span>`,l:4},
      {t:`    result = []`,l:5},
      {t:`    <span class="kw">for</span> i, c <span class="kw">in</span> <span class="fn">enumerate</span>(count):`,l:6},
      {t:`        result.extend([i] * c)`,l:7},
      {t:`    <span class="kw">return</span> result`,l:8},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      const mx=Math.max(...a);
      const cnt=new Array(mx+1).fill(0);
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:1,msg:`max_val = ${mx}. Creating count array of size ${mx+1}`});
      for(let i=0;i<n;i++){
        cnt[a[i]]++;
        s.push({a:[...a],cmp:[i],hi:i,su:-1,l:4,msg:`Count arr[${i}]=${a[i]}. count[${a[i]}]=${cnt[a[i]]}`});
      }
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:5,msg:`Counting done! Rebuilding array from counts.`});
      const res=[];
      for(let i=0;i<=mx;i++){
        for(let c=0;c<cnt[i];c++)res.push(i);
      }
      for(let i=0;i<n;i++)a[i]=res[i];
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:7,msg:`‚úÖ Counting sort complete! O(n+k) time.`});
      return s;
    }
  },
  binary:{
    title:'binary_search.py',name:'Binary Search',
    best:'O(1)',avg:'O(log n)',worst:'O(log n)',space:'O(1)',stable:'N/A',inplace:'Yes',
    bc:'good',ac:'good',wc:'good',sc:'good',type:'search',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">binary_search</span>(arr, target):`,l:0},
      {t:`    left, right = <span class="num">0</span>, <span class="fn">len</span>(arr)-<span class="num">1</span>`,l:1},
      {t:`    <span class="kw">while</span> left <= right:`,l:2},
      {t:`        mid = (left + right) // <span class="num">2</span>`,l:3},
      {t:`        <span class="kw">if</span> arr[mid] == target:`,l:4},
      {t:`            <span class="kw">return</span> mid`,l:5},
      {t:`        <span class="kw">elif</span> arr[mid] < target:`,l:6},
      {t:`            left = mid + <span class="num">1</span>`,l:7},
      {t:`        <span class="kw">else</span>: right = mid - <span class="num">1</span>`,l:8},
      {t:`    <span class="kw">return</span> -<span class="num">1</span>`,l:9},
    ],
    gen(arr, userTarget){
      const s=[];
      const a=[...arr].sort((x,y)=>x-y);
      // Use user-specified target if given, else pick a random element
      const target = (userTarget !== null && userTarget !== undefined)
        ? userTarget
        : a[Math.floor(Math.random()*a.length)];
      let lo=0,hi=a.length-1;
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:1,msg:`Array sorted. Searching for target = ${target}`,range:[lo,hi],found:-1});
      let found = false;
      while(lo<=hi){
        const mid=Math.floor((lo+hi)/2);
        s.push({a:[...a],cmp:[mid],hi:mid,su:-1,l:3,msg:`mid = ${mid}, arr[mid] = ${a[mid]}, target = ${target}`,range:[lo,hi],found:-1});
        if(a[mid]===target){
          s.push({a:[...a],cmp:[mid],hi:mid,su:-1,l:5,msg:`‚úÖ Found ${target} at index ${mid}!`,range:[mid,mid],found:mid});
          found = true;
          break;
        }else if(a[mid]<target){
          s.push({a:[...a],cmp:[mid],hi:-1,su:-1,l:7,msg:`arr[mid]=${a[mid]} < ${target} ‚Üí search right half`,range:[mid+1,hi],found:-1});
          lo=mid+1;
        }else{
          s.push({a:[...a],cmp:[mid],hi:-1,su:-1,l:8,msg:`arr[mid]=${a[mid]} > ${target} ‚Üí search left half`,range:[lo,mid-1],found:-1});
          hi=mid-1;
        }
      }
      if(!found){
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:9,msg:`‚ùå Target ${target} not found in array! Returning -1.`,range:[-1,-1],found:-1});
      }
      return s;
    }
  },
  linear:{
    title:'linear_search.py',name:'Linear Search',
    best:'O(1)',avg:'O(n)',worst:'O(n)',space:'O(1)',stable:'N/A',inplace:'Yes',
    bc:'good',ac:'bad',wc:'bad',sc:'good',type:'search',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">linear_search</span>(arr, target):`,l:0},
      {t:`    <span class="kw">for</span> i, val <span class="kw">in</span> <span class="fn">enumerate</span>(arr):`,l:1},
      {t:`        <span class="kw">if</span> val == target:`,l:2},
      {t:`            <span class="kw">return</span> i`,l:3},
      {t:`    <span class="kw">return</span> -<span class="num">1</span>`,l:4},
    ],
    gen(arr, userTarget){
      const s=[],a=[...arr];
      // Use user-specified target if given, else pick a random element
      const target = (userTarget !== null && userTarget !== undefined)
        ? userTarget
        : a[Math.floor(Math.random()*a.length)];
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:0,msg:`Linear Search: looking for target = ${target} in unsorted array`,range:[0,a.length-1],found:-1});
      let found = false;
      for(let i=0;i<a.length;i++){
        s.push({a:[...a],cmp:[i],hi:i,su:-1,l:2,msg:`Check arr[${i}] = ${a[i]} == ${target}?`,range:[i,a.length-1],found:-1});
        if(a[i]===target){
          s.push({a:[...a],cmp:[i],hi:i,su:i,l:3,msg:`‚úÖ Found ${target} at index ${i}!`,range:[i,i],found:i});
          found = true;
          break;
        } else {
          s.push({a:[...a],cmp:[i],hi:-1,su:-1,l:1,msg:`arr[${i}] = ${a[i]} ‚â† ${target}, continue...`,range:[i+1,a.length-1],found:-1});
        }
      }
      if(!found){
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:4,msg:`‚ùå Target ${target} not found in array! Returning -1.`,range:[-1,-1],found:-1});
      }
      return s;
    }
  },
  radix:{
    title:'radix_sort.py',name:'Radix Sort',
    best:'O(nk)',avg:'O(nk)',worst:'O(nk)',space:'O(n+k)',stable:'Yes',inplace:'No',
    bc:'good',ac:'good',wc:'good',sc:'ok',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">counting_sort_exp</span>(arr, exp):`,l:0},
      {t:`    output=[<span class="num">0</span>]*<span class="fn">len</span>(arr); count=[<span class="num">0</span>]*<span class="num">10</span>`,l:1},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> arr: count[(i//<span class="num">exp</span>)%<span class="num">10</span>] += <span class="num">1</span>`,l:2},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(<span class="num">1</span>,<span class="num">10</span>): count[i]+=count[i-<span class="num">1</span>]`,l:3},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(<span class="fn">len</span>(arr)-<span class="num">1</span>,-<span class="num">1</span>,-<span class="num">1</span>):`,l:4},
      {t:`        idx=(arr[i]//<span class="num">exp</span>)%<span class="num">10</span>; output[count[idx]-<span class="num">1</span>]=arr[i]; count[idx]-=<span class="num">1</span>`,l:5},
      {t:`    <span class="kw">for</span> i,v <span class="kw">in</span> <span class="fn">enumerate</span>(output): arr[i]=v`,l:6},
      {t:`<span class="kw">def</span> <span class="fn">radix_sort</span>(arr):`,l:7},
      {t:`    m=<span class="fn">max</span>(arr); exp=<span class="num">1</span>`,l:8},
      {t:`    <span class="kw">while</span> m//<span class="num">exp</span> > <span class="num">0</span>: <span class="fn">counting_sort_exp</span>(arr,exp); exp*=<span class="num">10</span>`,l:9},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;
      const m=Math.max(...a);let exp=1;
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:8,msg:`Max element = ${m}, starting radix sort by digits`});
      while(Math.floor(m/exp)>0){
        const out=new Array(n).fill(0);const cnt=new Array(10).fill(0);
        for(let i=0;i<n;i++){const d=Math.floor(a[i]/exp)%10;cnt[d]++;s.push({a:[...a],cmp:[i],hi:-1,su:-1,l:2,msg:`Digit at exp=${exp}: arr[${i}]=${a[i]} ‚Üí digit ${d}`});}
        for(let i=1;i<10;i++)cnt[i]+=cnt[i-1];
        for(let i=n-1;i>=0;i--){const d=Math.floor(a[i]/exp)%10;out[cnt[d]-1]=a[i];cnt[d]--;}
        for(let i=0;i<n;i++)a[i]=out[i];
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:6,msg:`After sorting by exp=${exp}: [${a.join(', ')}]`});
        exp*=10;
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:9,msg:`‚úÖ Radix Sort complete! All digits processed.`});
      return s;
    }
  },
  tim:{
    title:'tim_sort.py',name:'Tim Sort',
    best:'O(n)',avg:'O(n log n)',worst:'O(n log n)',space:'O(n)',stable:'Yes',inplace:'No',
    bc:'good',ac:'good',wc:'good',sc:'ok',type:'sort',
    code:[
      {t:`<span class="cm"># Tim Sort = Insertion + Merge on runs</span>`,l:0},
      {t:`RUN = <span class="num">32</span>`,l:1},
      {t:`<span class="kw">def</span> <span class="fn">insertion_sort</span>(arr, l, r):`,l:2},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(l+<span class="num">1</span>,r+<span class="num">1</span>):`,l:3},
      {t:`        key=arr[i]; j=i-<span class="num">1</span>`,l:4},
      {t:`        <span class="kw">while</span> j>=l <span class="kw">and</span> arr[j]>key: arr[j+<span class="num">1</span>]=arr[j]; j-=<span class="num">1</span>`,l:5},
      {t:`        arr[j+<span class="num">1</span>]=key`,l:6},
      {t:`<span class="kw">def</span> <span class="fn">tim_sort</span>(arr):`,l:7},
      {t:`    n=<span class="fn">len</span>(arr)`,l:8},
      {t:`    <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(<span class="num">0</span>,n,RUN): <span class="fn">insertion_sort</span>(arr,i,<span class="fn">min</span>(i+RUN-<span class="num">1</span>,n-<span class="num">1</span>))`,l:9},
      {t:`    size=RUN`,l:10},
      {t:`    <span class="kw">while</span> size<n: <span class="cm"># merge runs</span>`,l:11},
    ],
    gen(arr){
      const RUN=Math.min(8,Math.floor(arr.length/2)||1);
      const s=[],a=[...arr],n=a.length;
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:8,msg:`Tim Sort: RUN size = ${RUN}. First insertion sort each run.`});
      for(let i=0;i<n;i+=RUN){
        const r=Math.min(i+RUN-1,n-1);
        for(let k=i+1;k<=r;k++){
          const key=a[k];let j=k-1;
          s.push({a:[...a],cmp:[k,j>=0?j:0],hi:k,su:i-1,l:4,msg:`Insertion: key=${key} in run [${i}..${r}]`});
          while(j>=i&&a[j]>key){a[j+1]=a[j];j--;}
          a[j+1]=key;
          s.push({a:[...a],cmp:[],hi:j+1,su:i-1,l:6,msg:`Placed ${key} at position ${j+1}`});
        }
        s.push({a:[...a],cmp:[],hi:-1,su:r,l:9,msg:`Run [${i}..${r}] insertion-sorted`});
      }
      let size=RUN;
      while(size<n){
        for(let l=0;l<n;l+=2*size){
          const mid=Math.min(l+size-1,n-1);const r=Math.min(l+2*size-1,n-1);
          if(mid<r){
            const L=a.slice(l,mid+1),R=a.slice(mid+1,r+1);
            let i=0,j=0,k=l;
            while(i<L.length&&j<R.length){
              s.push({a:[...a],cmp:[l+i,mid+1+j],hi:-1,su:-1,l:11,msg:`Merge runs: ${L[i]} vs ${R[j]}`});
              if(L[i]<=R[j])a[k++]=L[i++];else a[k++]=R[j++];
            }
            while(i<L.length)a[k++]=L[i++];
            while(j<R.length)a[k++]=R[j++];
            s.push({a:[...a],cmp:[],hi:-1,su:r,l:11,msg:`Merged run [${l}..${r}]`});
          }
        }
        size*=2;
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:11,msg:`‚úÖ Tim Sort complete!`});
      return s;
    }
  },
  cycle:{
    title:'cycle_sort.py',name:'Cycle Sort',
    best:'O(n¬≤)',avg:'O(n¬≤)',worst:'O(n¬≤)',space:'O(1)',stable:'No',inplace:'Yes',
    bc:'bad',ac:'bad',wc:'bad',sc:'good',type:'sort',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">cycle_sort</span>(arr):`,l:0},
      {t:`    writes=<span class="num">0</span>`,l:1},
      {t:`    <span class="kw">for</span> cycle_start <span class="kw">in</span> <span class="fn">range</span>(<span class="fn">len</span>(arr)-<span class="num">1</span>):`,l:2},
      {t:`        item=arr[cycle_start]; pos=cycle_start`,l:3},
      {t:`        <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(cycle_start+<span class="num">1</span>,<span class="fn">len</span>(arr)):`,l:4},
      {t:`            <span class="kw">if</span> arr[i]<item: pos+=<span class="num">1</span>`,l:5},
      {t:`        <span class="kw">while</span> item != arr[pos]: <span class="cm"># place item</span>`,l:6},
      {t:`            arr[pos],item = item,arr[pos]; writes+=<span class="num">1</span>`,l:7},
      {t:`    <span class="kw">return</span> writes`,l:8},
    ],
    gen(arr){
      const s=[],a=[...arr],n=a.length;let writes=0;
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:1,msg:`Cycle Sort: minimizes writes to memory. Writes = ${writes}`});
      for(let cs=0;cs<n-1;cs++){
        let item=a[cs],pos=cs;
        s.push({a:[...a],cmp:[cs],hi:cs,su:cs-1,l:3,msg:`Cycle start ${cs}: item=${item}`});
        for(let i=cs+1;i<n;i++){s.push({a:[...a],cmp:[i,cs],hi:cs,su:cs-1,l:5,msg:`Count elements < ${item}`});if(a[i]<item)pos++;}
        if(pos===cs)continue;
        while(item===a[pos])pos++;
        [a[pos],item]=[item,a[pos]];writes++;
        s.push({a:[...a],cmp:[pos],hi:pos,su:cs-1,l:7,msg:`Write ${a[pos]} to position ${pos}. Total writes=${writes}`});
        while(pos!==cs){
          pos=cs;
          for(let i=cs+1;i<n;i++)if(a[i]<item)pos++;
          while(item===a[pos])pos++;
          [a[pos],item]=[item,a[pos]];writes++;
          s.push({a:[...a],cmp:[pos],hi:pos,su:cs-1,l:7,msg:`Continue cycle: write to pos ${pos}. Writes=${writes}`});
        }
        s.push({a:[...a],cmp:[],hi:-1,su:cs,l:7,msg:`Cycle ${cs} complete. Position ${cs} sorted.`});
      }
      s.push({a:[...a],cmp:[],hi:-1,su:n-1,l:8,msg:`‚úÖ Cycle Sort done! Total writes = ${writes} (minimum possible)`});
      return s;
    }
  },
  jump:{
    title:'jump_search.py',name:'Jump Search',
    best:'O(1)',avg:'O(‚àön)',worst:'O(‚àön)',space:'O(1)',stable:'N/A',inplace:'Yes',
    bc:'good',ac:'good',wc:'good',sc:'good',type:'search',
    code:[
      {t:`<span class="kw">import</span> math`,l:0},
      {t:`<span class="kw">def</span> <span class="fn">jump_search</span>(arr, target):`,l:1},
      {t:`    n=<span class="fn">len</span>(arr); step=<span class="fn">int</span>(<span class="fn">math.sqrt</span>(n))`,l:2},
      {t:`    prev=<span class="num">0</span>`,l:3},
      {t:`    <span class="kw">while</span> arr[<span class="fn">min</span>(step,n)-<span class="num">1</span>] < target:`,l:4},
      {t:`        prev=step; step+=<span class="fn">int</span>(<span class="fn">math.sqrt</span>(n))`,l:5},
      {t:`        <span class="kw">if</span> prev >= n: <span class="kw">return</span> -<span class="num">1</span>`,l:6},
      {t:`    <span class="kw">while</span> arr[prev] < target:`,l:7},
      {t:`        prev+=<span class="num">1</span>`,l:8},
      {t:`        <span class="kw">if</span> prev==<span class="fn">min</span>(step,n): <span class="kw">return</span> -<span class="num">1</span>`,l:9},
      {t:`    <span class="kw">if</span> arr[prev]==target: <span class="kw">return</span> prev`,l:10},
      {t:`    <span class="kw">return</span> -<span class="num">1</span>`,l:11},
    ],
    gen(arr, userTarget){
      const s=[],a=[...arr].sort((x,y)=>x-y);const n=a.length;
      const step=Math.floor(Math.sqrt(n));
      // Use user-specified target if given, else pick a random element
      const target = (userTarget !== null && userTarget !== undefined)
        ? userTarget
        : a[Math.floor(Math.random()*n)];
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:2,msg:`Array sorted. Jump size = ‚àö${n} ‚âà ${step}. Target = ${target}`,range:[0,n-1],found:-1});
      let prev=0, curr=step;
      // Jump phase
      while(curr <= n && a[Math.min(curr,n)-1] < target){
        s.push({a:[...a],cmp:[Math.min(curr,n)-1],hi:-1,su:-1,l:4,
          msg:`Jump: arr[${Math.min(curr,n)-1}] = ${a[Math.min(curr,n)-1]} < ${target}, jump forward`,
          range:[prev, Math.min(curr,n)-1],found:-1});
        prev=curr; curr+=step;
        if(prev>=n){
          s.push({a:[...a],cmp:[],hi:-1,su:-1,l:6,msg:`‚ùå Jumped past end of array. Target ${target} not found!`,range:[-1,-1],found:-1});
          return s;
        }
      }
      // Linear search in block [prev .. min(curr,n)-1]
      const blockEnd = Math.min(curr, n);
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:7,
        msg:`Block found [${prev}..${blockEnd-1}]. Now linear search in this block.`,
        range:[prev, blockEnd-1],found:-1});
      let found = false;
      for(let i=prev; i<blockEnd; i++){
        s.push({a:[...a],cmp:[i],hi:i,su:-1,l:8,
          msg:`Check arr[${i}] = ${a[i]} == ${target}?`,
          range:[prev, blockEnd-1],found:-1});
        if(a[i]===target){
          s.push({a:[...a],cmp:[i],hi:i,su:i,l:10,
            msg:`‚úÖ Found ${target} at index ${i}!`,range:[i,i],found:i});
          found = true;
          break;
        }
      }
      if(!found){
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:11,
          msg:`‚ùå Target ${target} not found in array! Returning -1.`,range:[-1,-1],found:-1});
      }
      return s;
    }
  },
  interpolation:{
    title:'interpolation_search.py',name:'Interpolation Search',
    best:'O(1)',avg:'O(log log n)',worst:'O(n)',space:'O(1)',stable:'N/A',inplace:'Yes',
    bc:'good',ac:'good',wc:'bad',sc:'good',type:'search',
    code:[
      {t:`<span class="kw">def</span> <span class="fn">interpolation_search</span>(arr, target):`,l:0},
      {t:`    lo, hi = <span class="num">0</span>, <span class="fn">len</span>(arr)-<span class="num">1</span>`,l:1},
      {t:`    <span class="kw">while</span> lo<=hi <span class="kw">and</span> target>=arr[lo] <span class="kw">and</span> target<=arr[hi]:`,l:2},
      {t:`        pos = lo + (target-arr[lo])*(hi-lo)//(arr[hi]-arr[lo])`,l:3},
      {t:`        <span class="kw">if</span> arr[pos]==target: <span class="kw">return</span> pos`,l:4},
      {t:`        <span class="kw">if</span> arr[pos]<target: lo=pos+<span class="num">1</span>`,l:5},
      {t:`        <span class="kw">else</span>: hi=pos-<span class="num">1</span>`,l:6},
      {t:`    <span class="kw">return</span> -<span class="num">1</span>`,l:7},
    ],
    gen(arr, userTarget){
      const s=[],a=[...arr].sort((x,y)=>x-y);const n=a.length;
      // Use user-specified target if given, else pick a random element
      const target = (userTarget !== null && userTarget !== undefined)
        ? userTarget
        : a[Math.floor(Math.random()*n)];
      let lo=0,hi=n-1;
      s.push({a:[...a],cmp:[],hi:-1,su:-1,l:1,msg:`Array sorted. Interpolation Search for target = ${target}. Formula predicts position.`,range:[lo,hi],found:-1});
      let found = false;
      while(lo<=hi && target>=a[lo] && target<=a[hi]){
        if(a[hi]===a[lo]){
          // All equal ‚Äî check if it's the target
          if(a[lo]===target){
            s.push({a:[...a],cmp:[lo],hi:lo,su:lo,l:4,msg:`‚úÖ Found ${target} at index ${lo}!`,range:[lo,lo],found:lo});
            found = true;
          }
          break;
        }
        const pos = lo + Math.floor(((target-a[lo])*(hi-lo))/(a[hi]-a[lo]));
        // Guard against out-of-bounds
        if(pos < 0 || pos >= n) break;
        s.push({a:[...a],cmp:[pos],hi:pos,su:-1,l:3,
          msg:`pos = ${lo} + (${target}-${a[lo]})√ó(${hi}-${lo})/(${a[hi]}-${a[lo]}) = ${pos}, arr[${pos}] = ${a[pos]}`,
          range:[lo,hi],found:-1});
        if(a[pos]===target){
          s.push({a:[...a],cmp:[pos],hi:pos,su:pos,l:4,msg:`‚úÖ Found ${target} at index ${pos}!`,range:[pos,pos],found:pos});
          found = true;
          break;
        }
        if(a[pos]<target){
          s.push({a:[...a],cmp:[pos],hi:-1,su:-1,l:5,msg:`arr[${pos}]=${a[pos]} < ${target} ‚Üí search right`,range:[pos+1,hi],found:-1});
          lo=pos+1;
        } else {
          s.push({a:[...a],cmp:[pos],hi:-1,su:-1,l:6,msg:`arr[${pos}]=${a[pos]} > ${target} ‚Üí search left`,range:[lo,pos-1],found:-1});
          hi=pos-1;
        }
      }
      if(!found){
        s.push({a:[...a],cmp:[],hi:-1,su:-1,l:7,msg:`‚ùå Target ${target} not found in array! Returning -1.`,range:[-1,-1],found:-1});
      }
      return s;
    }
  }
};

// ============================================================
// ALGO RECAP DATA
// ============================================================
const ALGO_RECAP = {
  selection:{
    def:'Selection Sort is a simple comparison-based sorting algorithm that divides the list into a sorted and unsorted part.',
    how:'1Ô∏è‚É£ Find the smallest element in the unsorted part ‚Üí 2Ô∏è‚É£ Swap it with the first unsorted element ‚Üí 3Ô∏è‚É£ Move the sorted boundary right ‚Üí Repeat until done.',
    tags:['In-Place','O(n¬≤)','Unstable','Simple'],
    tagColors:['#00f5c4','#ff6b6b','#ffd93d','#a78bfa'],
    hindiDef:'Selection Sort ek simple sorting algorithm hai jo array ko sorted aur unsorted do bhagon mein baantati hai.',
    hindiHow:'Pehle unsorted hisse mein sabse chhota element dhundho, phir usse pehle unsorted element se swap karo, aur sorted boundary ko aage badhao.'
  },
  bubble:{
    def:'Bubble Sort repeatedly compares adjacent elements and swaps them if they are in the wrong order, "bubbling" larger elements to the right.',
    how:'1Ô∏è‚É£ Compare arr[j] and arr[j+1] ‚Üí 2Ô∏è‚É£ Swap if arr[j] > arr[j+1] ‚Üí 3Ô∏è‚É£ Largest element "bubbles" to end ‚Üí 4Ô∏è‚É£ Repeat for n-1 passes.',
    tags:['In-Place','O(n¬≤) worst','O(n) best','Stable'],
    tagColors:['#00f5c4','#ff6b6b','#00f5c4','#a78bfa'],
    hindiDef:'Bubble Sort mein adjacent elements ko compare kiya jaata hai aur agar galat order mein hain toh swap kiya jaata hai. Bade elements bubble ki tarah end mein jaate hain.',
    hindiHow:'Har pass mein do adjacent elements compare karo. Agar arr[j] bada hai arr[j+1] se toh swap karo. Yeh process n-1 baar dohrao.'
  },
  insertion:{
    def:'Insertion Sort builds the sorted array one item at a time by inserting each new element into its correct position among the already-sorted elements.',
    how:'1Ô∏è‚É£ Pick arr[i] as key ‚Üí 2Ô∏è‚É£ Compare with sorted part (arr[0..i-1]) ‚Üí 3Ô∏è‚É£ Shift larger elements right ‚Üí 4Ô∏è‚É£ Insert key in correct position.',
    tags:['In-Place','O(n) best','Stable','Good for small data'],
    tagColors:['#00f5c4','#00f5c4','#a78bfa','#ffd93d'],
    hindiDef:'Insertion Sort ek element ko ek baar mein sorted position mein insert karta hai, bilkul taas ke patte sort karne ki tarah.',
    hindiHow:'Har element ko key ki tarah uthao, sorted hisse se compare karo, bade elements ko right shift karo, aur key ko sahi jagah insert karo.'
  },
  merge:{
    def:'Merge Sort is a divide and conquer algorithm that recursively splits the array in half, sorts each half, then merges them back together.',
    how:'1Ô∏è‚É£ Divide array into two halves ‚Üí 2Ô∏è‚É£ Recursively sort each half ‚Üí 3Ô∏è‚É£ Merge both sorted halves into one sorted array.',
    tags:['Divide & Conquer','O(n log n)','Stable','Extra Space O(n)'],
    tagColors:['#a78bfa','#00f5c4','#a78bfa','#ffd93d'],
    hindiDef:'Merge Sort ek divide and conquer algorithm hai jo array ko baar baar aadha karta hai, phir sort karke wapas merge karta hai.',
    hindiHow:'Array ko do aadhe hisson mein baanto. Phir recursively dono halves ko sort karo. Ant mein dono sorted halves ko merge karo.'
  },
  quick:{
    def:'Quick Sort picks a pivot element and partitions the array around it, placing elements smaller than pivot on left and larger on right.',
    how:'1Ô∏è‚É£ Choose pivot (usually last element) ‚Üí 2Ô∏è‚É£ Partition: move smaller elements left, larger right ‚Üí 3Ô∏è‚É£ Recursively sort left & right subarrays.',
    tags:['Divide & Conquer','O(n log n) avg','In-Place','Unstable'],
    tagColors:['#a78bfa','#00f5c4','#00f5c4','#ffd93d'],
    hindiDef:'Quick Sort ek pivot element chunkar array ko do bhagon mein baantata hai - chhote elements baayein, bade daayein.',
    hindiHow:'Ek pivot chunno (aksar aakhri element). Chhote elements ko pivot ke baayein aur bade elements ko daayein le jao. Phir recursively dono subarrays sort karo.'
  },
  heap:{
    def:'Heap Sort uses a binary heap data structure to sort. It first builds a max-heap, then repeatedly extracts the maximum element.',
    how:'1Ô∏è‚É£ Build max-heap from array ‚Üí 2Ô∏è‚É£ Swap root (max) with last element ‚Üí 3Ô∏è‚É£ Heapify remaining elements ‚Üí 4Ô∏è‚É£ Repeat until sorted.',
    tags:['In-Place','O(n log n)','Unstable','Heap DS'],
    tagColors:['#00f5c4','#00f5c4','#ffd93d','#a78bfa'],
    hindiDef:'Heap Sort ek binary heap structure use karke sort karta hai. Pehle max-heap banata hai, phir bada element nikalte rehta hai.',
    hindiHow:'Pehle array se max-heap banao. Phir root (sabse bada element) ko aakhri element se swap karo. Baaki array ko heapify karo. Yeh repeat karo.'
  },
  shell:{
    def:'Shell Sort is an improved insertion sort that allows elements far apart to be compared and swapped first, reducing the total number of movements.',
    how:'1Ô∏è‚É£ Choose gap (e.g., n/2) ‚Üí 2Ô∏è‚É£ Compare elements at gap distance, swap if needed ‚Üí 3Ô∏è‚É£ Reduce gap ‚Üí 4Ô∏è‚É£ Repeat until gap = 1 (like insertion sort).',
    tags:['In-Place','O(n log n) to O(n¬≤)','Unstable','Gap Sequence'],
    tagColors:['#00f5c4','#ffd93d','#ffd93d','#a78bfa'],
    hindiDef:'Shell Sort, Insertion Sort ka improved version hai. Pehle door door ke elements compare karta hai, phir gap kam karta jaata hai.',
    hindiHow:'Ek gap chunno (n/2). Gap doori ke elements compare karo aur swap karo. Phir gap ko aadha karo. Gap=1 hone tak repeat karo - last step insertion sort hai.'
  },
  counting:{
    def:'Counting Sort counts the occurrences of each element and uses this count to place elements in their sorted position. Only works for integers.',
    how:'1Ô∏è‚É£ Count frequency of each value ‚Üí 2Ô∏è‚É£ Calculate prefix sums ‚Üí 3Ô∏è‚É£ Place each element at its correct output index ‚Üí Result is sorted!',
    tags:['Non-Comparison','O(n+k)','Stable','Integer Only'],
    tagColors:['#a78bfa','#00f5c4','#a78bfa','#ff6b6b'],
    hindiDef:'Counting Sort har element ki frequency count karta hai aur iss count se elements ko sorted position mein rakhta hai. Sirf integers ke liye hai.',
    hindiHow:'Har value ki frequency count karo. Phir prefix sum calculate karo. Har element ko uski sahi output index par rakho. Result sorted hoga!'
  },
  radix:{
    def:'Radix Sort sorts numbers digit by digit, from least significant to most significant digit, using counting sort as a subroutine for each digit.',
    how:'1Ô∏è‚É£ Find max element ‚Üí 2Ô∏è‚É£ Sort by units digit ‚Üí 3Ô∏è‚É£ Sort by tens digit ‚Üí 4Ô∏è‚É£ Sort by hundreds digit ‚Üí Continue until all digits processed.',
    tags:['Non-Comparison','O(nk)','Stable','Digit-by-Digit'],
    tagColors:['#a78bfa','#00f5c4','#a78bfa','#ffd93d'],
    hindiDef:'Radix Sort numbers ko digit-by-digit sort karta hai, sabse chhote digit se shuru karke sabse bade digit tak.',
    hindiHow:'Max element dhundho. Phir units digit se sort karo. Phir tens digit se sort karo. Aise har digit ke liye repeat karo.'
  },
  tim:{
    def:'Tim Sort is a hybrid sorting algorithm derived from Merge Sort and Insertion Sort, designed to perform well on real-world data with naturally occurring runs.',
    how:'1Ô∏è‚É£ Divide array into small "runs" (size 32) ‚Üí 2Ô∏è‚É£ Insertion sort each run ‚Üí 3Ô∏è‚É£ Merge runs using merge sort logic.',
    tags:['Hybrid','O(n log n)','Stable','Used in Python/Java'],
    tagColors:['#a78bfa','#00f5c4','#a78bfa','#00f5c4'],
    hindiDef:'Tim Sort ek hybrid algorithm hai jo Merge Sort aur Insertion Sort dono se milkar bana hai. Python aur Java mein default sort yahi hai!',
    hindiHow:'Array ko chhote "runs" (size 32) mein baanto. Har run ko Insertion Sort se sort karo. Phir sabhi runs ko Merge Sort ki tarah merge karo.'
  },
  cycle:{
    def:'Cycle Sort is an in-place, unstable sorting algorithm that minimizes the number of writes to memory, making it ideal for storage-optimized systems.',
    how:'1Ô∏è‚É£ For each element, count how many elements are smaller ‚Üí 2Ô∏è‚É£ That gives its correct position ‚Üí 3Ô∏è‚É£ Place it there ‚Üí 4Ô∏è‚É£ Continue cycle until element is back at start.',
    tags:['In-Place','Minimum Writes','Unstable','O(n¬≤)'],
    tagColors:['#00f5c4','#a78bfa','#ffd93d','#ff6b6b'],
    hindiDef:'Cycle Sort ek aise sorting algorithm hai jo memory mein writes ki sankhya kam se kam rakhta hai. Storage ke liye best hai.',
    hindiHow:'Har element ke liye gino ki kitne elements usse chhote hain - yahi uski sahi position hai. Wahan place karo aur cycle complete karo.'
  },
  binary:{
    def:'Binary Search is a search algorithm that finds the position of a target value in a sorted array by repeatedly halving the search interval.',
    how:'1Ô∏è‚É£ Array must be sorted ‚Üí 2Ô∏è‚É£ Check middle element ‚Üí 3Ô∏è‚É£ If target < mid, search left half ‚Üí 4Ô∏è‚É£ If target > mid, search right half ‚Üí Repeat.',
    tags:['Sorted Array Required','O(log n)','Efficient','Divide & Conquer'],
    tagColors:['#ff6b6b','#00f5c4','#00f5c4','#a78bfa'],
    hindiDef:'Binary Search ek sorted array mein target dhundta hai, baar baar search space ko aadha karta jaata hai.',
    hindiHow:'Array sorted hona chahiye. Middle element check karo. Agar target chhota hai toh left half mein dhundho. Agar bada hai toh right half mein. Repeat karo.'
  },
  linear:{
    def:'Linear Search checks each element of the array one by one from the beginning until it finds the target value or reaches the end.',
    how:'1Ô∏è‚É£ Start from index 0 ‚Üí 2Ô∏è‚É£ Compare each element with target ‚Üí 3Ô∏è‚É£ If match found, return index ‚Üí 4Ô∏è‚É£ If end reached without match, return -1.',
    tags:['Works on Unsorted','O(n)','Simple','Brute Force'],
    tagColors:['#00f5c4','#ffd93d','#a78bfa','#ff6b6b'],
    hindiDef:'Linear Search array ke har element ko ek ek karke check karta hai jab tak target na mile ya array khatam na ho.',
    hindiHow:'Index 0 se shuru karo. Har element ko target se compare karo. Match mile toh index return karo. Array khatam ho jaye toh -1 return karo.'
  },
  jump:{
    def:'Jump Search works on sorted arrays by jumping ‚àön steps at a time to find the block containing the target, then doing linear search in that block.',
    how:'1Ô∏è‚É£ Calculate step = ‚àön ‚Üí 2Ô∏è‚É£ Jump by step until element > target ‚Üí 3Ô∏è‚É£ Linear search in previous block ‚Üí Return index if found.',
    tags:['Sorted Array Required','O(‚àön)','Better than Linear','Block-Based'],
    tagColors:['#ff6b6b','#00f5c4','#00f5c4','#a78bfa'],
    hindiDef:'Jump Search sorted array mein ‚àön steps jump karta hai target ka block dhundhne ke liye, phir us block mein linear search karta hai.',
    hindiHow:'Step = ‚àön calculate karo. Tab tak jump karo jab tak element target se bada na ho. Phus us block mein linear search karo.'
  },
  interpolation:{
    def:'Interpolation Search is an improved binary search that works on uniformly distributed sorted arrays, estimating the probable position of the target using a formula.',
    how:'1Ô∏è‚É£ Estimate position using formula: pos = lo + (target-arr[lo])√ó(hi-lo)/(arr[hi]-arr[lo]) ‚Üí 2Ô∏è‚É£ Compare and narrow range ‚Üí Repeat.',
    tags:['Uniform Distribution','O(log log n) avg','Sorted Required','Smart Estimation'],
    tagColors:['#ffd93d','#00f5c4','#ff6b6b','#a78bfa'],
    hindiDef:'Interpolation Search uniformly distributed sorted arrays ke liye Binary Search ka improved version hai. Target ki position formula se estimate karta hai.',
    hindiHow:'Position = lo + (target-arr[lo]) √ó (hi-lo) / (arr[hi]-arr[lo]). Yeh formula target ki probable location predict karta hai.'
  }
};

// ============================================================
// INTERVIEW QUESTIONS DATABASE ‚Äî 400+ Questions
// ============================================================
const INTERVIEW_QS = {
  array:[
    // EASY
    {q:'Find the maximum element in an array',d:'easy',companies:'Google, Amazon, Microsoft',hint:'Traverse once, keep track of max'},
    {q:'Reverse an array in place',d:'easy',companies:'Amazon, Facebook',hint:'Two pointer approach: swap arr[l] and arr[r]'},
    {q:'Find the second largest element',d:'easy',companies:'TCS, Infosys, Wipro',hint:'Single pass, track first and second max'},
    {q:'Check if array is sorted',d:'easy',companies:'Accenture, Cognizant',hint:'Check if arr[i] <= arr[i+1] for all i'},
    {q:'Remove duplicates from sorted array',d:'easy',companies:'Google, LeetCode',hint:'Two pointer i and j, move j only when arr[i]!=arr[j]'},
    {q:'Move all zeros to the end',d:'easy',companies:'Amazon, Snapchat',hint:'Two pointer: keep non-zero elements at front'},
    {q:'Find the missing number in 1 to N',d:'easy',companies:'Microsoft, Goldman Sachs',hint:'Expected sum = N*(N+1)/2, subtract actual sum'},
    {q:'Count occurrences of a given element',d:'easy',companies:'TCS, Wipro',hint:'Simple traversal with counter'},
    {q:'Find the sum of all elements',d:'easy',companies:'All',hint:'Linear traversal, accumulate sum'},
    {q:'Left rotate array by k positions',d:'easy',companies:'Amazon, Paytm',hint:'Reverse entire array, then reverse first k and last n-k'},
    {q:'Find the intersection of two arrays',d:'easy',companies:'Google, Amazon',hint:'Use hash set for one array, check elements of other'},
    {q:'Find the union of two arrays',d:'easy',companies:'Microsoft, Infosys',hint:'Hash set combining elements of both arrays'},
    {q:'Check if array contains a duplicate',d:'easy',companies:'LeetCode, Amazon',hint:'Use hash set, return true if element already in set'},
    {q:'Find minimum in rotated sorted array',d:'easy',companies:'Google, Uber',hint:'Binary search, check which half is sorted'},
    {q:'Find Kth largest element',d:'easy',companies:'Amazon, Facebook, LinkedIn',hint:'Sort and return arr[n-k], or use min-heap of size k'},
    {q:'Two Sum - find pair with given sum',d:'easy',companies:'Google, Amazon, Microsoft',hint:'Hash map: for each num, check if (target-num) exists'},
    {q:'Best time to buy and sell stock',d:'easy',companies:'Amazon, Microsoft, Goldman Sachs',hint:'Track min price so far, update max profit'},
    {q:'Count pairs with given sum',d:'easy',companies:'Google, Samsung',hint:'Sort + two pointer OR hash map'},
    {q:'Find leader elements in array',d:'easy',companies:'Infosys, TCS',hint:'Traverse right to left, track max from right'},
    {q:'Check if array is a subset of another',d:'easy',companies:'Microsoft, Wipro',hint:'Hash set of parent array, verify all subset elements'},
    // MEDIUM
    {q:'3Sum - find all triplets with zero sum',d:'medium',companies:'Amazon, Google, Facebook',hint:'Sort, fix one element, two pointer for remaining two'},
    {q:'Maximum subarray sum (Kadane\'s Algorithm)',d:'medium',companies:'Amazon, Microsoft, Adobe',hint:'Keep running sum, reset to 0 if negative, track max'},
    {q:'Merge two sorted arrays without extra space',d:'medium',companies:'Google, Amazon',hint:'Start comparing from end of both arrays'},
    {q:'Next permutation',d:'medium',companies:'Amazon, Microsoft',hint:'Find rightmost ascent, swap, reverse suffix'},
    {q:'Trapping rainwater problem',d:'medium',companies:'Amazon, Google, Goldman Sachs',hint:'Precompute left_max and right_max arrays'},
    {q:'Product of array except self',d:'medium',companies:'Amazon, Facebook, LeetCode',hint:'Left product array √ó right product array, no division'},
    {q:'Longest subarray with sum K',d:'medium',companies:'Amazon, Flipkart',hint:'Prefix sum + hash map'},
    {q:'Maximum product subarray',d:'medium',companies:'Amazon, LinkedIn',hint:'Track max and min at each position (negatives flip)'},
    {q:'Find all duplicates in array',d:'medium',companies:'Google, Amazon',hint:'Mark visited indices by negating arr[abs(arr[i])-1]'},
    {q:'Sort array of 0s, 1s, and 2s (Dutch Flag)',d:'medium',companies:'Amazon, Microsoft',hint:'3 pointers: low, mid, high - swap accordingly'},
    {q:'Merge overlapping intervals',d:'medium',companies:'Google, Amazon, Facebook',hint:'Sort by start, merge if curr.start <= prev.end'},
    {q:'Rotate image / matrix by 90 degrees',d:'medium',companies:'Amazon, Microsoft, Google',hint:'Transpose then reverse each row'},
    {q:'Search in a 2D matrix',d:'medium',companies:'Amazon, Google',hint:'Binary search treating matrix as 1D array'},
    {q:'Spiral order matrix traversal',d:'medium',companies:'Amazon, Microsoft',hint:'4 boundaries: top, bottom, left, right - shrink each pass'},
    {q:'Set matrix zeroes',d:'medium',companies:'Amazon, Microsoft',hint:'Use first row and column as markers to avoid extra space'},
    {q:'Find pivot index (equilibrium index)',d:'medium',companies:'Amazon, LeetCode',hint:'Total sum - left sum - arr[i] = right sum'},
    {q:'Subarray with given sum (positive numbers)',d:'medium',companies:'Amazon, Google',hint:'Sliding window: expand right, shrink left when sum > target'},
    {q:'Find the majority element (>n/2 times)',d:'medium',companies:'Amazon, Google, Boyer-Moore',hint:'Boyer-Moore Voting Algorithm'},
    {q:'Jump Game - can you reach the end?',d:'medium',companies:'Amazon, Google',hint:'Track max reachable index, check if i <= maxReach'},
    {q:'Container with most water',d:'medium',companies:'Amazon, LeetCode',hint:'Two pointer from ends, move shorter height inward'},
    {q:'Minimum number of platforms required',d:'medium',companies:'Amazon, Paytm, OYO',hint:'Sort arrivals and departures separately, merge step'},
    {q:'Find if there is a subarray with sum 0',d:'medium',companies:'Amazon, Samsung',hint:'Prefix sum: if same prefix sum seen twice, subarray sum = 0'},
    {q:'Chocolate distribution problem',d:'medium',companies:'Amazon, Flipkart',hint:'Sort, find min difference in window of size m'},
    {q:'Minimum jumps to reach end',d:'medium',companies:'Amazon, Google',hint:'Greedy: track current reach and max reach in each step'},
    // HARD
    {q:'Largest rectangle in histogram',d:'hard',companies:'Amazon, Google, Netflix',hint:'Stack-based: for each bar, find left and right smaller bars'},
    {q:'Median of two sorted arrays',d:'hard',companies:'Google, Amazon, Microsoft',hint:'Binary search on smaller array to find correct partition'},
    {q:'Count inversions in array',d:'hard',companies:'Amazon, Goldman Sachs',hint:'Modified merge sort: count inversions during merge step'},
    {q:'Smallest window containing all characters',d:'hard',companies:'Amazon, Google',hint:'Sliding window with character frequency map'},
    {q:'Maximum sum rectangle in 2D matrix',d:'hard',companies:'Google, Amazon',hint:'Kadane\'s on compressed column sums'},
    {q:'Find k-th smallest element in sorted matrix',d:'hard',companies:'Google, Amazon',hint:'Binary search on value range, count elements <= mid'},
  ],
  linkedlist:[
    // EASY
    {q:'Reverse a linked list',d:'easy',companies:'Amazon, Google, Microsoft',hint:'Three pointers: prev, curr, next'},
    {q:'Find middle of linked list',d:'easy',companies:'Amazon, Facebook',hint:'Slow and fast pointer (Floyd\'s)'},
    {q:'Detect a cycle in linked list',d:'easy',companies:'Amazon, Microsoft',hint:'Floyd\'s cycle detection: slow=1 step, fast=2 steps'},
    {q:'Find length of linked list',d:'easy',companies:'TCS, Infosys',hint:'Traverse until NULL, count nodes'},
    {q:'Delete a node given only that node',d:'easy',companies:'Amazon, LeetCode',hint:'Copy next node\'s data, delete next node'},
    {q:'Remove Nth node from end',d:'easy',companies:'Amazon, Google',hint:'Two pointer: advance first pointer by N, then move both'},
    {q:'Merge two sorted linked lists',d:'easy',companies:'Amazon, Microsoft',hint:'Compare heads, take smaller one, recurse/iterate'},
    {q:'Check if linked list is palindrome',d:'easy',companies:'Amazon, Facebook',hint:'Find middle, reverse second half, compare'},
    {q:'Count nodes in linked list',d:'easy',companies:'All',hint:'Simple traversal'},
    {q:'Search for an element in linked list',d:'easy',companies:'TCS, Wipro',hint:'Traverse and compare each node\'s data'},
    {q:'Delete all occurrences of given key',d:'easy',companies:'Amazon, Microsoft',hint:'Keep prev pointer, skip matching nodes'},
    {q:'Intersection of two linked lists',d:'easy',companies:'Amazon, Google',hint:'After reaching end, redirect to head of other list'},
    // MEDIUM
    {q:'Detect and remove loop in linked list',d:'medium',companies:'Amazon, Microsoft, Samsung',hint:'Floyd\'s to detect, then find entry point and break'},
    {q:'Flatten a multilevel doubly linked list',d:'medium',companies:'Amazon, Microsoft',hint:'Recursively flatten child lists and connect'},
    {q:'Add two numbers represented as linked lists',d:'medium',companies:'Amazon, Google',hint:'Add digit by digit with carry, handle different lengths'},
    {q:'Clone a linked list with random pointers',d:'medium',companies:'Amazon, Microsoft',hint:'HashMap: old node ‚Üí new node, then copy random pointers'},
    {q:'Sort linked list using merge sort',d:'medium',companies:'Amazon, Google',hint:'Find middle, split, sort halves, merge'},
    {q:'LRU Cache implementation',d:'medium',companies:'Amazon, Google, Microsoft',hint:'HashMap + Doubly Linked List for O(1) get and put'},
    {q:'Rotate linked list by K positions',d:'medium',companies:'Amazon, LeetCode',hint:'Find tail, connect to head, cut at (n-k%n)th node'},
    {q:'Delete middle node of linked list',d:'medium',companies:'Amazon, Google',hint:'Find middle with slow-fast, delete it'},
    {q:'Reorder linked list L0‚ÜíLn‚ÜíL1‚ÜíLn-1',d:'medium',companies:'Amazon, LeetCode',hint:'Find middle, reverse second half, merge alternately'},
    {q:'Swap nodes in pairs',d:'medium',companies:'Amazon, Microsoft',hint:'Swap each pair\'s data or rearrange pointers'},
    // HARD
    {q:'Reverse nodes in k-groups',d:'hard',companies:'Amazon, Google',hint:'Reverse k nodes at a time, connect groups'},
    {q:'Sort linked list in O(n log n)',d:'hard',companies:'Google, Amazon',hint:'Merge sort on linked list'},
    {q:'Find starting node of loop',d:'hard',companies:'Amazon, Adobe',hint:'Floyd\'s: after meeting, reset one pointer to head, advance both 1 step'},
    {q:'Serialize and deserialize linked list',d:'hard',companies:'Amazon, Google',hint:'Write NULL markers, parse with queue'},
  ],
  stack:[
    // EASY
    {q:'Implement stack using arrays',d:'easy',companies:'TCS, Infosys',hint:'Use array with top pointer'},
    {q:'Implement stack using linked list',d:'easy',companies:'Amazon, Microsoft',hint:'Insert and delete from head for O(1) push/pop'},
    {q:'Check balanced parentheses',d:'easy',companies:'Amazon, Google, Microsoft',hint:'Push open brackets, pop and match on close brackets'},
    {q:'Reverse a string using stack',d:'easy',companies:'TCS, Wipro',hint:'Push all chars, pop to build reversed string'},
    {q:'Evaluate postfix expression',d:'easy',companies:'Amazon, Microsoft',hint:'Push operands, on operator pop two, compute, push result'},
    {q:'Next Greater Element',d:'easy',companies:'Amazon, Google, Paytm',hint:'Stack: pop elements smaller than current, they get current as NGE'},
    {q:'Next Smaller Element',d:'easy',companies:'Amazon, Flipkart',hint:'Similar to NGE but for smaller elements'},
    {q:'Sort a stack using recursion',d:'easy',companies:'Amazon, Goldman Sachs',hint:'Remove top, sort remaining, insert in sorted position'},
    {q:'Minimum element in stack in O(1)',d:'easy',companies:'Amazon, Google',hint:'Maintain auxiliary min-stack alongside main stack'},
    // MEDIUM
    {q:'Implement two stacks in one array',d:'medium',companies:'Amazon, Microsoft',hint:'One from left, one from right, meet in middle'},
    {q:'The Celebrity Problem',d:'medium',companies:'Amazon, Google',hint:'Stack: if A knows B, A can\'t be celebrity; else B can\'t'},
    {q:'Largest rectangle in histogram',d:'medium',companies:'Amazon, Google',hint:'Maintain stack of indices, calculate area when popping'},
    {q:'Stock span problem',d:'medium',companies:'Amazon, Goldman Sachs, Morgan Stanley',hint:'Stack stores indices, span = current index - index of last greater element'},
    {q:'Decode string (e.g. 3[a2[bc]])',d:'medium',companies:'Amazon, Google',hint:'Two stacks: one for counts, one for strings'},
    {q:'Implement queue using two stacks',d:'medium',companies:'Amazon, Microsoft, Google',hint:'Stack1 for push, Stack2 for pop (transfer lazily)'},
    {q:'Maximum area in binary matrix',d:'medium',companies:'Amazon, Netflix',hint:'Apply histogram approach row by row'},
    {q:'Remove k digits to get smallest number',d:'medium',companies:'Google, Amazon',hint:'Monotone stack: pop when curr < top'},
    // HARD
    {q:'Implement browser forward/backward history',d:'hard',companies:'Amazon, Google',hint:'Two stacks: back and forward history'},
    {q:'Evaluate infix expression',d:'hard',companies:'Amazon, Microsoft',hint:'Two stacks: operators and operands, handle precedence'},
    {q:'Maximum width ramp',d:'hard',companies:'Amazon, Google',hint:'Decreasing stack + scan from right'},
  ],
  queue:[
    // EASY
    {q:'Implement queue using arrays',d:'easy',companies:'TCS, Infosys',hint:'Circular array with front and rear pointers'},
    {q:'Implement queue using linked list',d:'easy',companies:'Amazon, Wipro',hint:'Enqueue at tail, dequeue from head'},
    {q:'Reverse a queue',d:'easy',companies:'Amazon, Samsung',hint:'Push all to stack, pop back to queue'},
    {q:'Generate binary numbers 1 to N using queue',d:'easy',companies:'Amazon, Microsoft',hint:'BFS-like: enqueue "1", for each dequeued s, enqueue s+"0" and s+"1"'},
    {q:'First non-repeating character in stream',d:'easy',companies:'Amazon, Paytm',hint:'Queue of candidates + char frequency map'},
    {q:'Level order traversal of binary tree',d:'easy',companies:'Amazon, Google, Microsoft',hint:'Classic BFS using queue'},
    // MEDIUM
    {q:'Sliding window maximum',d:'medium',companies:'Amazon, Google',hint:'Deque (monotone): remove elements out of window from front, smaller from back'},
    {q:'Implement circular queue',d:'medium',companies:'Amazon, Microsoft',hint:'Modular arithmetic for front/rear wraparound'},
    {q:'K queues in one array',d:'medium',companies:'Amazon, Google',hint:'Similar to k stacks: use next[] array to track free nodes'},
    {q:'Interleave first and second halves of queue',d:'medium',companies:'Amazon, Flipkart',hint:'Split, push first half to stack, interleave from queue and stack'},
    {q:'Implement Deque (double-ended queue)',d:'medium',companies:'Amazon, Microsoft',hint:'Doubly linked list or circular array with both-end operations'},
    {q:'BFS shortest path in unweighted graph',d:'medium',companies:'Google, Amazon, Facebook',hint:'Queue-based BFS, track visited and distance'},
    // HARD
    {q:'LRU Cache using queue and hash map',d:'hard',companies:'Amazon, Google, Microsoft',hint:'Deque for order, hashmap for O(1) lookup'},
    {q:'Rotten oranges - minimum time to rot all',d:'hard',companies:'Amazon, Google',hint:'Multi-source BFS from all initially rotten oranges'},
    {q:'0-1 BFS (weights 0 or 1)',d:'hard',companies:'Google, Codeforces',hint:'Deque: push 0-weight to front, 1-weight to back'},
  ],
  tree:[
    {q:'Inorder traversal of binary tree',d:'easy',companies:'Amazon, Google',hint:'Left ‚Üí Root ‚Üí Right recursively or with stack'},
    {q:'Preorder traversal of binary tree',d:'easy',companies:'Amazon, Microsoft',hint:'Root ‚Üí Left ‚Üí Right'},
    {q:'Postorder traversal of binary tree',d:'easy',companies:'Amazon, Google',hint:'Left ‚Üí Right ‚Üí Root'},
    {q:'Height of binary tree',d:'easy',companies:'All',hint:'1 + max(height(left), height(right))'},
    {q:'Check if binary tree is balanced',d:'easy',companies:'Amazon, Google',hint:'Height of left and right should differ by at most 1'},
    {q:'Count nodes in binary tree',d:'easy',companies:'TCS, Infosys',hint:'1 + count(left) + count(right)'},
    {q:'Find LCA (Lowest Common Ancestor)',d:'medium',companies:'Amazon, Google, Facebook',hint:'If both nodes in same subtree, recurse; else root is LCA'},
    {q:'Binary tree to doubly linked list',d:'medium',companies:'Amazon, Microsoft',hint:'Inorder traversal while updating prev pointer'},
    {q:'Level order traversal (BFS)',d:'easy',companies:'Amazon, Google',hint:'Queue-based BFS, process level by level'},
    {q:'Diameter of binary tree',d:'medium',companies:'Amazon, Facebook',hint:'For each node: leftHeight + rightHeight, take max'},
    {q:'Vertical order traversal',d:'medium',companies:'Amazon, Microsoft',hint:'DFS with (col, row) coordinates, group by column'},
    {q:'Serialize and deserialize binary tree',d:'hard',companies:'Amazon, Google, Facebook',hint:'BFS with NULL markers for serialization'},
    {q:'Construct BST from preorder traversal',d:'medium',companies:'Amazon, Google',hint:'Range-based insertion'},
    {q:'Validate BST',d:'medium',companies:'Amazon, Google',hint:'Pass min/max range for each node'},
    {q:'Lowest Common Ancestor in BST',d:'easy',companies:'Amazon, Google',hint:'If both < root go left, both > root go right, else root is LCA'},
    {q:'Kth smallest in BST',d:'medium',companies:'Amazon, Google',hint:'Inorder traversal gives sorted order'},
    {q:'Top view of binary tree',d:'medium',companies:'Amazon, Flipkart',hint:'Level order traversal with horizontal distance'},
    {q:'Right view of binary tree',d:'medium',companies:'Amazon, Paytm',hint:'Level order: last node of each level'},
    {q:'Path sum - does path with given sum exist',d:'easy',companies:'Amazon, Google',hint:'DFS: subtract node value, check if leaf with sum=0'},
    {q:'All root to leaf paths',d:'medium',companies:'Amazon, Google',hint:'DFS with path vector, add to result at leaf'},
    {q:'Count BST nodes in range [lo, hi]',d:'medium',companies:'Amazon, Microsoft',hint:'If root in range count 1 + left + right; else check side'},
    {q:'Binary tree maximum path sum',d:'hard',companies:'Amazon, Google, Facebook',hint:'At each node: max path through it = node + max(0,left) + max(0,right)'},
    {q:'Word search in matrix (DFS)',d:'hard',companies:'Amazon, Google, Microsoft',hint:'DFS with backtracking from each cell'},
    {q:'Recover BST (two swapped nodes)',d:'hard',companies:'Amazon, Google',hint:'Inorder traversal: find two out-of-order nodes and swap'},
  ],
  graph:[
    {q:'Breadth First Search (BFS)',d:'easy',companies:'Amazon, Google, Microsoft',hint:'Queue-based level-by-level traversal'},
    {q:'Depth First Search (DFS)',d:'easy',companies:'Amazon, Google',hint:'Stack or recursion, mark visited'},
    {q:'Detect cycle in undirected graph',d:'easy',companies:'Amazon, Microsoft',hint:'DFS: if visited and not parent ‚Üí cycle'},
    {q:'Detect cycle in directed graph',d:'medium',companies:'Amazon, Google, Facebook',hint:'DFS with recursion stack (three colors: white/gray/black)'},
    {q:'Topological sort',d:'medium',companies:'Amazon, Google, Facebook',hint:'DFS-based: push to stack after visiting all neighbors'},
    {q:'Find number of connected components',d:'easy',companies:'Amazon, Google',hint:'DFS/BFS from each unvisited node, count starts'},
    {q:'Check if bipartite graph (2-colorable)',d:'medium',companies:'Amazon, Google, Microsoft',hint:'BFS: alternate colors, if same color neighbor ‚Üí not bipartite'},
    {q:'Shortest path in unweighted graph',d:'easy',companies:'Amazon, Google',hint:'BFS gives shortest path in unweighted graph'},
    {q:'Dijkstra\'s shortest path algorithm',d:'medium',companies:'Google, Amazon, Uber, Lyft',hint:'Min-heap (priority queue), greedy: always process nearest unvisited'},
    {q:'Bellman-Ford algorithm',d:'medium',companies:'Google, Amazon',hint:'Relax all edges V-1 times, detect negative cycles in Vth pass'},
    {q:'Floyd-Warshall all-pairs shortest path',d:'medium',companies:'Google, Amazon',hint:'DP: dist[i][j] = min(dist[i][j], dist[i][k]+dist[k][j])'},
    {q:'Kruskal\'s Minimum Spanning Tree',d:'medium',companies:'Amazon, Google',hint:'Sort edges, add if no cycle (Union-Find)'},
    {q:'Prim\'s Minimum Spanning Tree',d:'medium',companies:'Amazon, Google',hint:'Greedy: always add min weight edge connecting visited to unvisited'},
    {q:'Find bridges in graph (Tarjan)',d:'hard',companies:'Google, Amazon',hint:'Tarjan\'s: use discovery time and low value'},
    {q:'Find articulation points',d:'hard',companies:'Google, Amazon',hint:'Tarjan\'s bridge-finding with child count check'},
    {q:'Strongly Connected Components (Kosaraju)',d:'hard',companies:'Google, Amazon',hint:'1st DFS fill stack, transpose graph, 2nd DFS in stack order'},
    {q:'Word Ladder (BFS, min transformations)',d:'hard',companies:'Amazon, Google, Facebook',hint:'BFS treating each word as node, edge if differ by 1 char'},
    {q:'Number of islands',d:'medium',companies:'Amazon, Google, Microsoft',hint:'DFS/BFS from each unvisited \'1\', mark all connected as visited'},
    {q:'Clone a graph',d:'medium',companies:'Amazon, Facebook',hint:'BFS/DFS with HashMap: old‚Üínew node mapping'},
    {q:'Course Schedule (can you finish?)',d:'medium',companies:'Amazon, Google, Airbnb',hint:'Detect cycle in directed graph (topological sort)'},
  ],
  hash:[
    {q:'Two Sum using hash map',d:'easy',companies:'Google, Amazon, All',hint:'Hash map: for each x, check if (target-x) exists'},
    {q:'Group anagrams together',d:'medium',companies:'Amazon, Google, Facebook',hint:'Sort each string as key in hash map'},
    {q:'Longest consecutive sequence',d:'medium',companies:'Amazon, Google, Facebook',hint:'Hash set: only start from num if num-1 not in set'},
    {q:'Subarray sum equals K',d:'medium',companies:'Amazon, Google',hint:'Prefix sum hash map: count[prefixSum-k]'},
    {q:'First non-repeating character',d:'easy',companies:'Amazon, Microsoft',hint:'Linked hash map to preserve order'},
    {q:'Find all pairs with given difference',d:'easy',companies:'Amazon, Flipkart',hint:'Hash set: for each x, check if x+k exists'},
    {q:'Four Sum problem',d:'medium',companies:'Amazon, Google',hint:'Two Sum with nested loops: fix two, two-sum the rest'},
    {q:'Find top K frequent elements',d:'medium',companies:'Amazon, Google, Facebook',hint:'Frequency map + bucket sort or min-heap'},
    {q:'Longest subarray with equal 0s and 1s',d:'medium',companies:'Amazon, Google',hint:'Convert 0‚Üí-1, prefix sum hash map (find first occurrence of each sum)'},
    {q:'Count distinct elements in every window',d:'medium',companies:'Amazon, Samsung',hint:'Sliding window with frequency hash map'},
    {q:'Minimum window substring',d:'hard',companies:'Amazon, Google, Facebook',hint:'Sliding window + character count map'},
    {q:'Largest subarray with 0 sum',d:'medium',companies:'Amazon, Morgan Stanley',hint:'Hash map of prefix sums, track first occurrence index'},
    {q:'Check if two strings are anagrams',d:'easy',companies:'Amazon, Google',hint:'Character frequency count comparison'},
    {q:'Valid sudoku check',d:'medium',companies:'Amazon, Google',hint:'Hash sets for rows, columns, and 3√ó3 boxes'},
    {q:'Isomorphic strings',d:'easy',companies:'Amazon, LinkedIn',hint:'Two hash maps: char‚Üíchar mapping both ways'},
    {q:'Longest palindrome from letters',d:'easy',companies:'Amazon, Google',hint:'Count chars: sum even counts + 1 if any odd count exists'},
    {q:'Happy number',d:'easy',companies:'Amazon, LeetCode',hint:'Hash set to detect cycle in digit-square-sum sequence'},
  ],
  heap:[
    {q:'Find Kth largest element',d:'easy',companies:'Amazon, Google, Facebook',hint:'Min-heap of size k: push all, pop when size>k'},
    {q:'Merge K sorted arrays',d:'medium',companies:'Amazon, Google, Microsoft',hint:'Min-heap of (value, arrayIndex, elementIndex)'},
    {q:'Find median from data stream',d:'hard',companies:'Amazon, Google, Facebook',hint:'Two heaps: maxHeap for lower half, minHeap for upper half'},
    {q:'K closest points to origin',d:'medium',companies:'Amazon, Google, Facebook',hint:'Max-heap of size k by distance, or partial quicksort'},
    {q:'Top K frequent words',d:'medium',companies:'Amazon, Google',hint:'Frequency map + min-heap of size k'},
    {q:'Sliding window maximum',d:'hard',companies:'Amazon, Google',hint:'Deque (decreasing): pop smaller from back, pop out of window from front'},
    {q:'Task scheduler - minimum time',d:'medium',companies:'Amazon, Google',hint:'Max-heap of frequencies, cool-down simulation'},
    {q:'Connect ropes with minimum cost',d:'medium',companies:'Amazon, Google',hint:'Min-heap: always pick two smallest ropes to connect'},
    {q:'Sort characters by frequency',d:'medium',companies:'Amazon, LeetCode',hint:'Frequency map + max-heap, build sorted string'},
    {q:'Reorganize string (no adjacent same)',d:'medium',companies:'Amazon, Google',hint:'Max-heap: always pick most frequent non-matching char'},
    {q:'Find smallest range covering K lists',d:'hard',companies:'Google, Amazon, Facebook',hint:'Min-heap with one element from each list, track max seen'},
    {q:'Kth smallest element in sorted matrix',d:'medium',companies:'Google, Amazon',hint:'Binary search on value or min-heap approach'},
  ]
};

// ============================================================
// IQ (Interview Questions) State & Functions
// ============================================================
let iqCurrentCat='array', iqCurrentDiff='all', iqSearchTerm='', iqShown=15;

function iqCat(cat, el){
  iqCurrentCat=cat; iqShown=15; iqSearchTerm='';
  document.getElementById('iq-search').value='';
  document.querySelectorAll('#iq-cat-row .ds-op-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  iqRender();
}

function iqFilter(diff, el){
  iqCurrentDiff=diff; iqShown=15;
  document.querySelectorAll('#iq-cat-row .ds-sub-btn,button[id^="iq-"]').forEach(b=>{
    if(b.id==='iq-all'||b.id==='iq-easy'||b.id==='iq-med'||b.id==='iq-hard') b.classList.remove('active');
  });
  el.classList.add('active');
  iqRender();
}

function iqSearch(term){ iqSearchTerm=term.toLowerCase(); iqShown=15; iqRender(); }

function iqLoadMore(){ iqShown+=15; iqRender(); }

function iqRender(){
  const allQs = INTERVIEW_QS[iqCurrentCat] || [];
  let filtered = allQs.filter(q=>{
    const diffMatch = iqCurrentDiff==='all' || q.d===iqCurrentDiff;
    const searchMatch = !iqSearchTerm || q.q.toLowerCase().includes(iqSearchTerm) || (q.companies||'').toLowerCase().includes(iqSearchTerm) || (q.hint||'').toLowerCase().includes(iqSearchTerm);
    return diffMatch && searchMatch;
  });
  const total = filtered.length;
  const shown = filtered.slice(0, iqShown);
  // Store current filtered list for index-based access
  iqvFilteredQs = shown;
  const diffColors = {easy:'#00f5c4',medium:'#ffd93d',hard:'#ff6b6b'};
  const diffLabels = {easy:'üü¢ Easy',medium:'üü° Medium',hard:'üî¥ Hard'};
  document.getElementById('iq-count-label').textContent = `Showing ${Math.min(iqShown,total)} of ${total} questions`;
  document.getElementById('iq-list').innerHTML = shown.map((q,i)=>`
    <div data-iqcard="1" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;transition:border .15s;" onmouseover="this.style.borderColor='${diffColors[q.d]}40'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span style="font-family:'Space Mono',monospace;font-size:.6rem;background:${diffColors[q.d]}20;color:${diffColors[q.d]};border:1px solid ${diffColors[q.d]}50;padding:2px 9px;border-radius:99px;font-weight:700;">${diffLabels[q.d]}</span>
        <span style="font-family:'Space Mono',monospace;font-size:.82rem;color:var(--text);font-weight:700;flex:1;cursor:pointer;" onclick="iqToggle(this.closest('[data-iqcard]'))">${q.q}</span>
        <button onclick="openIqVizByIdx(${i})" style="background:rgba(0,245,196,.12);border:1.5px solid rgba(0,245,196,.3);color:var(--accent);font-family:'Space Mono',monospace;font-size:.65rem;padding:5px 12px;border-radius:7px;cursor:pointer;white-space:nowrap;font-weight:700;">‚ñ∂ Visualize</button>
        <span style="font-size:.75rem;color:var(--muted);cursor:pointer;" onclick="iqToggle(this.closest('[data-iqcard]'))">‚ñæ</span>
      </div>
      <div class="iq-detail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
        <div style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--accent4);margin-bottom:5px;">üè¢ Companies: <span style="color:var(--muted)">${q.companies||'Various'}</span></div>
        <div style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--accent);margin-bottom:5px;">üí° Hint: <span style="color:var(--text)">${q.hint||'Think carefully...'}</span></div>
      </div>
    </div>`).join('');
  const loadBtn = document.getElementById('iq-load-more');
  loadBtn.style.display = total > iqShown ? 'inline-block' : 'none';
}

let iqvFilteredQs = [];
function openIqVizByIdx(i){ openIqViz(iqvFilteredQs[i]); }

function iqToggle(el){
  if(!el) return;
  const detail = el.querySelector('.iq-detail');
  const arr = el.querySelector('span[style*="color:var(--muted)"]');
  if(!detail) return;
  if(detail.style.display==='none'){detail.style.display='block';if(arr)arr.textContent='‚ñ¥';}
  else{detail.style.display='none';if(arr)arr.textContent='‚ñæ';}
}

// ============================================================
// IQ VISUALIZATION ENGINE
// ============================================================

let iqvSteps=[], iqvIdx=0, iqvPlaying=false, iqvIv=null, iqvCurrentQ=null;

// ---- Problem type detector ----
function detectProblemType(q){
  const t = (q.q+' '+(q.hint||'')).toLowerCase();
  if(t.includes('two pointer')||t.includes('two sum')||t.includes('pair')||t.includes('container')||t.includes('trapping')) return 'twopointer';
  if(t.includes('sliding window')||t.includes('subarray')||t.includes('longest subarray')||t.includes('window')) return 'sliding';
  if(t.includes('hash')||t.includes('frequency')||t.includes('duplicate')||t.includes('count occur')||t.includes('majority')) return 'hashmap';
  if(t.includes('stack')||t.includes('histogram')||t.includes('parenthes')||t.includes('valid bracket')) return 'stack';
  if(t.includes('binary search')||t.includes('sorted array')||t.includes('rotated')||t.includes('kth')) return 'binarysearch';
  if(t.includes('kadane')||t.includes('maximum subarray')||t.includes('max subarray')) return 'kadane';
  if(t.includes('reverse')||t.includes('palindrome')||t.includes('flip')) return 'reverse';
  if(t.includes('linked list')||t.includes('slow')||t.includes('fast pointer')||t.includes('cycle')||t.includes('floyd')) return 'linkedlist';
  if(t.includes('prefix')||t.includes('equilibrium')||t.includes('product array')) return 'prefix';
  if(t.includes('sort')||t.includes('merge')||t.includes('dutch flag')||t.includes('0s, 1s')) return 'sorting';
  if(t.includes('max')||t.includes('min')||t.includes('second largest')||t.includes('leader')) return 'traversal';
  return 'traversal'; // default
}

// ---- Code templates per problem type ----
const IQV_CODE = {
  twopointer:`def two_pointer(arr, target):
    left, right = 0, len(arr) - 1
    while left < right:
        curr_sum = arr[left] + arr[right]
        if curr_sum == target:
            return (left, right)   # Found!
        elif curr_sum < target:
            left += 1              # Need bigger
        else:
            right -= 1             # Need smaller
    return -1`,

  sliding:`def sliding_window(arr, target):
    left = 0
    curr_sum = 0
    for right in range(len(arr)):
        curr_sum += arr[right]    # Expand window
        while curr_sum > target:
            curr_sum -= arr[left] # Shrink window
            left += 1
        if curr_sum == target:
            return (left, right)  # Window found!
    return -1`,

  hashmap:`def hash_solution(arr):
    freq = {}
    result = []
    for val in arr:
        freq[val] = freq.get(val, 0) + 1
        if freq[val] > 1:         # Duplicate!
            result.append(val)
    return freq`,

  stack:`def stack_solution(arr):
    stack = []
    result = []
    for i, val in enumerate(arr):
        while stack and arr[stack[-1]] < val:
            idx = stack.pop()     # Found answer
            result.append(idx)
        stack.append(i)
    return result`,

  binarysearch:`def binary_search(arr, target):
    lo, hi = 0, len(arr) - 1
    while lo <= hi:
        mid = (lo + hi) // 2
        if arr[mid] == target:
            return mid             # Found!
        elif arr[mid] < target:
            lo = mid + 1           # Search right
        else:
            hi = mid - 1           # Search left
    return -1`,

  kadane:`def kadane(arr):
    max_sum = arr[0]
    curr_sum = arr[0]
    start = end = 0
    for i in range(1, len(arr)):
        if curr_sum < 0:
            curr_sum = arr[i]      # Reset
            start = i
        else:
            curr_sum += arr[i]     # Extend
        if curr_sum > max_sum:
            max_sum = curr_sum
            end = i
    return max_sum, arr[start:end+1]`,

  reverse:`def reverse_array(arr):
    left, right = 0, len(arr) - 1
    while left < right:
        arr[left], arr[right] = arr[right], arr[left]
        left += 1
        right -= 1
    return arr`,

  linkedlist:`class Node:
    def __init__(self, val):
        self.val = val
        self.next = None

def reverse_list(head):
    prev = None
    curr = head
    while curr:
        nxt = curr.next   # Save next
        curr.next = prev  # Reverse link
        prev = curr       # Move prev
        curr = nxt        # Move curr
    return prev`,

  prefix:`def prefix_sum(arr):
    prefix = [0] * (len(arr) + 1)
    for i in range(len(arr)):
        prefix[i+1] = prefix[i] + arr[i]
    # Query: sum(l, r) = prefix[r+1] - prefix[l]
    return prefix`,

  sorting:`def sort_012(arr):
    lo, mid, hi = 0, 0, len(arr) - 1
    while mid <= hi:
        if arr[mid] == 0:
            arr[lo], arr[mid] = arr[mid], arr[lo]
            lo += 1; mid += 1
        elif arr[mid] == 1:
            mid += 1
        else:
            arr[mid], arr[hi] = arr[hi], arr[mid]
            hi -= 1
    return arr`,

  traversal:`def find_max(arr):
    max_val = arr[0]
    max_idx = 0
    for i in range(1, len(arr)):
        if arr[i] > max_val:   # New max found
            max_val = arr[i]
            max_idx = i
    return max_val, max_idx`,
};

const IQV_APPROACH = {
  twopointer: 'Sort the array. Use two pointers starting at both ends. Move them inward based on comparison with target. Time: O(n log n) for sort + O(n) scan.',
  sliding: 'Use a sliding window: expand right to include more elements, shrink left when window is invalid. Find optimal window in O(n) time.',
  hashmap: 'Use a hash map to store frequency or visited elements. Gives O(1) lookup. Convert O(n¬≤) brute force to O(n) time with O(n) space.',
  stack: 'Use a monotonic stack. Maintain elements in sorted order in stack. Pop when a greater/smaller element is found. O(n) time, each element pushed/popped once.',
  binarysearch: 'Array is sorted (or can be partitioned). Binary search halves the search space each step. O(log n) time vs O(n) linear scan.',
  kadane: "Kadane's Algorithm: extend the current subarray if positive, reset if current sum goes negative. Track global maximum. O(n) time, O(1) space.",
  reverse: 'Two-pointer swap approach. Mirror elements from both ends toward center. O(n/2) swaps = O(n) time, O(1) space in-place.',
  linkedlist: 'Use slow/fast pointers or prev/curr/next pointers for linked list manipulation. O(n) time, O(1) extra space.',
  prefix: 'Precompute prefix sums in O(n). Then any range sum query [l,r] = prefix[r+1]-prefix[l] in O(1). Trade space for time.',
  sorting: '3-way Dutch National Flag partitioning. Three pointers lo/mid/hi maintain invariant: [0..lo-1]=0s, [lo..mid-1]=1s, [hi+1..n-1]=2s.',
  traversal: 'Linear scan keeping track of current best. Single pass O(n), O(1) extra space. Classic greedy approach.',
};

const IQV_COMPLEXITY = {
  twopointer: 'Time: O(n log n) | Space: O(1)',
  sliding:    'Time: O(n) | Space: O(1)',
  hashmap:    'Time: O(n) | Space: O(n)',
  stack:      'Time: O(n) | Space: O(n)',
  binarysearch:'Time: O(log n) | Space: O(1)',
  kadane:     'Time: O(n) | Space: O(1)',
  reverse:    'Time: O(n) | Space: O(1)',
  linkedlist: 'Time: O(n) | Space: O(1)',
  prefix:     'Time: O(n) build, O(1) query | Space: O(n)',
  sorting:    'Time: O(n) | Space: O(1)',
  traversal:  'Time: O(n) | Space: O(1)',
};

// ---- Step generators per problem type ----
function iqvGenSteps(type, arr){
  const s=[];
  const a=[...arr];
  const n=a.length;

  if(type==='twopointer'){
    const sorted=[...a].sort((x,y)=>x-y);
    const target=sorted[0]+sorted[sorted.length-1]; // use sum of extremes as target
    s.push({a:[...sorted],l:-1,r:-1,hi:-1,msg:`Two Pointer: find pair summing to ${target}. Sort + two pointers.`,type});
    let l=0,r=sorted.length-1;
    while(l<r){
      const sum=sorted[l]+sorted[r];
      s.push({a:[...sorted],l,r,hi:-1,found:-1,msg:`arr[${l}]=${sorted[l]} + arr[${r}]=${sorted[r]} = ${sum} vs target=${target}`,type});
      if(sum===target){s.push({a:[...sorted],l,r,hi:-1,found:l,msg:`‚úÖ Found pair! (${sorted[l]}, ${sorted[r]}) sum to ${target}`,type});break;}
      else if(sum<target){s.push({a:[...sorted],l,r:r,hi:-1,found:-1,msg:`${sum} < ${target} ‚Üí move left pointer right`,type});l++;}
      else{s.push({a:[...sorted],l,r,hi:-1,found:-1,msg:`${sum} > ${target} ‚Üí move right pointer left`,type});r--;}
    }
    if(l>=r) s.push({a:[...sorted],l:-1,r:-1,hi:-1,found:-2,msg:`No pair found for target=${target}`,type});
  }

  else if(type==='sliding'){
    const target=Math.floor(a.slice(0,Math.floor(n/2)).reduce((x,y)=>x+y,0)); // sum of first half as target
    s.push({a:[...a],l:0,r:-1,hi:-1,msg:`Sliding Window: find subarray summing to ~${target}`,type});
    let l=0,curr=0;
    for(let r=0;r<n;r++){
      curr+=a[r];
      s.push({a:[...a],l,r,hi:-1,sum:curr,msg:`Expand right: window=[${l}..${r}], sum=${curr}`,type});
      while(curr>target&&l<=r){
        curr-=a[l];
        s.push({a:[...a],l,r,hi:-1,sum:curr,msg:`Sum ${curr+a[l-1]||curr}>target, shrink left: window=[${l+1}..${r}], sum=${curr}`,type});
        l++;
      }
      if(curr===target){s.push({a:[...a],l,r,hi:-1,found:l,msg:`‚úÖ Found window [${l}..${r}]! Sum=${curr}`,type});break;}
    }
  }

  else if(type==='hashmap'){
    s.push({a:[...a],hi:-1,msg:`Hash Map: count frequencies of each element`,type,freq:{}});
    const freq={};
    const dups=[];
    for(let i=0;i<n;i++){
      freq[a[i]]=(freq[a[i]]||0)+1;
      const isDup=freq[a[i]]>1;
      if(isDup&&!dups.includes(a[i]))dups.push(a[i]);
      s.push({a:[...a],hi:i,found:isDup?i:-1,msg:`freq[${a[i]}]=${freq[a[i]]}${isDup?' ‚Üí DUPLICATE!':''}`,type,freq:{...freq}});
    }
    s.push({a:[...a],hi:-1,msg:`‚úÖ Done! Duplicates: ${dups.length?dups.join(', '):'none'}. Map built in O(n).`,type,freq:{...freq}});
  }

  else if(type==='binarysearch'){
    const sorted=[...a].sort((x,y)=>x-y);
    const target=sorted[Math.floor(n*0.6)];
    s.push({a:[...sorted],lo:0,hi:n-1,mid:-1,msg:`Binary Search: find target=${target} in sorted array`,type});
    let lo=0,rhi=n-1;
    while(lo<=rhi){
      const mid=Math.floor((lo+rhi)/2);
      s.push({a:[...sorted],lo,hi:rhi,mid,msg:`lo=${lo}, hi=${rhi}, mid=${mid}, arr[mid]=${sorted[mid]}`,type});
      if(sorted[mid]===target){s.push({a:[...sorted],lo,hi:rhi,mid,found:mid,msg:`‚úÖ Found target=${target} at index ${mid}!`,type});break;}
      else if(sorted[mid]<target){s.push({a:[...sorted],lo:mid+1,hi:rhi,mid,msg:`${sorted[mid]} < ${target} ‚Üí search right half`,type});lo=mid+1;}
      else{s.push({a:[...sorted],lo,hi:mid-1,mid,msg:`${sorted[mid]} > ${target} ‚Üí search left half`,type});rhi=mid-1;}
    }
    if(lo>rhi)s.push({a:[...sorted],lo:-1,hi:-1,mid:-1,found:-2,msg:`Target ${target} not found`,type});
  }

  else if(type==='kadane'){
    s.push({a:[...a],hi:-1,maxSoFar:a[0],currMax:a[0],msg:`Kadane's Algorithm: find maximum subarray sum`,type});
    let currMax=a[0],maxSoFar=a[0],start=0,end=0,tempStart=0;
    s.push({a:[...a],hi:0,currMax,maxSoFar,msg:`Start: currMax=${currMax}, maxSoFar=${maxSoFar}`,type});
    for(let i=1;i<n;i++){
      if(currMax+a[i]<a[i]){currMax=a[i];tempStart=i;}
      else currMax+=a[i];
      if(currMax>maxSoFar){maxSoFar=currMax;start=tempStart;end=i;}
      s.push({a:[...a],hi:i,currMax,maxSoFar,rangeL:start,rangeR:end,msg:`i=${i}: val=${a[i]}, currMax=${currMax}, maxSoFar=${maxSoFar}`,type});
    }
    s.push({a:[...a],hi:-1,currMax,maxSoFar,rangeL:start,rangeR:end,found:start,msg:`‚úÖ Max subarray sum=${maxSoFar}, indices [${start}..${end}]`,type});
  }

  else if(type==='reverse'){
    s.push({a:[...a],l:0,r:n-1,hi:-1,msg:`Reverse Array: swap from both ends toward center`,type});
    const arr=[...a];
    let l=0,r=n-1;
    while(l<r){
      s.push({a:[...arr],l,r,hi:-1,msg:`Swap arr[${l}]=${arr[l]} ‚Üî arr[${r}]=${arr[r]}`,type});
      [arr[l],arr[r]]=[arr[r],arr[l]];
      s.push({a:[...arr],l,r,hi:-1,msg:`Swapped! Move pointers inward: l‚Üí${l+1}, r‚Üí${r-1}`,type});
      l++;r--;
    }
    s.push({a:[...arr],l:-1,r:-1,hi:-1,msg:`‚úÖ Array reversed! O(n/2) swaps = O(n) time.`,type});
  }

  else if(type==='linkedlist'){
    // Simulate linked list reversal visually as array
    s.push({a:[...a],hi:0,prev:-1,curr:0,msg:`Linked List: start reversal. prev=null, curr=head`,type,isLL:true});
    const arr=[...a];
    for(let i=0;i<n-1;i++){
      s.push({a:[...arr],hi:i,prev:i-1,curr:i,msg:`curr=${arr[i]}: save next, reverse link ‚Üê to prev`,type,isLL:true});
      s.push({a:[...arr],hi:i,prev:i,curr:i+1,msg:`Move forward: prev=${arr[i]}, curr=${arr[i+1]||'null'}`,type,isLL:true});
    }
    // Reverse visually
    const rev=[...arr].reverse();
    s.push({a:rev,hi:-1,prev:n-1,curr:-1,msg:`‚úÖ Linked list reversed! New head=${rev[0]}`,type,isLL:true,done:true});
  }

  else if(type==='prefix'){
    const prefix=[0];
    s.push({a:[...a],prefix:[...prefix],hi:-1,msg:`Build prefix sum array. prefix[0]=0`,type});
    for(let i=0;i<n;i++){
      prefix.push(prefix[i]+a[i]);
      s.push({a:[...a],prefix:[...prefix],hi:i,msg:`prefix[${i+1}] = prefix[${i}] + arr[${i}] = ${prefix[i]} + ${a[i]} = ${prefix[i+1]}`,type});
    }
    // Show a range query example
    const l=1,r=Math.min(4,n-1);
    const rangeSum=prefix[r+1]-prefix[l];
    s.push({a:[...a],prefix:[...prefix],hi:-1,rangeL:l,rangeR:r,msg:`‚úÖ Query sum[${l}..${r}] = prefix[${r+1}]-prefix[${l}] = ${prefix[r+1]}-${prefix[l]} = ${rangeSum}`,type,done:true});
  }

  else if(type==='sorting'){
    // Dutch flag (0s 1s 2s)
    const arr=Array.from({length:n},()=>Math.floor(Math.random()*3));
    s.push({a:[...arr],lo:0,mid:0,hi:n-1,msg:`Dutch Flag: sort array of 0s, 1s, 2s. lo=0, mid=0, hi=${n-1}`,type});
    let lo=0,mid=0,rhi=n-1;
    while(mid<=rhi){
      if(arr[mid]===0){
        s.push({a:[...arr],lo,mid,hi:rhi,msg:`arr[mid]=${arr[mid]}=0 ‚Üí swap with lo, move both forward`,type});
        [arr[lo],arr[mid]]=[arr[mid],arr[lo]];lo++;mid++;
        s.push({a:[...arr],lo,mid,hi:rhi,msg:`Swapped! lo=${lo}, mid=${mid}`,type});
      } else if(arr[mid]===1){
        s.push({a:[...arr],lo,mid,hi:rhi,msg:`arr[mid]=${arr[mid]}=1 ‚Üí in correct zone, just move mid`,type});
        mid++;
      } else {
        s.push({a:[...arr],lo,mid,hi:rhi,msg:`arr[mid]=${arr[mid]}=2 ‚Üí swap with hi, shrink hi`,type});
        [arr[mid],arr[rhi]]=[arr[rhi],arr[mid]];rhi--;
        s.push({a:[...arr],lo,mid,hi:rhi,msg:`Swapped! hi=${rhi}`,type});
      }
    }
    s.push({a:[...arr],lo:-1,mid:-1,hi:-1,msg:`‚úÖ Array sorted: all 0s ‚Üí 1s ‚Üí 2s in O(n) time!`,type,done:true});
  }

  else if(type==='stack'){
    s.push({a:[...a],hi:-1,stk:[],msg:`Monotonic Stack: process elements maintaining stack order`,type});
    const stk=[];const result=[];
    for(let i=0;i<n;i++){
      while(stk.length&&a[stk[stk.length-1]]<a[i]){
        const top=stk.pop();
        result.push(top);
        s.push({a:[...a],hi:i,stk:[...stk],popped:top,msg:`Pop ${a[top]} at idx ${top}: found next greater=${a[i]}`,type});
      }
      stk.push(i);
      s.push({a:[...a],hi:i,stk:[...stk],msg:`Push arr[${i}]=${a[i]} onto stack. Stack size=${stk.length}`,type});
    }
    s.push({a:[...a],hi:-1,stk:[...stk],msg:`‚úÖ Done! Stack-based scan: O(n) ‚Äî each element pushed & popped once`,type,done:true});
  }

  else { // traversal (default)
    s.push({a:[...a],hi:-1,msg:`Linear traversal: scan array once to find answer`,type});
    let maxVal=a[0],maxIdx=0;
    for(let i=0;i<n;i++){
      s.push({a:[...a],hi:i,found:-1,msg:`Visit arr[${i}]=${a[i]}. Current max=${maxVal}`,type});
      if(a[i]>maxVal){
        maxVal=a[i];maxIdx=i;
        s.push({a:[...a],hi:i,found:i,msg:`New maximum found! max=${maxVal} at index ${i}`,type});
      }
    }
    s.push({a:[...a],hi:-1,found:maxIdx,msg:`‚úÖ Maximum=${maxVal} at index ${maxIdx}. Visited all ${n} elements.`,type,done:true});
  }

  return s;
}

// ---- Canvas renderer for IQ viz ----
function iqvDraw(step){
  const cvs=document.getElementById('iqv-canvas');
  if(!cvs) return;
  cvs.width=cvs.offsetWidth; cvs.height=cvs.offsetHeight;
  const W=cvs.width, H=cvs.height;
  const c=cvs.getContext('2d');
  c.clearRect(0,0,W,H);
  if(!step||!step.a) return;

  const type=step.type||'traversal';
  const arr=step.a;
  const n=arr.length;
  const gap=6;
  const cellW=Math.min(62,(W-48-gap*(n-1))/n);
  const cellH=Math.min(52,H-80);
  const totalW=n*cellW+(n-1)*gap;
  const startX=(W-totalW)/2;
  const cellY=(H-cellH)/2-6;

  // Color each cell
  arr.forEach((val,i)=>{
    const isHi=step.hi===i;
    const isFound=step.found===i;
    const isDone=step.done;
    const isL=step.l===i;
    const isR=step.r===i;
    const isMid=step.mid===i;
    const isLo=step.lo===i;
    const isRange=(step.rangeL!=null&&i>=step.rangeL&&i<=step.rangeR);
    const inStk=step.stk&&step.stk.includes(i);

    let fill,border,text;
    if(isDone&&step.found===i){fill='#00f5c4';border='#00f5c4';text='#0a0a0f';}
    else if(isFound&&step.found>=0){fill='rgba(0,245,196,.3)';border='#00f5c4';text='#00f5c4';}
    else if(isL||isLo){fill='rgba(255,217,61,.25)';border='#ffd93d';text='#ffd93d';}
    else if(isR){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
    else if(isMid){fill='rgba(167,139,250,.25)';border='#a78bfa';text='#a78bfa';}
    else if(isHi){fill='rgba(0,245,196,.22)';border='#00f5c4';text='#00f5c4';}
    else if(isRange){fill='rgba(0,245,196,.1)';border='rgba(0,245,196,.4)';text='#00f5c4';}
    else if(inStk){fill='rgba(255,107,107,.1)';border='rgba(255,107,107,.3)';text='#ff6b6b';}
    else{fill='rgba(58,58,110,.5)';border='#3a3a6e';text='#7070aa';}

    const x=startX+i*(cellW+gap);
    c.shadowColor=border; c.shadowBlur=(isHi||isFound||isL||isR||isMid)?16:0;
    c.fillStyle=fill; c.strokeStyle=border; c.lineWidth=1.8;
    c.beginPath();
    const rr=7;
    c.moveTo(x+rr,cellY);c.lineTo(x+cellW-rr,cellY);c.quadraticCurveTo(x+cellW,cellY,x+cellW,cellY+rr);
    c.lineTo(x+cellW,cellY+cellH-rr);c.quadraticCurveTo(x+cellW,cellY+cellH,x+cellW-rr,cellY+cellH);
    c.lineTo(x+rr,cellY+cellH);c.quadraticCurveTo(x,cellY+cellH,x,cellY+cellH-rr);
    c.lineTo(x,cellY+rr);c.quadraticCurveTo(x,cellY,x+rr,cellY);c.closePath();
    c.fill(); c.stroke(); c.shadowBlur=0;

    c.fillStyle=text; c.textAlign='center'; c.textBaseline='middle';
    c.font=`bold ${Math.min(16,cellW*0.36)}px Space Mono,monospace`;
    c.fillText(val,x+cellW/2,cellY+cellH/2);

    // Index
    c.fillStyle='#3a3a5e'; c.font=`${Math.min(9,cellW*0.22)}px Space Mono,monospace`;
    c.textBaseline='alphabetic';
    c.fillText(i,x+cellW/2,cellY+cellH+14);

    // Labels
    if(isL||isLo){drawLabel(c,x+cellW/2,cellY-14,type==='binarysearch'?'LO':'L','#ffd93d');}
    if(isR){drawLabel(c,x+cellW/2,cellY-14,type==='binarysearch'?'HI':'R','#ff6b6b');}
    if(isMid){drawLabel(c,x+cellW/2,cellY-14,'MID','#a78bfa');}
    if(isHi&&!isL&&!isR&&!isMid){drawLabel(c,x+cellW/2,cellY-14,'‚Üí','#00f5c4');}
    if(isFound&&step.found>=0&&!isDone){drawLabel(c,x+cellW/2,cellY-14,'‚úì','#00f5c4');}
  });

  // Frequency bar (hashmap mode)
  if(type==='hashmap'&&step.freq&&Object.keys(step.freq).length){
    const keys=Object.keys(step.freq);
    const barW=Math.min(40,(W-48)/keys.length-4);
    const barMaxH=30;
    const maxF=Math.max(...Object.values(step.freq));
    keys.forEach((k,ki)=>{
      const f=step.freq[k];
      const bh=Math.round((f/maxF)*barMaxH);
      const bx=24+ki*(barW+4);
      const by=H-14-bh;
      c.fillStyle=f>1?'rgba(255,107,107,.5)':'rgba(0,245,196,.3)';
      c.strokeStyle=f>1?'#ff6b6b':'rgba(0,245,196,.4)';
      c.lineWidth=1;
      c.fillRect(bx,by,barW,bh);
      c.strokeRect(bx,by,barW,bh);
      c.fillStyle='#6b6b8a';
      c.font='8px Space Mono,monospace';
      c.textAlign='center';c.textBaseline='alphabetic';
      c.fillText(`${k}:${f}`,bx+barW/2,H-2);
    });
  }

  // Prefix sum visual (second row)
  if(type==='prefix'&&step.prefix&&step.prefix.length>1){
    const prefArr=step.prefix;
    const pH=22,pY=cellY+cellH+22;
    const pW=Math.min(cellW,62);
    const ptotalW=prefArr.length*(pW+gap)-gap;
    const pX=(W-ptotalW)/2;
    c.font='8px Space Mono,monospace';c.fillStyle='#5a5a7a';c.textAlign='center';
    c.fillText('prefix ‚Üí',pX-36,pY+pH/2);
    prefArr.forEach((v,pi)=>{
      const isActive=pi===step.hi+1;
      const isRange=step.rangeL!=null&&(pi===step.rangeL||pi===step.rangeR+1);
      c.fillStyle=isActive?'rgba(167,139,250,.2)':isRange?'rgba(0,245,196,.15)':'rgba(30,30,50,.5)';
      c.strokeStyle=isActive?'#a78bfa':isRange?'#00f5c4':'#3a3a6e';
      c.lineWidth=isActive?2:1;
      c.fillRect(pX+pi*(pW+gap),pY,pW,pH);
      c.strokeRect(pX+pi*(pW+gap),pY,pW,pH);
      c.fillStyle=isActive?'#a78bfa':isRange?'#00f5c4':'#6b6b8a';
      c.font=`bold 9px Space Mono,monospace`;
      c.fillText(v,pX+pi*(pW+gap)+pW/2,pY+pH/2+4);
    });
  }

  // Done banner
  if(step.done&&step.msg&&step.msg.startsWith('‚úÖ')){
    c.fillStyle='rgba(0,245,196,.08)';
    c.strokeStyle='rgba(0,245,196,.25)';c.lineWidth=1.5;
    c.beginPath();
    const bx=W/2-140,by=H-32,bw=280,bh=24,br=6;
    c.moveTo(bx+br,by);c.lineTo(bx+bw-br,by);c.quadraticCurveTo(bx+bw,by,bx+bw,by+br);
    c.lineTo(bx+bw,by+bh-br);c.quadraticCurveTo(bx+bw,by+bh,bx+bw-br,by+bh);
    c.lineTo(bx+br,by+bh);c.quadraticCurveTo(bx,by+bh,bx,by+bh-br);
    c.lineTo(bx,by+br);c.quadraticCurveTo(bx,by,bx+br,by);c.closePath();
    c.fill();c.stroke();
    c.fillStyle='#00f5c4';c.font='bold 11px Space Mono,monospace';
    c.textAlign='center';c.textBaseline='middle';
    c.fillText('SOLVED ‚úì',W/2,H-20);
  }

  // Pointer bridge line (two pointer)
  if((type==='twopointer'||type==='reverse')&&step.l>=0&&step.r>=0&&step.l!==step.r){
    const x1=startX+step.l*(cellW+gap)+cellW/2;
    const x2=startX+step.r*(cellW+gap)+cellW/2;
    const ly=cellY-22;
    c.strokeStyle='rgba(255,217,61,.35)';c.lineWidth=1.5;c.setLineDash([4,3]);
    c.beginPath();c.moveTo(x1,ly);c.lineTo(x2,ly);c.stroke();c.setLineDash([]);
  }
}

function drawLabel(c,x,y,text,color){
  c.fillStyle=color;c.font='bold 9px Space Mono,monospace';
  c.textAlign='center';c.textBaseline='alphabetic';
  c.fillText(text,x,y);
}

// ---- Modal open/close/play/pause/reset ----
function openIqViz(q){
  iqvCurrentQ=q;
  const type=detectProblemType(q);
  const arr=Array.from({length:10},()=>Math.floor(Math.random()*60)+5);

  // Populate modal info
  const diffColors={easy:'#00f5c4',medium:'#ffd93d',hard:'#ff6b6b'};
  const badge=document.getElementById('iqv-badge');
  badge.textContent={easy:'üü¢ Easy',medium:'üü° Medium',hard:'üî¥ Hard'}[q.d]||q.d;
  badge.style.background=diffColors[q.d]+'22';badge.style.color=diffColors[q.d];
  badge.style.border=`1px solid ${diffColors[q.d]}55`;
  document.getElementById('iqv-title').textContent=q.q;
  document.getElementById('iqv-companies').textContent='üè¢ '+( q.companies||'Various');
  document.getElementById('iqv-code').textContent=IQV_CODE[type]||IQV_CODE.traversal;
  document.getElementById('iqv-code-title').textContent=type+'_solution.py';
  document.getElementById('iqv-approach').textContent=IQV_APPROACH[type]||'';
  document.getElementById('iqv-complexity').textContent=IQV_COMPLEXITY[type]||'';
  document.getElementById('iqv-hint').textContent=q.hint||'';

  // Generate steps
  iqvSteps=iqvGenSteps(type,arr);
  iqvIdx=0;iqvPlaying=false;
  if(iqvIv)clearInterval(iqvIv);
  document.getElementById('iqv-play-btn').textContent='‚ñ∂ Play';
  document.getElementById('iqv-step-num').textContent='0';
  document.getElementById('iqv-total-steps').textContent=iqvSteps.length;
  document.getElementById('iqv-progress').style.width='0%';
  document.getElementById('iqv-step-msg').textContent='Press Play to start visualization';
  document.getElementById('iq-viz-modal').style.display='block';
  document.body.style.overflow='hidden';

  // Draw initial frame
  setTimeout(()=>{iqvDraw(iqvSteps[0]);},50);
}

function closeIqViz(){
  if(iqvIv)clearInterval(iqvIv);
  iqvPlaying=false;
  document.getElementById('iq-viz-modal').style.display='none';
  document.body.style.overflow='';
}

function iqvApplyStep(){
  if(iqvIdx>=iqvSteps.length)return;
  const step=iqvSteps[iqvIdx];
  document.getElementById('iqv-step-msg').textContent=step.msg||'';
  document.getElementById('iqv-step-num').textContent=iqvIdx+1;
  const pct=Math.round(((iqvIdx+1)/iqvSteps.length)*100);
  document.getElementById('iqv-progress').style.width=pct+'%';
  iqvDraw(step);
}

function iqvStepForward(){
  if(iqvIdx<iqvSteps.length){iqvApplyStep();iqvIdx++;}
  if(iqvIdx>=iqvSteps.length){if(iqvIv)clearInterval(iqvIv);iqvPlaying=false;document.getElementById('iqv-play-btn').textContent='‚ñ∂ Play';}
}

function iqvPlayPause(){
  if(iqvIdx>=iqvSteps.length){iqvIdx=0;}
  iqvPlaying=!iqvPlaying;
  document.getElementById('iqv-play-btn').textContent=iqvPlaying?'‚è∏ Pause':'‚ñ∂ Play';
  if(iqvPlaying){
    const spd=+document.getElementById('iqv-speed').value;
    const delays=[0,1400,1100,850,650,500,380,260,180];
    iqvIv=setInterval(()=>{
      if(!iqvPlaying||iqvIdx>=iqvSteps.length){
        clearInterval(iqvIv);iqvPlaying=false;
        document.getElementById('iqv-play-btn').textContent='‚ñ∂ Play';return;
      }
      iqvStepForward();
    },delays[spd]||600);
  } else {
    clearInterval(iqvIv);
  }
}

function iqvReset(){
  if(iqvIv)clearInterval(iqvIv);
  iqvPlaying=false;iqvIdx=0;
  document.getElementById('iqv-play-btn').textContent='‚ñ∂ Play';
  document.getElementById('iqv-step-num').textContent='0';
  document.getElementById('iqv-progress').style.width='0%';
  document.getElementById('iqv-step-msg').textContent='Press Play to start visualization';
  if(iqvSteps.length) iqvDraw(iqvSteps[0]);
}

// Close modal on backdrop click
document.getElementById('iq-viz-modal').addEventListener('click',function(e){
  if(e.target===this) closeIqViz();
});

// ============================================================
// ALGO RECAP + VOICE NARRATION
// ============================================================
let vizVoiceLang='en';
function vizSetLang(lang){
  vizVoiceLang=lang;
  document.getElementById('viz-lang-en').classList.toggle('active',lang==='en');
  document.getElementById('viz-lang-hi').classList.toggle('active',lang==='hi');
}

function updateRecapCard(algoName){
  const recap = ALGO_RECAP[algoName];
  if(!recap) return;
  document.getElementById('recap-algo-badge').textContent = ALGOS[algoName].name;
  document.getElementById('recap-definition').textContent = recap.def;
  document.getElementById('recap-how').textContent = recap.how;
  document.getElementById('recap-tags').innerHTML = recap.tags.map((t,i)=>
    `<span style="padding:3px 12px;border-radius:99px;font-family:'Space Mono',monospace;font-size:.62rem;font-weight:700;background:${recap.tagColors[i]}18;border:1px solid ${recap.tagColors[i]}50;color:${recap.tagColors[i]};">${t}</span>`
  ).join('');
}

function vizSpeakRecap(){
  const recap = ALGO_RECAP[curAlgo];
  if(!recap) return;
  const text = vizVoiceLang==='hi'
    ? `${ALGOS[curAlgo].name} ka quick recap. Paribhasha: ${recap.hindiDef}. Yeh kaise kaam karta hai: ${recap.hindiHow}`
    : `Quick recap of ${ALGOS[curAlgo].name}. Definition: ${recap.def}. How it works: ${recap.how}`;
  if(!synth) return;
  synth.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = vizVoiceLang==='hi'?'hi-IN':'en-US';
  u.rate = vizVoiceLang==='hi'?0.88:0.92;
  if(vizVoiceLang==='hi'&&voiceHI) u.voice=voiceHI;
  else if(voiceEN) u.voice=voiceEN;
  synth.speak(u);
}

// User array input for viz page
let vizCustomArray = null;

function vizParseArray(){
  const raw = document.getElementById('viz-array-input').value;
  const errEl = document.getElementById('viz-array-err');
  if(!raw.trim()){errEl.style.display='none';document.getElementById('viz-array-preview').innerHTML='';return null;}
  const parts = raw.split(',').map(s=>parseInt(s.trim()));
  const invalid = parts.filter(v=>isNaN(v));
  if(invalid.length>0){errEl.textContent='Invalid values. Use comma-separated integers.';errEl.style.display='block';return null;}
  if(parts.length<2){errEl.textContent='Need at least 2 values.';errEl.style.display='block';return null;}
  if(parts.length>30){errEl.textContent='Max 30 values.';errEl.style.display='block';return null;}
  errEl.style.display='none';
  document.getElementById('viz-array-preview').innerHTML = parts.map((v,i)=>
    `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:7px;padding:6px 10px;text-align:center;min-width:38px;"><div style="font-family:'Space Mono',monospace;font-weight:700;font-size:.85rem;color:var(--text);">${v}</div><div style="font-family:'Space Mono',monospace;font-size:.58rem;color:var(--muted);">[${i}]</div></div>`
  ).join('');
  return parts;
}
function vizApplyArray(){
  const arr = vizParseArray();
  if(!arr) return;
  vizCustomArray = arr;
  array = [...arr];
  // Only sort for algorithms that REQUIRE a sorted array (not linear search)
  if(ALGOS[curAlgo].type==='search' && curAlgo!=='linear') array=[...array].sort((a,b)=>a-b);
  resetViz();
}
function vizGenRandom(){
  const n=+document.getElementById('sizeSlider').value||12;
  const arr=Array.from({length:n},()=>Math.floor(Math.random()*90)+8);
  document.getElementById('viz-array-input').value=arr.join(', ');
  vizParseArray(); vizApplyArray();
}
function vizGenSorted(){
  const n=+document.getElementById('sizeSlider').value||12;
  const arr=Array.from({length:n},(_,i)=>(i+1)*Math.floor(90/n)+Math.floor(Math.random()*5)).sort((a,b)=>a-b);
  document.getElementById('viz-array-input').value=arr.join(', ');
  vizParseArray(); vizApplyArray();
}
function vizGenReversed(){
  vizGenSorted();
  const arr=document.getElementById('viz-array-input').value.split(',').map(s=>parseInt(s.trim())).reverse();
  document.getElementById('viz-array-input').value=arr.join(', ');
  vizParseArray(); vizApplyArray();
}

// ============================================================
// PASTE CODE ‚Äî MULTI-LANGUAGE + AI FIX
// ============================================================
const LANG_EXTENSIONS = {python:'py',cpp:'cpp',c:'c',java:'java',javascript:'js',csharp:'cs'};
const LANG_COMMENTS = {python:'#',cpp:'//',c:'//',java:'//',javascript:'//',csharp:'//'};

function onLangChange(){
  const lang = document.getElementById('paste-lang-select').value;
  const ext = LANG_EXTENSIONS[lang]||'txt';
  document.getElementById('paste-file-label').textContent = `üìÑ your_algorithm.${ext}`;
  document.getElementById('paste-lang-hint').textContent = {
    python:'Python detected. All algorithm detection enabled.',
    cpp:'C++ mode. Syntax highlighting and error detection active.',
    c:'C mode. Syntax highlighting and error detection active.',
    java:'Java mode. Class and method detection active.',
    javascript:'JavaScript mode. Function detection active.',
    csharp:'C# mode. Class and method detection active.'
  }[lang]||'';
  clearPasteCode();
}

function getErrorFix(msg, line){
  if(msg.includes('IndentationError')||msg.includes('indentation')||msg.includes('indent'))
    return 'Fix: Ensure consistent 4-space or tab indentation. Mixed tabs/spaces cause this.';
  if(msg.includes('SyntaxError')||msg.includes('invalid syntax'))
    return 'Fix: Check for missing colons (:) after if/for/def, mismatched brackets, or typos.';
  if(msg.includes('colon')||msg.includes('expected')||msg.includes(':'))
    return 'Fix: Add missing colon (:) at end of def, if, for, while, class statements.';
  if(msg.includes('bracket')||msg.includes('parenthes')||msg.includes('paren'))
    return 'Fix: Count opening and closing brackets/parentheses ‚Äî they must match.';
  if(msg.includes('undefined')||msg.includes('not defined'))
    return 'Fix: Declare the variable before using it. Check for typos in variable name.';
  if(msg.includes('missing return')||msg.includes('return'))
    return 'Fix: Add a return statement at the end of your function.';
  return 'Fix: Review the line carefully for missing operators, keywords, or punctuation.';
}

async function aiFixCode(){
  const code = document.getElementById('paste-code').value;
  if(!code.trim()) return;
  const lang = document.getElementById('paste-lang-select').value;
  const btn = document.getElementById('ai-fix-btn');
  btn.textContent = '‚è≥ Fixing...'; btn.disabled=true;
  // Use Anthropic API to fix the code
  try{
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:2000,
        messages:[{role:'user',content:`Fix ALL syntax errors in this ${lang} code. Return ONLY the corrected code, no explanation, no markdown:\n\n${code}`}]
      })
    });
    const data = await resp.json();
    if(data.content&&data.content[0]){
      let fixed = data.content.map(b=>b.text||'').join('').trim();
      fixed = fixed.replace(/^```[\w]*\n?/,'').replace(/\n?```$/,'');
      document.getElementById('paste-code').value = fixed;
      onCodeInput();
    }
  }catch(e){
    console.log('AI fix error:',e);
    // Fallback: show manual fix suggestions
    alert('AI Fix: Please check your code manually. Common fixes:\n‚Ä¢ Add colons after def/if/for/while\n‚Ä¢ Fix indentation (4 spaces)\n‚Ä¢ Match all brackets/parentheses');
  }
  btn.textContent='ü§ñ AI Fix'; btn.disabled=false;
}

// ============================================================
// SINGLE VIZ STATE
let curAlgo='selection',array=[],steps=[],stepIdx=0,playing=false,playIv=null,cmps=0,swps=0,speed=5;
const canvas=document.getElementById('viz-canvas');
const ctx=canvas.getContext('2d');

function getDelay(){return Math.round(1200/speed);}
function updateSpeed(){speed=+document.getElementById('speedSlider').value;}
function randomize(){
  const n=+document.getElementById('sizeSlider').value;
  array=Array.from({length:n},()=>Math.floor(Math.random()*90)+8);
  // Only sort for algorithms that REQUIRE sorted input (not linear search)
  if(ALGOS[curAlgo].type==='search' && curAlgo!=='linear'){array=[...array].sort((a,b)=>a-b);}
  resetViz();
}
function changeSize(){randomize();}

function resetViz(){
  if(playIv)clearInterval(playIv);
  playing=false;document.getElementById('playBtn').textContent='‚ñ∂ Play';
  cmps=0;swps=0;stepIdx=0;
  // Pass user-specified search target for search algorithms
  let genArr = [...array];
  let userTarget = null;
  if(ALGOS[curAlgo].type==='search'){
    const tInput = document.getElementById('viz-search-target');
    if(tInput && tInput.value.trim()!=='') {
      const tv = parseInt(tInput.value.trim());
      if(!isNaN(tv)) userTarget = tv;
    }
  }
  steps=ALGOS[curAlgo].gen(genArr, userTarget);
  document.getElementById('totalSteps').textContent=steps.length;
  document.getElementById('cmpCount').textContent=0;
  document.getElementById('swapCount').textContent=0;
  document.getElementById('stepCount').textContent=0;
  document.getElementById('statusText').textContent='Ready';
  document.getElementById('step-text').textContent='Press Play or Step ‚Üí to begin.';
  drawVizStep(canvas,ctx,steps,0,curAlgo);
  highlightCode(-1);
}

function selectAlgo(name,el){
  curAlgo=name;
  document.querySelectorAll('#single-algo-tabs .algo-tab').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  const cfg=ALGOS[name];
  if(!cfg)return;
  document.getElementById('cx-title').textContent=cfg.name;
  document.getElementById('cx-best').textContent=cfg.best;document.getElementById('cx-best').className='cx-val '+cfg.bc;
  document.getElementById('cx-avg').textContent=cfg.avg;document.getElementById('cx-avg').className='cx-val '+cfg.ac;
  document.getElementById('cx-worst').textContent=cfg.worst;document.getElementById('cx-worst').className='cx-val '+cfg.wc;
  document.getElementById('cx-space').textContent=cfg.space;
  document.getElementById('cx-stable').textContent=cfg.stable;
  document.getElementById('cx-inplace').textContent=cfg.inplace;
  // Update code title with current language extension
  const ext = LANG_FILE_EXT[currentVizLang]||'py';
  const base = name==='binary'?'binary_search':name==='linear'?'linear_search':name==='jump'?'jump_search':name==='interpolation'?'interpolation_search':name+'_sort';
  document.getElementById('code-title').textContent=base+'.'+ext;
  renderCode('code-display',name);
  // Show/hide search target
  const searchWrap=document.getElementById('viz-search-target-wrap');
  if(searchWrap)searchWrap.style.display=cfg.type==='search'?'block':'none';
  // Show note for linear search that array stays random
  const existingNote = document.getElementById('linear-note');
  if(existingNote) existingNote.remove();
  if(name==='linear'){
    const note = document.createElement('div');
    note.id='linear-note';
    note.style.cssText='font-family:Space Mono,monospace;font-size:.7rem;color:#00f5c4;margin-top:6px;padding:6px 12px;background:rgba(0,245,196,.08);border:1px solid rgba(0,245,196,.2);border-radius:8px;';
    note.textContent='‚úÖ Linear Search works on UNSORTED arrays ‚Äî array stays in its original random order.';
    const wrap=document.getElementById('viz-search-target-wrap');
    if(wrap)wrap.parentNode.insertBefore(note,wrap.nextSibling);
  }
  // Update recap card
  updateRecapCard(name);
  randomize();
}

function renderCode(elId,name){
  // Use multi-language renderer if available
  if(typeof renderCodeMultiLang === 'function' && ALGO_MULTILANG && ALGO_MULTILANG[name]) {
    renderCodeMultiLang(elId, name, currentVizLang);
    return;
  }
  const lines=ALGOS[name].code;
  const pre=document.getElementById(elId);
  pre.innerHTML=lines.map((l,i)=>`<span class="code-line" id="${elId}-cl${i}">${l.t||'&nbsp;'}</span>`).join('\n');
}

function highlightCode(lineNum){
  document.querySelectorAll('#code-display .code-line').forEach(el=>el.classList.remove('active'));
  if(lineNum>=0){const el=document.getElementById('code-display-cl'+lineNum);if(el)el.classList.add('active');}
}

function drawVizStep(cvs,c,stps,idx,algo){
  cvs.width=cvs.offsetWidth;cvs.height=cvs.offsetHeight;
  const W=cvs.width,H=cvs.height;
  c.clearRect(0,0,W,H);
  if(!stps.length||!stps[0].a.length)return;
  const step=stps[Math.min(idx,stps.length-1)];
  const arr=step.a,n=arr.length;
  const isSearch=ALGOS[algo].type==='search';
  // Detect "not found" final state ‚Äî range is [-1,-1]
  const isNotFound = isSearch && step.range && step.range[0]===-1 && step.range[1]===-1 && step.found===-1;

  // Layout: rectangles arranged in a horizontal grid
  const padX=24,padY=28;
  const gap=6;
  const cellW=Math.min(72,(W-padX*2-gap*(n-1))/n);
  const cellH=Math.min(64,H-padY*2-40);
  const totalW=n*cellW+(n-1)*gap;
  const startX=(W-totalW)/2;
  const cellY=(H-cellH)/2-6;

  arr.forEach((val,i)=>{
    const isSorted=step.su===n-1||(step.su>=0&&i<=step.su&&!isSearch);
    const isComp=step.cmp&&step.cmp.includes(i);
    const isHi=step.hi===i;
    const isFound=step.found===i;
    const inRange=isSearch&&!isNotFound&&step.range&&i>=step.range[0]&&i<=step.range[1];

    let fillColor,borderColor,textColor;
    if(isNotFound){
      // All cells shown in faded red ‚Äî element not in array
      fillColor='rgba(255,107,107,0.08)';borderColor='rgba(255,107,107,0.3)';textColor='rgba(255,107,107,0.5)';
    }else if(isFound){fillColor='#00f5c4';borderColor='#00f5c4';textColor='#0a0a0f';}
    else if(step.su===n-1&&!isSearch){fillColor='rgba(0,245,196,0.18)';borderColor='#00f5c4';textColor='#00f5c4';}
    else if(isComp){fillColor='rgba(255,107,107,0.22)';borderColor='#ff6b6b';textColor='#ff6b6b';}
    else if(isHi){fillColor='rgba(255,217,61,0.22)';borderColor='#ffd93d';textColor='#ffd93d';}
    else if(isSorted){fillColor='rgba(0,245,196,0.13)';borderColor='#00f5c420';textColor='#00f5c4';}
    else if(inRange){fillColor='rgba(167,139,250,0.18)';borderColor='#a78bfa';textColor='#a78bfa';}
    else{fillColor='rgba(58,58,110,0.5)';borderColor='#3a3a6e';textColor='#9090b8';}

    const x=startX+i*(cellW+gap);
    const rr=8;

    // Glow for active cells
    if(!isNotFound&&(isComp||isHi||isFound)){
      c.shadowColor=borderColor;c.shadowBlur=18;
    }else{c.shadowBlur=0;}

    // Fill rectangle
    c.fillStyle=fillColor;
    c.beginPath();
    c.moveTo(x+rr,cellY);c.lineTo(x+cellW-rr,cellY);
    c.quadraticCurveTo(x+cellW,cellY,x+cellW,cellY+rr);
    c.lineTo(x+cellW,cellY+cellH-rr);
    c.quadraticCurveTo(x+cellW,cellY+cellH,x+cellW-rr,cellY+cellH);
    c.lineTo(x+rr,cellY+cellH);
    c.quadraticCurveTo(x,cellY+cellH,x,cellY+cellH-rr);
    c.lineTo(x,cellY+rr);
    c.quadraticCurveTo(x,cellY,x+rr,cellY);
    c.closePath();c.fill();

    // Border
    c.strokeStyle=borderColor;
    c.lineWidth=(isComp||isHi||isFound)?2.5:1.5;
    c.stroke();
    c.shadowBlur=0;

    // Value (large, centered)
    const fontSize=Math.min(20,cellW*0.38);
    c.fillStyle=textColor;
    c.font=`bold ${fontSize}px Space Mono,monospace`;
    c.textAlign='center';
    c.textBaseline='middle';
    c.fillText(val,x+cellW/2,cellY+cellH/2);

    // Index label below
    c.fillStyle=isNotFound?'rgba(255,107,107,0.3)':'#3a3a5e';
    c.font=`${Math.min(10,cellW*0.22)}px Space Mono,monospace`;
    c.textBaseline='alphabetic';
    c.fillText(i,x+cellW/2,cellY+cellH+18);

    // Arrow/indicator for comparing/min (not in not-found state)
    if(!isNotFound&&(isComp||isHi||isFound)){
      c.fillStyle=borderColor;
      c.beginPath();
      const ax=x+cellW/2,ay=cellY-10;
      c.moveTo(ax,ay);c.lineTo(ax-5,ay-8);c.lineTo(ax+5,ay-8);
      c.closePath();c.fill();
    }
  });

  // "NOT FOUND" banner overlay
  if(isNotFound){
    c.shadowBlur=0;
    const bw=220,bh=44;
    const bx=(W-bw)/2, by=(H-bh)/2;
    c.fillStyle='rgba(255,107,107,0.15)';
    c.strokeStyle='rgba(255,107,107,0.7)';
    c.lineWidth=2;
    c.beginPath();
    c.roundRect(bx,by,bw,bh,10);
    c.fill();c.stroke();
    c.fillStyle='#ff6b6b';
    c.font='bold 16px Space Mono,monospace';
    c.textAlign='center';c.textBaseline='middle';
    c.fillText('‚ùå  NOT FOUND  ‚Üí  return -1',W/2,H/2);
    return;
  }

  // Draw connecting line between comparing pair
  if(step.cmp&&step.cmp.length===2){
    const [i1,i2]=step.cmp;
    const x1=startX+i1*(cellW+gap)+cellW/2;
    const x2=startX+i2*(cellW+gap)+cellW/2;
    const ly=cellY-22;
    c.strokeStyle='rgba(255,107,107,0.4)';
    c.lineWidth=1.5;
    c.setLineDash([4,4]);
    c.beginPath();c.moveTo(x1,ly);c.lineTo(x2,ly);c.stroke();
    c.setLineDash([]);
  }
}

function applyStep(){
  if(stepIdx>=steps.length)return;
  const step=steps[stepIdx],prev=stepIdx>0?steps[stepIdx-1]:null;
  if(step.cmp&&step.cmp.length===2){cmps++;document.getElementById('cmpCount').textContent=cmps;}
  if(prev&&JSON.stringify(prev.a)!==JSON.stringify(step.a)){swps++;document.getElementById('swapCount').textContent=swps;}
  document.getElementById('stepCount').textContent=stepIdx+1;
  document.getElementById('step-text').textContent=step.msg||'';
  // Determine status
  const isLastStep = stepIdx===steps.length-1;
  const isNotFound = isLastStep && ALGOS[curAlgo].type==='search' && step.range && step.range[0]===-1 && step.found===-1;
  const isFoundStep = isLastStep && step.found>=0;
  if(isNotFound) document.getElementById('statusText').textContent='Not Found ‚ùå';
  else if(isFoundStep) document.getElementById('statusText').textContent='Found ‚úÖ';
  else if(isLastStep) document.getElementById('statusText').textContent='Done ‚úì';
  else document.getElementById('statusText').textContent='Running';
  drawVizStep(canvas,ctx,steps,stepIdx,curAlgo);
  highlightCode(step.l);
}
function stepForward(){
  if(stepIdx<steps.length){applyStep();stepIdx++;}
  if(stepIdx>=steps.length){if(playIv)clearInterval(playIv);playing=false;document.getElementById('playBtn').textContent='‚ñ∂ Play';}
}
function playPause(){
  if(stepIdx>=steps.length){resetViz();return;}
  playing=!playing;
  document.getElementById('playBtn').textContent=playing?'‚è∏ Pause':'‚ñ∂ Play';
  if(playing){playIv=setInterval(()=>{if(stepIdx>=steps.length){clearInterval(playIv);playing=false;document.getElementById('playBtn').textContent='‚ñ∂ Play';return;}stepForward();},getDelay());}
  else{clearInterval(playIv);}
}

// ============================================================
// PASTE CODE ‚Äî enhanced with syntax check, input, generate
// ============================================================
const codeMap={
  'selection_sort':'selection','bubble_sort':'bubble','insertion_sort':'insertion',
  'merge_sort':'merge','quick_sort':'quick','heap_sort':'heap','shell_sort':'shell',
  'counting_sort':'counting','binary_search':'binary','linear_search':'linear'
};

let pasteDetectedKey=null;

// Python syntax checker (JS-based heuristic)
function checkPythonSyntax(code){
  const errors=[];
  const lines=code.split('\n');
  const indentStack=[0];

  // Common syntax patterns to catch
  const checks=[
    {re:/\bdef\s+\w+\s*\([^)]*\)\s*[^:]\s*$/, msg:'Missing colon after function definition'},
    {re:/\bfor\s+.+\s+in\s+.+[^:]\s*$/, msg:'Missing colon after for statement'},
    {re:/\bwhile\s+.+[^:]\s*$/, msg:'Missing colon after while statement'},
    {re:/\bif\s+.+[^:]\s*$/, msg:'Missing colon after if statement'},
    {re:/\belse\s*[^:]\s*$/, msg:'Missing colon after else'},
    {re:/\belif\s+.+[^:]\s*$/, msg:'Missing colon after elif'},
    {re:/^\s*(def|for|if|while|else|elif|try|except|with|class)\s*$/, msg:'Incomplete statement'},
    {re:/[=!<>]=?[=!<>]{2,}/, msg:'Malformed comparison operator'},
    {re:/\bprint\s+[^(]/, msg:'Python 2 print statement (use print())'},
  ];

  lines.forEach((line,i)=>{
    const stripped=line.trimEnd();
    const commentIdx=stripped.indexOf('#');
    const codePart=commentIdx>=0?stripped.slice(0,commentIdx):stripped;
    const trimmed=codePart.trim();
    if(!trimmed)return;

    // Check unmatched brackets
    let opens=0,closes=0,sq_o=0,sq_c=0;
    for(const ch of codePart){
      if(ch==='(')opens++;if(ch===')')closes++;
      if(ch==='[')sq_o++;if(ch===']')sq_c++;
    }
    if(opens!==closes)errors.push({line:i+1,msg:`Unmatched parentheses ( vs ) on this line`});
    if(sq_o!==sq_c)errors.push({line:i+1,msg:`Unmatched brackets [ vs ] on this line`});

    // Check control flow colons (only non-empty, non-comment lines)
    if(/^\s*(def|for|while|if|else|elif|try|except|with|class)\b/.test(stripped)){
      if(!/:\s*(#.*)?$/.test(codePart)){
        errors.push({line:i+1,msg:`Missing ':' at end of statement`});
      }
    }

    // Other checks
    checks.forEach(c=>{
      if(c.re.test(trimmed)&&!errors.find(e=>e.line===i+1)){
        errors.push({line:i+1,msg:c.msg});
      }
    });

    // Check for obvious typos in keywords
    if(/^\s*deff?\s/.test(stripped)&&!/^\s*def\s/.test(stripped))
      errors.push({line:i+1,msg:`Typo: did you mean 'def'?`});
    if(/^\s*retrun\b/.test(stripped))
      errors.push({line:i+1,msg:`Typo: did you mean 'return'?`});
    if(/^\s*whlie\b/.test(stripped))
      errors.push({line:i+1,msg:`Typo: did you mean 'while'?`});
    if(/^\s*prnit\b/.test(stripped))
      errors.push({line:i+1,msg:`Typo: did you mean 'print'?`});
  });

  // Check overall unmatched parens
  let totalOpen=(code.match(/\(/g)||[]).length;
  let totalClose=(code.match(/\)/g)||[]).length;
  if(totalOpen!==totalClose&&!errors.length)
    errors.push({line:null,msg:`Overall unmatched parentheses: ${totalOpen} opening vs ${totalClose} closing`});

  return errors;
}

function updateLineNumbers(){
  const ta=document.getElementById('paste-code');
  const ln=document.getElementById('line-numbers');
  const lines=ta.value.split('\n');
  ln.textContent=lines.map((_,i)=>i+1).join('\n');
}

function syncScroll(){
  const ta=document.getElementById('paste-code');
  const ln=document.getElementById('line-numbers');
  ln.scrollTop=ta.scrollTop;
}

function handleTab(e){
  if(e.key==='Tab'){
    e.preventDefault();
    const ta=document.getElementById('paste-code');
    const start=ta.selectionStart,end=ta.selectionEnd;
    ta.value=ta.value.slice(0,start)+'    '+ta.value.slice(end);
    ta.selectionStart=ta.selectionEnd=start+4;
    onCodeInput();
  }
}

function onCodeInput(){
  updateLineNumbers();
  analyzeCode();
}

function analyzeCode(){
  const code=document.getElementById('paste-code').value;
  const badge=document.getElementById('syntax-badge');
  const analysisPanel=document.getElementById('analysis-panel');
  const analysisContent=document.getElementById('analysis-content');
  const inputSection=document.getElementById('input-section');
  const generateSection=document.getElementById('generate-section');
  const errorOverlay=document.getElementById('error-overlay');
  const errorList=document.getElementById('error-lines-list');

  updateLineNumbers();

  if(code.trim().length<10){
    badge.style.display='none';
    analysisPanel.style.display='none';
    inputSection.style.display='none';
    generateSection.style.display='none';
    errorOverlay.style.display='none';
    document.getElementById('parse-viz-container').innerHTML='';
    return;
  }

  const errors=checkPythonSyntax(code);
  const detected=[];
  for(const [fn,key] of Object.entries(codeMap)){
    if(code.includes(fn))detected.push({fn,key});
  }
  const isSearch=detected.length>0&&(detected[0].key==='binary'||detected[0].key==='linear');

  if(errors.length>0){
    // SYNTAX ERRORS
    badge.style.display='inline-block';
    badge.textContent=`‚ùå ${errors.length} Error${errors.length>1?'s':''}`;
    badge.style.background='rgba(255,107,107,0.2)';
    badge.style.color='var(--accent2)';
    badge.style.border='1px solid rgba(255,107,107,0.4)';

    errorOverlay.style.display='block';
    errorList.innerHTML=errors.map(e=>`
      <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 16px;border-bottom:1px solid rgba(255,107,107,0.15);">
        <span style="background:var(--accent2);color:var(--bg);font-family:'Space Mono',monospace;font-size:.65rem;font-weight:700;padding:2px 7px;border-radius:4px;white-space:nowrap;margin-top:1px;">${e.line?'LINE '+e.line:'GLOBAL'}</span>
        <span style="font-family:'Space Mono',monospace;font-size:.75rem;color:var(--accent2);line-height:1.5;">${e.msg}</span>
      </div>`).join('');

    // Show full error panel
    document.getElementById('ai-fix-btn').style.display='inline-block';
    analysisPanel.style.display='block';
    analysisContent.innerHTML=`
      <div style="background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.3);border-radius:14px;padding:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
          <div style="font-family:'Space Mono',monospace;font-size:.82rem;color:var(--accent2);font-weight:700;">‚ö†Ô∏è Syntax Errors Found</div>
          <button onclick="aiFixCode()" style="padding:6px 16px;border-radius:8px;background:rgba(167,139,250,.15);border:1.5px solid rgba(167,139,250,.4);color:var(--accent4);font-family:'Space Mono',monospace;font-size:.72rem;font-weight:700;cursor:pointer;">ü§ñ Auto Fix with AI</button>
        </div>
        <div style="font-family:'Space Mono',monospace;font-size:.75rem;color:var(--muted);line-height:1.7;">
          ${errors.map(e=>`<div style="margin-bottom:6px;padding:6px 10px;background:rgba(255,107,107,.06);border-radius:6px;border-left:3px solid var(--accent2);">‚Üí ${e.line?`<span style="color:var(--accent2)">Line ${e.line}:</span> `:''}${e.msg}<br><span style="color:var(--accent3);font-size:.65rem;">üí° ${getErrorFix(e.msg,e.line)}</span></div>`).join('')}
        </div>
        <div style="margin-top:14px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);">Fix errors above or use ü§ñ AI Fix to auto-correct the code.</div>
      </div>`;

    inputSection.style.display='none';
    generateSection.style.display='none';
    document.getElementById('parse-viz-container').innerHTML='';

  } else if(detected.length>0){
    // CLEAN CODE + DETECTED
    badge.style.display='inline-block';
    badge.textContent='‚úÖ Syntax OK';
    badge.style.background='rgba(0,245,196,0.15)';
    badge.style.color='var(--accent)';
    badge.style.border='1px solid rgba(0,245,196,0.3)';

    errorOverlay.style.display='none';
    pasteDetectedKey=detected[0].key;

    analysisPanel.style.display='block';
    analysisContent.innerHTML=`
      <div style="background:rgba(0,245,196,0.06);border:1px solid rgba(0,245,196,0.2);border-radius:14px;padding:20px;">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
          <div style="font-family:'Space Mono',monospace;font-size:.82rem;color:var(--accent);font-weight:700;">üîç Detected:</div>
          ${detected.map(d=>`<span style="padding:5px 14px;border-radius:99px;background:var(--accent);color:var(--bg);font-family:'Space Mono',monospace;font-size:.75rem;font-weight:700;">${ALGOS[d.key].name}</span>`).join('')}
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
          ${[
            ['Best',ALGOS[pasteDetectedKey].best,ALGOS[pasteDetectedKey].bc],
            ['Average',ALGOS[pasteDetectedKey].avg,ALGOS[pasteDetectedKey].ac],
            ['Worst',ALGOS[pasteDetectedKey].worst,ALGOS[pasteDetectedKey].wc],
            ['Space',ALGOS[pasteDetectedKey].space,ALGOS[pasteDetectedKey].sc],
          ].map(([label,val,cls])=>`
            <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:4px;">${label}</div>
              <div class="cx-val ${cls}" style="font-size:.9rem;">${val}</div>
            </div>`).join('')}
        </div>
      </div>`;

    inputSection.style.display='block';
    generateSection.style.display='block';
    document.getElementById('search-target-group').style.display=isSearch?'block':'none';
    document.getElementById('gen-hint').textContent=
      isSearch
        ? `Will search for your target in the sorted array using ${ALGOS[pasteDetectedKey].name}`
        : `Will sort your array using ${ALGOS[pasteDetectedKey].name}`;

    // Set default random array if empty
    if(!document.getElementById('array-input').value){
      genRandomInput();
    } else {
      renderArrayPreview();
    }
  } else {
    // CLEAN BUT UNRECOGNIZED
    badge.style.display='inline-block';
    badge.textContent='‚ö†Ô∏è Unknown Algorithm';
    badge.style.background='rgba(255,217,61,0.15)';
    badge.style.color='var(--accent3)';
    badge.style.border='1px solid rgba(255,217,61,0.3)';

    errorOverlay.style.display='none';
    analysisPanel.style.display='block';
    analysisContent.innerHTML=`
      <div style="background:rgba(255,217,61,0.07);border:1px solid rgba(255,217,61,0.25);border-radius:14px;padding:20px;">
        <div style="font-family:'Space Mono',monospace;font-size:.82rem;color:var(--accent3);font-weight:700;margin-bottom:8px;">‚ö†Ô∏è No recognized algorithm detected</div>
        <div style="font-family:'Space Mono',monospace;font-size:.75rem;color:var(--muted);line-height:1.7;">
          Syntax looks OK, but we couldn't match a known sort/search pattern.<br>
          Supported: selection_sort, bubble_sort, insertion_sort, merge_sort, quick_sort, heap_sort, shell_sort, counting_sort, binary_search, linear_search
        </div>
      </div>`;
    inputSection.style.display='none';
    generateSection.style.display='none';
    pasteDetectedKey=null;
  }
}

function genRandomInput(){
  const n=Math.floor(Math.random()*8)+6;
  const arr=Array.from({length:n},()=>Math.floor(Math.random()*90)+5);
  document.getElementById('array-input').value=arr.join(', ');
  renderArrayPreview();
}
function genSortedInput(){
  const n=10;
  const arr=Array.from({length:n},(_,i)=>Math.floor(Math.random()*10)+(i*8+5)).sort((a,b)=>a-b);
  document.getElementById('array-input').value=arr.join(', ');
  renderArrayPreview();
}
function genReversedInput(){
  genSortedInput();
  const vals=parseArrayInput();
  document.getElementById('array-input').value=[...vals].reverse().join(', ');
  renderArrayPreview();
}

function parseArrayInput(){
  const raw=document.getElementById('array-input').value;
  return raw.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
}

function validateArrayInput(){
  const raw=document.getElementById('array-input').value.trim();
  const errEl=document.getElementById('array-error');
  if(!raw){errEl.style.display='none';renderArrayPreview();return true;}
  const parts=raw.split(',');
  const invalid=parts.filter(p=>isNaN(parseInt(p.trim()))||p.trim()==='');
  if(invalid.length>0){
    errEl.textContent=`Invalid values: "${invalid.join('", "')}" ‚Äî use integers only`;
    errEl.style.display='block';
    return false;
  }
  const vals=parts.map(p=>parseInt(p.trim()));
  if(vals.length<2){errEl.textContent='Need at least 2 values';errEl.style.display='block';return false;}
  if(vals.length>30){errEl.textContent='Max 30 values for visualization';errEl.style.display='block';return false;}
  errEl.style.display='none';
  renderArrayPreview();
  return true;
}

function renderArrayPreview(){
  const preview=document.getElementById('array-preview');
  const vals=parseArrayInput();
  preview.innerHTML=vals.map((v,i)=>`
    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;text-align:center;min-width:42px;">
      <div style="font-family:'Space Mono',monospace;font-weight:700;font-size:.9rem;color:var(--text);">${v}</div>
      <div style="font-family:'Space Mono',monospace;font-size:.62rem;color:var(--muted);">[${i}]</div>
    </div>`).join('');
}

function generateVisualization(){
  if(!pasteDetectedKey)return;
  if(!validateArrayInput())return;
  const arr=parseArrayInput();
  if(arr.length<2)return;
  const key=pasteDetectedKey;
  const isSearch=key==='binary'||key==='linear';
  let inputArr=[...arr];
  if(isSearch)inputArr=[...arr].sort((a,b)=>a-b);

  const container=document.getElementById('parse-viz-container');
  container.innerHTML=`
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-top:4px;">
      <div style="padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
        <div style="font-family:'Space Mono',monospace;font-size:.78rem;color:var(--muted);">
          Visualizing: <span style="color:var(--accent);font-weight:700;">${ALGOS[key].name}</span>
          ${isSearch?`<span style="color:var(--muted);">  |  Target: <span style="color:var(--accent3);">${document.getElementById('target-input')?.value||inputArr[Math.floor(inputArr.length/2)]}</span></span>`:''}
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" id="pastePlay" onclick="pastePlayPause()">‚ñ∂ Play</button>
          <button class="btn btn-secondary" onclick="pasteStepFwd()">Step ‚Üí</button>
          <button class="btn btn-secondary" onclick="generateVisualization()">‚Ü∫ Reset</button>
        </div>
      </div>
      <div style="display:flex;gap:12px;padding:10px 18px;align-items:center;flex-wrap:wrap;">
        <label style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);">Speed</label>
        <input type="range" id="paste-speed" min="1" max="10" value="5" style="accent-color:var(--accent);width:100px;">
        <span style="font-family:'Space Mono',monospace;font-size:.72rem;color:var(--muted);">Step: <span id="paste-step-info" style="color:var(--accent);">0</span></span>
      </div>
      <canvas id="paste-canvas" style="display:block;background:var(--bg);width:100%;height:200px;"></canvas>
      <div style="padding:12px 18px;font-family:'Space Mono',monospace;font-size:.75rem;color:var(--muted);border-top:1px solid var(--border);min-height:44px;line-height:1.6;" id="paste-msg">Press Play or Step ‚Üí</div>
      <div style="display:flex;gap:20px;padding:10px 18px;border-top:1px solid var(--border);background:var(--card);flex-wrap:wrap;">
        <div class="stat">Comparisons: <span id="paste-cmps" style="color:var(--accent);font-weight:700;">0</span></div>
        <div class="stat">Swaps: <span id="paste-swps" style="color:var(--accent);font-weight:700;">0</span></div>
        <div class="stat">Status: <span id="paste-status" style="color:var(--accent);font-weight:700;">Ready</span></div>
      </div>
    </div>`;

  const ps=ALGOS[key].gen([...inputArr]);
  let pi=0,pp=false,piv=null,pCmps=0,pSwps=0;
  const pc=document.getElementById('paste-canvas');
  const pctx=pc.getContext('2d');
  drawVizStep(pc,pctx,ps,0,key);
  window._pasteState={ps,pi,pp,piv,pc,pctx,key,pCmps,pSwps};

  // Scroll to visualizer
  container.scrollIntoView({behavior:'smooth',block:'start'});
}

function pasteStepFwd(){
  const st=window._pasteState;
  if(!st||st.pi>=st.ps.length)return;
  const step=st.ps[st.pi];
  const prev=st.pi>0?st.ps[st.pi-1]:null;
  drawVizStep(st.pc,st.pctx,st.ps,st.pi,st.key);
  document.getElementById('paste-msg').textContent=step.msg||'';
  document.getElementById('paste-step-info').textContent=`${st.pi+1}/${st.ps.length}`;
  if(step.cmp&&step.cmp.length===2){st.pCmps++;document.getElementById('paste-cmps').textContent=st.pCmps;}
  if(prev&&JSON.stringify(prev.a)!==JSON.stringify(step.a)){st.pSwps++;document.getElementById('paste-swps').textContent=st.pSwps;}
  document.getElementById('paste-status').textContent=st.pi===st.ps.length-1?'Done ‚úì':'Running';
  st.pi++;
}

function pastePlayPause(){
  const st=window._pasteState;
  if(!st)return;
  st.pp=!st.pp;
  document.getElementById('pastePlay').textContent=st.pp?'‚è∏ Pause':'‚ñ∂ Play';
  if(st.pp){
    const spd=+document.getElementById('paste-speed').value;
    st.piv=setInterval(()=>{
      if(st.pi>=st.ps.length){
        clearInterval(st.piv);st.pp=false;
        document.getElementById('pastePlay').textContent='‚ñ∂ Play';
        document.getElementById('paste-status').textContent='Done ‚úì';
        return;
      }
      pasteStepFwd();
    },Math.round(1200/spd));
  }else{clearInterval(st.piv);}
}

function loadSample(key){
  document.getElementById('paste-code').value=SAMPLES[key]||'';
  onCodeInput();
}

function loadBrokenSample(){
  document.getElementById('paste-code').value=`def broken_sort(arr)
    n = len(arr
    for i in range(n):
        min_idx = i
        for j in range(i+1, n):
            if arr[j] < arr[min_idx]
                min_idx = j
        arr[i], arr[min_idx] == arr[min_idx], arr[i]
    retrun arr`;
  onCodeInput();
}

function clearPasteCode(){
  document.getElementById('paste-code').value='';
  document.getElementById('line-numbers').textContent='';
  document.getElementById('syntax-badge').style.display='none';
  document.getElementById('analysis-panel').style.display='none';
  document.getElementById('input-section').style.display='none';
  document.getElementById('generate-section').style.display='none';
  document.getElementById('error-overlay').style.display='none';
  document.getElementById('parse-viz-container').innerHTML='';
  document.getElementById('array-input').value='';
  document.getElementById('array-preview').innerHTML='';
  pasteDetectedKey=null;
}

// ============================================================
// COMPARE
// ============================================================
let cmpStepsA=[],cmpStepsB=[],cmpIdxA=0,cmpIdxB=0,cmpPlaying=false,cmpIv=null;
let cmpsCntA=0,cmpsCntB=0,swpsCntA=0,swpsCntB=0;

function initCompare(){
  if(cmpIv)clearInterval(cmpIv);
  cmpPlaying=false;document.getElementById('cmpPlayBtn').textContent='‚ñ∂ Race!';
  document.getElementById('winner-banner').style.display='none';
  const kA=document.getElementById('algoA').value;
  const kB=document.getElementById('algoB').value;
  const sz=+document.getElementById('compareSize').value;
  const shared=Array.from({length:sz},()=>Math.floor(Math.random()*90)+8);
  cmpStepsA=ALGOS[kA].gen([...shared]);
  cmpStepsB=ALGOS[kB].gen([...shared]);
  cmpIdxA=0;cmpIdxB=0;cmpsCntA=0;cmpsCntB=0;swpsCntA=0;swpsCntB=0;
  document.getElementById('panelATitle').innerHTML=`<span>A</span> ‚Äî ${ALGOS[kA].name}`;
  document.getElementById('panelBTitle').innerHTML=`<span style="color:var(--accent2)">B</span> ‚Äî ${ALGOS[kB].name}`;
  document.getElementById('raceALabel').textContent=ALGOS[kA].name;
  document.getElementById('raceBLabel').textContent=ALGOS[kB].name;
  ['cmpA','swpA','cmpB','swpB'].forEach(id=>document.getElementById(id).textContent='0');
  document.getElementById('msgA').textContent='Ready';
  document.getElementById('msgB').textContent='Ready';
  document.getElementById('raceFillA').style.width='0%';document.getElementById('raceFillA').textContent='0';
  document.getElementById('raceFillB').style.width='0%';document.getElementById('raceFillB').textContent='0';
  const cvA=document.getElementById('canvasA'),cvB=document.getElementById('canvasB');
  drawVizStep(cvA,cvA.getContext('2d'),cmpStepsA,0,kA);
  drawVizStep(cvB,cvB.getContext('2d'),cmpStepsB,0,kB);
}

function drawCmpStep(which){
  const idx=which==='A'?cmpIdxA:cmpIdxB;
  const stps=which==='A'?cmpStepsA:cmpStepsB;
  const kA=document.getElementById('algoA').value;
  const kB=document.getElementById('algoB').value;
  const key=which==='A'?kA:kB;
  const cv=document.getElementById('canvas'+which);
  drawVizStep(cv,cv.getContext('2d'),stps,idx,key);
  const step=stps[Math.min(idx,stps.length-1)];
  document.getElementById('msg'+which).textContent=step.msg||'';
  const prev=idx>0?stps[idx-1]:null;
  if(step.cmp&&step.cmp.length===2){
    if(which==='A'){cmpsCntA++;document.getElementById('cmpA').textContent=cmpsCntA;}
    else{cmpsCntB++;document.getElementById('cmpB').textContent=cmpsCntB;}
  }
  if(prev&&JSON.stringify(prev.a)!==JSON.stringify(step.a)){
    if(which==='A'){swpsCntA++;document.getElementById('swpA').textContent=swpsCntA;}
    else{swpsCntB++;document.getElementById('swpB').textContent=swpsCntB;}
  }
  const maxCmp=Math.max(cmpsCntA,cmpsCntB,1);
  document.getElementById('raceFillA').style.width=`${(cmpsCntA/maxCmp)*100}%`;
  document.getElementById('raceFillA').textContent=cmpsCntA;
  document.getElementById('raceFillB').style.width=`${(cmpsCntB/maxCmp)*100}%`;
  document.getElementById('raceFillB').textContent=cmpsCntB;
}

function compareStepForward(){
  let doneA=cmpIdxA>=cmpStepsA.length,doneB=cmpIdxB>=cmpStepsB.length;
  if(!doneA){drawCmpStep('A');cmpIdxA++;}
  if(!doneB){drawCmpStep('B');cmpIdxB++;}
  if(cmpIdxA>=cmpStepsA.length&&cmpIdxB>=cmpStepsB.length)showWinner();
}

function comparePlayPause(){
  cmpPlaying=!cmpPlaying;
  document.getElementById('cmpPlayBtn').textContent=cmpPlaying?'‚è∏ Pause':'‚ñ∂ Race!';
  if(cmpPlaying){
    const spd=+document.getElementById('cmpSpeed').value;
    cmpIv=setInterval(()=>{
      const dA=cmpIdxA>=cmpStepsA.length,dB=cmpIdxB>=cmpStepsB.length;
      if(dA&&dB){clearInterval(cmpIv);cmpPlaying=false;document.getElementById('cmpPlayBtn').textContent='‚ñ∂ Race!';showWinner();return;}
      compareStepForward();
    },Math.round(1200/spd));
  }else{clearInterval(cmpIv);}
}

function showWinner(){
  const kA=document.getElementById('algoA').value;
  const kB=document.getElementById('algoB').value;
  const wb=document.getElementById('winner-banner');
  wb.style.display='block';
  if(cmpsCntA<cmpsCntB){
    document.getElementById('winner-text').innerHTML=`üèÜ ${ALGOS[kA].name} wins on comparisons!`;
    wb.style.borderColor='var(--accent)';
  }else if(cmpsCntB<cmpsCntA){
    document.getElementById('winner-text').innerHTML=`üèÜ ${ALGOS[kB].name} wins on comparisons!`;
    wb.style.borderColor='var(--accent2)';
  }else{
    document.getElementById('winner-text').innerHTML=`ü§ù Tie on comparisons!`;
    wb.style.borderColor='var(--accent3)';
  }
  document.getElementById('winner-stats').textContent=
    `${ALGOS[kA].name}: ${cmpsCntA} comparisons, ${swpsCntA} swaps  |  ${ALGOS[kB].name}: ${cmpsCntB} comparisons, ${swpsCntB} swaps`;
}

// ============================================================
// SLIDE VIEW
// ============================================================
const ALGO_TIPS = {
  selection: "Selection Sort always makes exactly n-1 swaps ‚Äî the fewest of any comparison sort! That's why it's used when write operations are expensive.",
  bubble:    "Bubble Sort gets its name from the way large elements 'bubble' to the top of the list each pass ‚Äî just like air bubbles rising in water!",
  insertion: "Insertion Sort is the algorithm most humans use to sort playing cards in their hands ‚Äî pick a card, find its spot, insert it!",
  merge:     "Merge Sort was invented by John von Neumann in 1945. It's used in many language standard libraries, including Python's sorted() function!",
  quick:     "Quick Sort is usually 2-3x faster than Merge Sort in practice despite the same average complexity ‚Äî because of better cache performance!",
  heap:      "Heap Sort uses a binary heap data structure. It guarantees O(n log n) in the worst case, unlike Quick Sort which can degrade to O(n¬≤).",
  shell:     "Shell Sort is an improvement over Insertion Sort invented by Donald Shell in 1959. The gap sequence choice dramatically affects performance!",
  counting:  "Counting Sort is NOT a comparison sort ‚Äî it counts occurrences instead! It can sort n integers in O(n) time if values are bounded.",
  radix:     "Radix Sort was used to sort punched cards in early computers! It can beat comparison sorts when digit count k is small relative to n.",
  tim:       "Tim Sort is the default sort in Python (since 2.3) and Java (since 7)! It's optimized for real-world data which often has naturally-occurring sorted runs.",
  cycle:     "Cycle Sort makes the absolute minimum number of writes to memory among all sorting algorithms. Perfect for NAND flash memory with limited write cycles!",
  binary:    "Binary Search halves the search space each step. Searching 1 billion items takes at most 30 comparisons ‚Äî log‚ÇÇ(10‚Åπ) ‚âà 30!",
  linear:    "Linear Search is the only option for unsorted data. On average it checks n/2 elements. Binary Search needs the array sorted first.",
  jump:      "Jump Search finds the optimal block in O(‚àön) jumps, then does linear search. For n=10,000 it takes at most 100+100=200 steps vs 10,000 for linear!",
  interpolation: "Interpolation Search can find elements in O(log log n) for uniformly distributed data ‚Äî extremely fast! But degrades to O(n) for non-uniform data.",
};

const SLIDE_PSEUDOCODE = {
  selection: [
    'for i = 0 to n-1:',
    '    min_idx = i',
    '    for j = i+1 to n-1:',
    '        if arr[j] < arr[min_idx]:',
    '            min_idx = j',
    '    swap arr[i] with arr[min_idx]',
  ],
  bubble: [
    'for i = 0 to n-1:',
    '    for j = 0 to n-i-2:',
    '        if arr[j] > arr[j+1]:',
    '            swap arr[j] with arr[j+1]',
    '    if no swap: break',
  ],
  insertion: [
    'for i = 1 to n-1:',
    '    key = arr[i]',
    '    j = i - 1',
    '    while j >= 0 and arr[j] > key:',
    '        arr[j+1] = arr[j]',
    '        j = j - 1',
    '    arr[j+1] = key',
  ],
  merge: [
    'merge_sort(arr):',
    '    if len(arr) <= 1: return',
    '    mid = len(arr) // 2',
    '    left = merge_sort(arr[:mid])',
    '    right = merge_sort(arr[mid:])',
    '    return merge(left, right)',
  ],
  quick: [
    'quick_sort(arr, low, high):',
    '    if low < high:',
    '        pivot = arr[high]',
    '        partition around pivot',
    '        quick_sort(left of pivot)',
    '        quick_sort(right of pivot)',
  ],
  heap: [
    'build max-heap from arr',
    'for i = n-1 to 1:',
    '    swap arr[0] with arr[i]',
    '    heapify(arr, i, 0)',
  ],
  shell: [
    'gap = n // 2',
    'while gap > 0:',
    '    insertion sort with gap',
    '    gap = gap // 2',
  ],
  counting: [
    'count = array of zeros [0..max]',
    'for num in arr:',
    '    count[num] += 1',
    'rebuild arr from count',
  ],
  binary: [
    'left = 0, right = n-1',
    'while left <= right:',
    '    mid = (left + right) // 2',
    '    if arr[mid] == target: return mid',
    '    elif arr[mid] < target: left = mid+1',
    '    else: right = mid-1',
    'return -1 (not found)',
  ],
  linear: [
    'for i = 0 to n-1:',
    '    if arr[i] == target:',
    '        return i',
    'return -1 (not found)',
  ],
};

// Map step codeLine ‚Üí pseudocode line (approximate)
const PSEUDO_MAP = {
  selection: {3:1, 4:2, 5:3, 6:4, 7:5},
  bubble:    {3:0, 4:1, 5:2, 6:3, 7:4},
  insertion: {1:0, 2:1, 3:2, 4:3, 5:4, 6:5, 7:6},
  merge:     {1:1, 2:2, 3:3, 4:4, 5:5, 10:5},
  quick:     {6:2, 7:3, 8:3, 9:4},
  heap:      {2:0, 3:0, 5:2, 6:3, 9:3, 10:3},
  shell:     {2:1, 4:2, 6:2, 8:3, 9:3},
  counting:  {1:0, 3:1, 4:2, 6:3, 7:3},
  binary:    {1:0, 3:2, 4:3, 7:4, 8:5},
  linear:    {1:0, 2:1, 3:2},
};

// Phase labels
function getPhase(step, algo){
  if(!step) return {label:'READY', color:'var(--muted)', bg:'rgba(107,107,138,.15)'};
  const n=step.a.length;
  if(step.su===n-1) return {label:'COMPLETE ‚úì', color:'var(--accent)', bg:'rgba(0,245,196,.15)'};
  if(step.found>=0) return {label:'FOUND! ‚úì', color:'var(--accent)', bg:'rgba(0,245,196,.15)'};
  if(step.cmp&&step.cmp.length===2) return {label:'COMPARING', color:'#ff6b6b', bg:'rgba(255,107,107,.15)'};
  if(step.hi>=0&&step.cmp&&!step.cmp.length) return {label:'SELECTING', color:'#ffd93d', bg:'rgba(255,217,61,.15)'};
  return {label:'PROCESSING', color:'var(--accent4)', bg:'rgba(167,139,250,.15)'};
}

// Big human-readable title per step
function getSlideTitle(step, algo){
  if(!step) return 'Ready to begin';
  const n=step.a.length;
  if(step.su===n-1) return 'üéâ Array is fully <em>sorted!</em>';
  if(step.found>=0) return `üéØ Found at index <em>${step.found}</em>!`;
  if(step.cmp&&step.cmp.length===2){
    const [a,b]=step.cmp;
    return `Comparing <em>${step.a[a]}</em> and <em>${step.a[b]}</em>`;
  }
  if(step.hi>=0) return `Minimum so far: <em>${step.a[step.hi]}</em>`;
  return step.msg||'Processing...';
}

// ============================================================
// VOICE NARRATION
// ============================================================
let voiceLang = 'en';
let synth = window.speechSynthesis;
let currentUtterance = null;
let voiceEN = null, voiceHI = null;

function loadVoices(){
  const voices = synth.getVoices();
  voiceEN = voices.find(v=>v.lang.startsWith('en')) || voices[0];
  voiceHI = voices.find(v=>v.lang.startsWith('hi-IN')||v.lang==='hi') || voiceEN;
}
if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged=loadVoices;
setTimeout(loadVoices,300);

function setLang(lang){
  voiceLang=lang;
  document.getElementById('lang-en').classList.toggle('active',lang==='en');
  document.getElementById('lang-hi').classList.toggle('active',lang==='hi');
  document.getElementById('voice-lang-tag').textContent=lang==='en'?'EN':'HI';
  stopSpeaking();
}

// Narration scripts
const NARRATE = {
  en: {
    selection: {
      start:      (arr)=>`We will use Selection Sort to sort ${arr.length} numbers. In each pass, we find the smallest unsorted element and place it in its correct position.`,
      compare:    (a,b)=>`Comparing ${a} and ${b}. Which one is smaller?`,
      newMin:     (v,i)=>`${v} is smaller! This is our new minimum at index ${i}.`,
      swap:       (a,b,i)=>`Swapping ${a} with ${b}. The smallest value ${b} goes to position ${i}.`,
      placed:     (v,i)=>`${v} is now correctly placed at index ${i}. This position is sorted.`,
      done:       ()=>`Excellent! The array is fully sorted using Selection Sort. We made exactly n minus 1 swaps!`,
    },
    bubble: {
      start:      (arr)=>`We will use Bubble Sort on ${arr.length} numbers. Large elements bubble to the right in each pass.`,
      compare:    (a,b)=>`Comparing ${a} and ${b}. Is ${a} greater than ${b}?`,
      swap:       (a,b)=>`Yes! ${a} is greater than ${b}, so we swap them. ${b} bubbles to the left.`,
      noSwap:     ()=>`No swap needed here. These two are already in the right order.`,
      passEnd:    (i)=>`Pass ${i} complete. The largest unsorted element has reached its correct position.`,
      done:       ()=>`Array sorted! Bubble sort finished. Each element has bubbled to its correct place.`,
    },
    insertion: {
      start:      (arr)=>`Insertion Sort on ${arr.length} elements. We pick each element and insert it into the correct position, like sorting playing cards.`,
      pick:       (v,i)=>`Picking element ${v} from index ${i}. We will find its correct position.`,
      shift:      (a,b)=>`${a} is greater than our key ${b}. Shifting ${a} one position to the right.`,
      insert:     (v,i)=>`Inserting ${v} at index ${i}. It is now in its correct sorted position.`,
      done:       ()=>`Sorted! Insertion sort works just like how you arrange playing cards in your hand.`,
    },
    merge: {
      start:      (arr)=>`Merge Sort on ${arr.length} elements. We divide the array in half, sort each half, then merge them back together.`,
      compare:    (a,b)=>`Merging: comparing ${a} from the left half with ${b} from the right half.`,
      merge:      (n,off)=>`Merged ${n} elements at offset ${off}. The subarray is now sorted.`,
      done:       ()=>`Merge Sort complete! This algorithm always runs in n log n time, making it very efficient.`,
    },
    quick: {
      start:      (arr)=>`Quick Sort on ${arr.length} elements. We pick a pivot element and partition the array around it.`,
      pivot:      (v,i)=>`Pivot is ${v} at index ${i}. All elements smaller will go left, larger will go right.`,
      compare:    (a,b)=>`Is ${a} less than or equal to pivot ${b}?`,
      swap:       (a,b)=>`Yes! Swapping to move ${a} to the left partition.`,
      placed:     (v,i)=>`Pivot ${v} is placed at its correct position ${i}. Everything left is smaller, everything right is larger.`,
      done:       ()=>`Quick Sort complete! On average, this is one of the fastest sorting algorithms in practice.`,
    },
    heap: {
      start:      (arr)=>`Heap Sort on ${arr.length} elements. First we build a max-heap, then extract the maximum element repeatedly.`,
      heapify:    (i)=>`Heapifying at index ${i}. Making sure the parent is larger than its children.`,
      swap:       (a,b)=>`Swapping root ${a} with last element ${b}. The largest element moves to its sorted position.`,
      done:       ()=>`Heap Sort complete! It always guarantees n log n time in the worst case.`,
    },
    shell: {
      start:      (arr)=>`Shell Sort on ${arr.length} elements. We sort elements far apart first, then reduce the gap.`,
      gap:        (g)=>`Current gap is ${g}. We will do an insertion sort with this gap size.`,
      compare:    (a,b)=>`Comparing ${a} and ${b} which are ${g} positions apart.`,
      done:       ()=>`Shell Sort complete! It is much faster than simple insertion sort for larger arrays.`,
    },
    counting: {
      start:      (arr)=>`Counting Sort on ${arr.length} elements. We count how many times each value appears, then rebuild the array.`,
      count:      (v,c)=>`Counting value ${v}. It has appeared ${c} times so far.`,
      rebuild:    ()=>`Counting done! Now rebuilding the sorted array from the count table.`,
      done:       ()=>`Counting Sort complete! This runs in linear time when values are bounded ‚Äî no comparisons needed!`,
    },
    binary: {
      start:      (arr,t)=>`Binary Search for target ${t} in ${arr.length} sorted elements. We halve the search space each step.`,
      check:      (mid,v,t)=>`Checking middle index ${mid}, value ${v}. Target is ${t}.`,
      goRight:    (v,t)=>`${v} is less than ${t}. The target must be in the right half. Eliminating left half.`,
      goLeft:     (v,t)=>`${v} is greater than ${t}. The target must be in the left half. Eliminating right half.`,
      found:      (v,i)=>`Found ${v} at index ${i}! Binary Search succeeded.`,
      done:       ()=>`Binary Search is incredibly fast. For a million elements, it takes at most 20 steps!`,
    },
    linear: {
      start:      (arr,t)=>`Linear Search for target ${t} in ${arr.length} elements. We check each element one by one.`,
      check:      (v,i,t)=>`Checking index ${i}, value ${v}. Is it equal to target ${t}?`,
      found:      (v,i)=>`Found ${v} at index ${i}! Linear Search succeeded.`,
      done:       ()=>`Linear Search complete. It works on unsorted arrays but can be slow for large datasets.`,
    },
  },

  hi: {
    selection: {
      start:      (arr)=>`Hum Selection Sort use karenge ${arr.length} numbers ko sort karne ke liye. Har baar hum sabse chhota element dhundhte hain aur usse sahi jagah rakhte hain.`,
      compare:    (a,b)=>`${a} aur ${b} ko compare kar rahe hain. Kaun chhota hai?`,
      newMin:     (v,i)=>`${v} chhota hai! Yeh hamara naya minimum hai, index ${i} par.`,
      swap:       (a,b,i)=>`${a} aur ${b} ko swap kar rahe hain. Sabse chhota element ${b} position ${i} par ja raha hai.`,
      placed:     (v,i)=>`${v} ab sahi jagah hai, index ${i} par. Yeh position sorted ho gayi.`,
      done:       ()=>`Bahut achha! Array puri tarah sort ho gayi. Selection Sort mein hamesha sirf n minus 1 swaps hote hain!`,
    },
    bubble: {
      start:      (arr)=>`Hum Bubble Sort karenge ${arr.length} numbers par. Bade elements har pass mein dahine taraf bubble karte hain.`,
      compare:    (a,b)=>`${a} aur ${b} ko compare kar rahe hain. Kya ${a}, ${b} se bada hai?`,
      swap:       (a,b)=>`Haan! ${a}, ${b} se bada hai, isliye swap kar rahe hain. ${b} baayi taraf aa gaya.`,
      noSwap:     ()=>`Yahan swap ki zaroorat nahi. Ye dono pehle se sahi order mein hain.`,
      passEnd:    (i)=>`Pass ${i} khatam hua. Sabse bada unsorted element apni sahi jagah pahunch gaya.`,
      done:       ()=>`Array sort ho gayi! Bubble sort mein har element apni sahi jagah bubble karke pahuncha.`,
    },
    insertion: {
      start:      (arr)=>`Insertion Sort ${arr.length} elements par. Hum har element ko uthate hain aur sahi jagah insert karte hain, jaise taash ke patte sort karna.`,
      pick:       (v,i)=>`Index ${i} se element ${v} uthaya. Ab hum iska sahi position dhundhenge.`,
      shift:      (a,b)=>`${a} hamari key ${b} se bada hai. ${a} ko ek jagah daayein shift kar rahe hain.`,
      insert:     (v,i)=>`${v} ko index ${i} par insert kar diya. Yeh ab apni sahi sorted position par hai.`,
      done:       ()=>`Sort ho gayi! Insertion Sort bilkul waise hi kaam karta hai jaise aap taash ke paaton ko haath mein arrange karte hain.`,
    },
    merge: {
      start:      (arr)=>`Merge Sort ${arr.length} elements par. Hum array ko aadha-aadha divide karte hain, phir sort karke wapas milate hain.`,
      compare:    (a,b)=>`Merge ho rahi hai: left half se ${a} aur right half se ${b} compare ho rahe hain.`,
      merge:      (n,off)=>`${n} elements offset ${off} par merge ho gaye. Yeh subarray ab sort hai.`,
      done:       ()=>`Merge Sort complete! Yeh algorithm hamesha n log n time mein kaam karta hai.`,
    },
    quick: {
      start:      (arr)=>`Quick Sort ${arr.length} elements par. Hum ek pivot choose karte hain aur array ko uske aas-paas partition karte hain.`,
      pivot:      (v,i)=>`Pivot ${v} hai, index ${i} par. Chhote elements baayen jayenge, bade elements daayein.`,
      compare:    (a,b)=>`Kya ${a}, pivot ${b} se chhota ya barabar hai?`,
      swap:       (a,b)=>`Haan! ${a} ko baayen partition mein shift karne ke liye swap kar rahe hain.`,
      placed:     (v,i)=>`Pivot ${v} apni sahi jagah ${i} par aa gaya. Baayen sab chhote hain, daayein sab bade hain.`,
      done:       ()=>`Quick Sort complete! Yeh generally sab sorting algorithms mein sabse fast hota hai.`,
    },
    heap: {
      start:      (arr)=>`Heap Sort ${arr.length} elements par. Pehle max-heap banate hain, phir baar baar maximum element nikalte hain.`,
      heapify:    (i)=>`Index ${i} par heapify kar rahe hain. Parent apne children se bada hona chahiye.`,
      swap:       (a,b)=>`Root ${a} ko last element ${b} se swap kar rahe hain. Sabse bada element sahi jagah pahuncha.`,
      done:       ()=>`Heap Sort complete! Yeh worst case mein bhi hamesha n log n time deta hai.`,
    },
    shell: {
      start:      (arr)=>`Shell Sort ${arr.length} elements par. Pehle door-door ke elements sort karte hain, phir gap kam karte hain.`,
      gap:        (g)=>`Abhi gap ${g} hai. Is gap ke saath insertion sort karenge.`,
      compare:    (a,b)=>`${a} aur ${b} jo ${g} positions door hain, unhe compare kar rahe hain.`,
      done:       ()=>`Shell Sort complete! Yeh simple insertion sort se kaafi faster hai bade arrays ke liye.`,
    },
    counting: {
      start:      (arr)=>`Counting Sort ${arr.length} elements par. Hum pehle count karte hain ki har value kitni baar aayi, phir array rebuild karte hain.`,
      count:      (v,c)=>`Value ${v} ko count kar rahe hain. Yeh ab tak ${c} baar aayi hai.`,
      rebuild:    ()=>`Counting ho gayi! Ab count table se sorted array bana rahe hain.`,
      done:       ()=>`Counting Sort complete! Yeh linear time mein kaam karta hai, koi comparison nahi!`,
    },
    binary: {
      start:      (arr,t)=>`Binary Search se ${arr.length} sorted elements mein ${t} dhundh rahe hain. Har step mein search space aadhi ho jaati hai.`,
      check:      (mid,v,t)=>`Middle index ${mid} dekh rahe hain, value ${v} hai. Target ${t} hai.`,
      goRight:    (v,t)=>`${v}, target ${t} se chhota hai. Target daayeni taraf hoga. Baayi taraf hatao.`,
      goLeft:     (v,t)=>`${v}, target ${t} se bada hai. Target baayen taraf hoga. Daayein taraf hatao.`,
      found:      (v,i)=>`${v} index ${i} par mila! Binary Search safal raha.`,
      done:       ()=>`Binary Search bahut fast hai. Ek billion elements mein bhi sirf 30 steps mein khatam ho jaata hai!`,
    },
    linear: {
      start:      (arr,t)=>`Linear Search se ${arr.length} elements mein ${t} dhundh rahe hain. Hum ek ek element check karenge.`,
      check:      (v,i,t)=>`Index ${i} check kar rahe hain, value ${v}. Kya yeh target ${t} ke barabar hai?`,
      found:      (v,i)=>`${v} index ${i} par mila! Linear Search safal raha.`,
      done:       ()=>`Linear Search complete. Yeh unsorted arrays par kaam karta hai lekin bade datasets mein slow hota hai.`,
    },
  }
};

function getNarration(step, idx, algo, lang){
  const s=NARRATE[lang]||NARRATE['en'];
  const n=s[algo]||s['selection'];
  const arr=step.a;
  const total=arr.length;
  const isSearch=ALGOS[algo].type==='search';

  if(idx===0) {
    if(isSearch) return (n.start||n.start)(arr, step.a[Math.floor(arr.length/2)]);
    return n.start(arr);
  }
  if(step.su===total-1) return n.done();
  if(step.found>=0) return n.found?n.found(arr[step.found],step.found):step.msg;

  const prev=slSteps[idx-1];
  const didSwap=prev&&JSON.stringify(prev.a)!==JSON.stringify(step.a);

  // Algo-specific narrations
  switch(algo){
    case 'selection':
      if(step.cmp&&step.cmp.length===2) return n.compare(step.a[step.cmp[0]],step.a[step.cmp[1]]);
      if(step.hi>=0&&!step.cmp?.length&&!didSwap) return n.newMin(step.a[step.hi],step.hi);
      if(didSwap&&step.cmp?.length===2) return n.swap(prev.a[step.cmp[0]],step.a[step.cmp[0]],step.cmp[0]);
      if(step.su>=0) return n.placed(step.a[step.su],step.su);
      break;
    case 'bubble':
      if(step.cmp&&step.cmp.length===2) return didSwap?n.swap(prev.a[step.cmp[0]],step.a[step.cmp[0]]):n.compare(step.a[step.cmp[0]],step.a[step.cmp[1]]);
      if(step.su>=0) return n.passEnd(step.su+1);
      break;
    case 'insertion':
      if(step.hi>=0&&!step.cmp?.length) return n.pick(step.a[step.hi],step.hi);
      if(step.cmp&&step.cmp.length===2&&!didSwap) return n.shift(step.a[step.cmp[0]],step.a[step.hi]||'key');
      if(step.hi>=0&&step.su>=0) return n.insert(step.a[step.hi],step.hi);
      break;
    case 'merge':
      if(step.cmp&&step.cmp.length===2) return n.compare(step.a[step.cmp[0]],step.a[step.cmp[1]]);
      return n.merge(step.a.length, 0);
    case 'quick':
      if(step.hi>=0&&step.cmp?.length===1) return n.pivot(step.a[step.hi],step.hi);
      if(step.cmp&&step.cmp.length===2) return didSwap?n.swap(prev.a[step.cmp[0]],step.a[step.cmp[0]]):n.compare(step.a[step.cmp[0]],step.a[step.cmp[1]]);
      if(step.hi>=0) return n.placed(step.a[step.hi],step.hi);
      break;
    case 'heap':
      if(step.cmp&&step.cmp.length===2) return didSwap?n.swap(prev.a[step.cmp[0]],step.a[step.cmp[0]]):n.heapify(step.cmp[0]);
      break;
    case 'binary':
      if(step.cmp&&step.cmp.length===1){
        const mid=step.cmp[0],v=step.a[mid];
        const t=step.a[step.hi]||v;
        if(step.hi===mid) return n.check(mid,v,t);
        if(v<t) return n.goRight(v,t);
        return n.goLeft(v,t);
      }
      break;
    case 'linear':
      if(step.cmp&&step.cmp.length===1) return n.check(step.a[step.cmp[0]],step.cmp[0], step.a[step.hi]||'target');
      break;
    case 'counting':
      if(step.cmp&&step.cmp.length===1) return n.count(step.a[step.cmp[0]],1);
      if(step.su===step.a.length-1) return n.rebuild();
      break;
    case 'shell':
      if(step.msg&&step.msg.startsWith('Gap')) return n.gap(step.msg.match(/\d+/)?.[0]||'');
      if(step.cmp&&step.cmp.length===2) return n.compare(step.a[step.cmp[0]],step.a[step.cmp[1]]);
      break;
  }
  return step.msg||'Processing...';
}

// speakText returns a Promise that resolves when speech finishes (or immediately if disabled)
function speakText(text, onDone){
  stopSpeaking();
  if(!synth||!text){if(onDone)onDone();return;}
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang=voiceLang==='hi'?'hi-IN':'en-US';
  utter.rate=voiceLang==='hi'?0.88:0.92;
  utter.pitch=1.05;
  if(voiceLang==='hi'&&voiceHI) utter.voice=voiceHI;
  else if(voiceEN) utter.voice=voiceEN;

  const btn=document.getElementById('speak-btn');
  const bubble=document.getElementById('voice-bubble');
  const bubbleText=document.getElementById('voice-bubble-text');
  if(btn){
    btn.classList.add('speaking');
    btn.innerHTML=`<span class="wave"><span></span><span></span><span></span><span></span></span> <span id="speak-label">Speaking...</span>`;
  }
  if(bubble){bubble.style.display='block';}
  if(bubbleText){bubbleText.textContent=text;}

  utter.onend=()=>{
    if(btn){btn.classList.remove('speaking');btn.innerHTML=`<span id="speak-icon">üîä</span> <span id="speak-label">Speak Step</span>`;}
    if(onDone)onDone();
  };
  utter.onerror=()=>{
    if(btn){btn.classList.remove('speaking');btn.innerHTML=`<span id="speak-icon">üîä</span> <span id="speak-label">Speak Step</span>`;}
    if(onDone)onDone();
  };
  currentUtterance=utter;
  synth.speak(utter);
}

function stopSpeaking(){
  if(synth) synth.cancel();
  const btn=document.getElementById('speak-btn');
  if(btn){btn.classList.remove('speaking');btn.innerHTML=`<span id="speak-icon">üîä</span> <span id="speak-label">Speak Step</span>`;}
}

function speakCurrent(){
  if(!slSteps.length) return;
  const idx=Math.max(0,slIdx-1);
  const step=slSteps[Math.min(idx,slSteps.length-1)];
  const text=getNarration(step,idx,slAlgo,voiceLang);
  speakText(text);
}

// ============================================================
// SLIDE IMAGE EXPORT
// ============================================================
function drawSlideToCanvas(idx){
  const W=900, H=520;
  const cvs=document.createElement('canvas');
  cvs.width=W; cvs.height=H;
  const c=cvs.getContext('2d');
  const step=slSteps[Math.min(idx,slSteps.length-1)];
  const algo=slAlgo;
  const n=step.a.length;
  const isSearch=ALGOS[algo].type==='search';
  const cfg=ALGOS[algo];

  // Background
  c.fillStyle='#0a0a0f';
  c.fillRect(0,0,W,H);

  // Grid pattern
  c.strokeStyle='rgba(0,245,196,0.04)';
  c.lineWidth=1;
  for(let x=0;x<W;x+=60){c.beginPath();c.moveTo(x,0);c.lineTo(x,H);c.stroke();}
  for(let y=0;y<H;y+=60){c.beginPath();c.moveTo(0,y);c.lineTo(W,y);c.stroke();}

  // Header bar
  c.fillStyle='#12121a';
  c.fillRect(0,0,W,54);
  c.strokeStyle='#2a2a3e';c.lineWidth=1;
  c.beginPath();c.moveTo(0,54);c.lineTo(W,54);c.stroke();

  // Logo
  c.font='bold 18px Syne,sans-serif';
  c.fillStyle='#e8e8f0';
  c.textAlign='left';
  c.fillText('Algo',20,34);
  c.fillStyle='#00f5c4';
  c.fillText('Viz',70,34);

  // Algo name
  c.font='bold 16px Syne,sans-serif';
  c.fillStyle='#00f5c4';
  c.textAlign='center';
  c.fillText(cfg.name, W/2, 34);

  // Slide counter
  c.font='13px Space Mono,monospace';
  c.fillStyle='#6b6b8a';
  c.textAlign='right';
  c.fillText(`Slide ${idx+1} / ${slSteps.length}`, W-20, 34);

  // Step message / title
  const title = step.su===n-1?'Array Fully Sorted! ‚úì':
                step.found>=0?`Found at index ${step.found}!`:
                step.cmp&&step.cmp.length===2?`Comparing ${step.a[step.cmp[0]]} and ${step.a[step.cmp[1]]}`:
                step.msg||'Processing...';
  c.font='bold 22px Syne,sans-serif';
  c.fillStyle='#e8e8f0';
  c.textAlign='center';
  c.fillText(title.replace(/<[^>]+>/g,''), W/2, 90);

  // Array cells
  const gap=8, cellH=68, cellW=Math.min(70,(W-80-gap*(n-1))/n);
  const totalW=n*cellW+(n-1)*gap;
  const startX=(W-totalW)/2;
  const cellY=115;

  step.a.forEach((val,i)=>{
    const isSorted=step.su===n-1||(step.su>=0&&i<=step.su&&!isSearch);
    const isComp=step.cmp&&step.cmp.includes(i);
    const isHi=step.hi===i;
    const isFound=step.found===i;
    const inRange=isSearch&&step.range&&i>=step.range[0]&&i<=step.range[1];

    let fill,border,text;
    if(isFound){fill='rgba(0,245,196,.3)';border='#00f5c4';text='#00f5c4';}
    else if(step.su===n-1&&!isSearch){fill='rgba(0,245,196,.15)';border='#00f5c4';text='#00f5c4';}
    else if(isComp){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
    else if(isHi){fill='rgba(255,217,61,.22)';border='#ffd93d';text='#ffd93d';}
    else if(isSorted){fill='rgba(0,245,196,.1)';border='rgba(0,245,196,.35)';text='#00f5c4';}
    else if(inRange){fill='rgba(167,139,250,.18)';border='#a78bfa';text='#a78bfa';}
    else{fill='rgba(58,58,110,.5)';border='#3a3a6e';text='#7070aa';}

    const x=startX+i*(cellW+gap);
    const rr=10;

    if(isComp||isHi||isFound){c.shadowColor=border;c.shadowBlur=16;}else{c.shadowBlur=0;}

    c.fillStyle=fill;
    c.strokeStyle=border;c.lineWidth=2.5;
    c.beginPath();
    c.moveTo(x+rr,cellY);c.lineTo(x+cellW-rr,cellY);
    c.quadraticCurveTo(x+cellW,cellY,x+cellW,cellY+rr);
    c.lineTo(x+cellW,cellY+cellH-rr);
    c.quadraticCurveTo(x+cellW,cellY+cellH,x+cellW-rr,cellY+cellH);
    c.lineTo(x+rr,cellY+cellH);
    c.quadraticCurveTo(x,cellY+cellH,x,cellY+cellH-rr);
    c.lineTo(x,cellY+rr);
    c.quadraticCurveTo(x,cellY,x+rr,cellY);
    c.closePath();c.fill();c.stroke();
    c.shadowBlur=0;

    c.fillStyle=text;
    c.font=`bold ${Math.min(20,cellW*0.34)}px Space Mono,monospace`;
    c.textAlign='center';c.textBaseline='middle';
    c.fillText(val,x+cellW/2,cellY+cellH/2);

    // Labels
    if(isComp){c.fillStyle='#ff6b6b';c.font='bold 9px Space Mono,monospace';c.fillText('CMP',x+cellW/2,cellY-10);}
    else if(isHi&&!isComp){c.fillStyle='#ffd93d';c.font='bold 9px Space Mono,monospace';c.fillText('MIN',x+cellW/2,cellY-10);}
    else if(isFound){c.fillStyle='#00f5c4';c.font='bold 9px Space Mono,monospace';c.fillText('FOUND',x+cellW/2,cellY-10);}
    c.fillStyle='#3a3a5e';c.font='10px Space Mono,monospace';c.textBaseline='alphabetic';
    c.fillText(`[${i}]`,x+cellW/2,cellY+cellH+16);
  });

  // Dashed compare line
  if(step.cmp&&step.cmp.length===2){
    const [i1,i2]=step.cmp;
    const x1=startX+i1*(cellW+gap)+cellW/2;
    const x2=startX+i2*(cellW+gap)+cellW/2;
    c.strokeStyle='rgba(255,107,107,0.45)';c.lineWidth=1.5;
    c.setLineDash([5,5]);
    c.beginPath();c.moveTo(x1,cellY-18);c.lineTo(x2,cellY-18);c.stroke();
    c.setLineDash([]);
  }

  // Step explanation box
  const boxY=cellY+cellH+30;
  c.fillStyle='#1a1a26';
  c.strokeStyle='#2a2a3e';c.lineWidth=1;
  roundRect(c,40,boxY,W-80,54,10);c.fill();c.stroke();
  c.fillStyle='#00f5c4';c.font='bold 9px Space Mono,monospace';c.textAlign='left';
  c.fillText('WHAT IS HAPPENING',54,boxY+18);
  c.fillStyle='#b0b0cc';c.font='13px Space Mono,monospace';
  const msg=(step.msg||'').slice(0,90);
  c.fillText(msg,54,boxY+38);

  // Stats bar
  const sbY=boxY+68;
  c.fillStyle='#12121a';c.strokeStyle='#2a2a3e';
  roundRect(c,40,sbY,W-80,46,8);c.fill();c.stroke();
  const stats=[
    ['COMPARISONS',slCmps],['SWAPS',slSwps],
    ['BEST',cfg.best],['SPACE',cfg.space]
  ];
  stats.forEach((st,si)=>{
    const sx=54+si*(W-80)/4;
    c.fillStyle='#6b6b8a';c.font='9px Space Mono,monospace';c.textAlign='left';
    c.fillText(st[0],sx,sbY+18);
    c.fillStyle='#00f5c4';c.font='bold 14px Space Mono,monospace';
    c.fillText(st[1],sx,sbY+36);
  });

  // Narration text (English)
  const narr=getNarration(step,idx,algo,'en');
  const narrY=sbY+60;
  c.fillStyle='rgba(167,139,250,0.12)';c.strokeStyle='rgba(167,139,250,0.3)';
  roundRect(c,40,narrY,W-80,48,8);c.fill();c.stroke();
  c.fillStyle='#a78bfa';c.font='bold 9px Space Mono,monospace';c.textAlign='left';
  c.fillText('üîä NARRATION',54,narrY+16);
  c.fillStyle='#c0c0d8';c.font='11.5px Space Mono,monospace';
  c.fillText(narr.slice(0,100)+(narr.length>100?'...':''),54,narrY+34);

  // Footer
  c.fillStyle='#1a1a26';
  c.fillRect(0,H-36,W,36);
  c.strokeStyle='#2a2a3e';c.lineWidth=1;
  c.beginPath();c.moveTo(0,H-36);c.lineTo(W,H-36);c.stroke();
  c.fillStyle='#3a3a5e';c.font='10px Space Mono,monospace';c.textAlign='center';
  c.fillText('AlgoViz ‚Äî Algorithm Visualizer for Students',W/2,H-14);

  return cvs;
}

function roundRect(c,x,y,w,h,r){
  c.beginPath();
  c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);
  c.closePath();
}

function saveSlideImage(){
  if(!slSteps.length) return;
  const idx=Math.max(0,slIdx-1);
  const cvs=drawSlideToCanvas(idx);
  const a=document.createElement('a');
  a.download=`${slAlgo}_slide_${idx+1}.png`;
  a.href=cvs.toDataURL('image/png');
  a.click();
}

function saveAllSlides(){
  if(!slSteps.length) return;
  const btn=document.querySelector('.save-all-btn');
  btn.textContent='‚è≥ Generating...';btn.disabled=true;
  let i=0;
  function next(){
    if(i>=slSteps.length){btn.textContent='üíæ Export All Slides';btn.disabled=false;return;}
    const cvs=drawSlideToCanvas(i);
    const a=document.createElement('a');
    a.download=`${slAlgo}_slide_${String(i+1).padStart(3,'0')}.png`;
    a.href=cvs.toDataURL('image/png');
    a.click();
    btn.textContent=`‚è≥ ${i+1}/${slSteps.length}`;
    i++;setTimeout(next,350);
  }
  next();
}

// ============================================================
// Slide state
let slAlgo='selection', slArray=[], slSteps=[], slIdx=0, slPlaying=false, slIv=null, slCmps=0, slSwps=0, slChainActive=false;

function slideSelectAlgo(name, el){
  slAlgo=name;
  slSyncedFromViz=false;
  slSearchTarget=null;
  // Hide sync banner when manually picking algo
  const banner=document.getElementById('slide-sync-banner');
  if(banner) banner.style.display='none';
  document.querySelectorAll('#slide-algo-tabs .algo-tab').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  slideInit();
}

function slideRandomize(){
  const n=12;
  slArray=Array.from({length:n},()=>Math.floor(Math.random()*85)+8);
  // Only sort for search algos that require sorted input (not linear)
  if(ALGOS[slAlgo].type==='search' && slAlgo!=='linear') slArray=[...slArray].sort((a,b)=>a-b);
  slSyncedFromViz = false;
  // Hide sync banner
  const banner = document.getElementById('slide-sync-banner');
  if(banner) banner.style.display='none';
  slideInit();
}

// Shared search target for slide view (synced from visualizer)
let slSearchTarget = null;
let slSyncedFromViz = false;

// Called when user clicks "Open in Slide View" in the Visualizer
function openInSlideView(){
  // 1. Copy the visualizer's current array and algorithm
  slArray = [...array];
  slAlgo = curAlgo;
  slSyncedFromViz = true;

  // 2. Read the search target if this is a search algorithm
  slSearchTarget = null;
  if(ALGOS[curAlgo].type === 'search'){
    const tInput = document.getElementById('viz-search-target');
    if(tInput && tInput.value.trim() !== ''){
      const tv = parseInt(tInput.value.trim());
      if(!isNaN(tv)) slSearchTarget = tv;
    }
  }

  // 3. Sync the algo tab in slide view
  document.querySelectorAll('#slide-algo-tabs .algo-tab').forEach(t => {
    const onclick = t.getAttribute('onclick') || '';
    t.classList.toggle('active', onclick.includes("'"+slAlgo+"'"));
  });

  // 4. Switch to slide page
  showPageByName('slide');

  // 5. Re-init slide with the new array
  slideInit();

  // 6. Show sync banner
  const banner = document.getElementById('slide-sync-banner');
  const info   = document.getElementById('slide-sync-info');
  if(banner){
    banner.style.display = 'flex';
    if(info){
      const arr = slArray;
      const preview = arr.slice(0,8).join(', ') + (arr.length>8 ? ' ‚Ä¶' : '');
      const targetStr = slSearchTarget !== null ? `  |  Target: ${slSearchTarget}` : '';
      info.textContent = `${ALGOS[slAlgo].name}  ‚Ä¢  [${preview}]${targetStr}  ‚Ä¢  ${arr.length} elements`;
    }
  }
}

// Go back to Visualizer page
function goBackToVisualizer(){
  showPageByName('single');
}

function slideInit(){
  if(slIv)clearInterval(slIv);
  slChainActive=false;
  stopSpeaking();
  slPlaying=false; slIdx=0; slCmps=0; slSwps=0;
  document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';

  // If not synced from visualizer, generate a fresh array for this algo
  if(!slSyncedFromViz){
    slArray=Array.from({length:12},()=>Math.floor(Math.random()*85)+8);
    if(ALGOS[slAlgo].type==='search' && slAlgo!=='linear') slArray=[...slArray].sort((a,b)=>a-b);
    slSearchTarget = null;
  }

  // Generate steps ‚Äî pass search target if available
  slSteps = ALGOS[slAlgo].gen([...slArray], slSearchTarget);

  // Update static info
  const cfg=ALGOS[slAlgo];
  document.getElementById('sl-algo-name').innerHTML=cfg.name.replace(/(\w+)$/,'<span>$1</span>');
  document.getElementById('sl-cx-best').textContent=cfg.best;
  document.getElementById('sl-cx-avg').textContent=cfg.avg;
  document.getElementById('sl-cx-worst').textContent=cfg.worst;
  document.getElementById('sl-cx-space').textContent=cfg.space;
  document.getElementById('sl-cx-stable').textContent=cfg.stable;
  document.getElementById('sl-tip').textContent=ALGO_TIPS[slAlgo]||'';

  // Pseudocode
  renderSlidePseudo(slAlgo,-1);
  renderSlide(0);
}

function renderSlidePseudo(algo, activeLine){
  const lines=SLIDE_PSEUDOCODE[algo]||[];
  const el=document.getElementById('sl-pseudocode');
  el.innerHTML=lines.map((l,i)=>
    `<span class="slide-pseudo-line${i===activeLine?' active':''}">${'  '.repeat((l.match(/^\s*/)[0].length/4))}${l.trim()}</span>`
  ).join('\n');
}

function renderSlide(idx){
  if(!slSteps.length) return;
  const clampedIdx=Math.min(idx, slSteps.length-1);
  const step=slSteps[clampedIdx];
  const n=step.a.length;
  const isSearch=ALGOS[slAlgo].type==='search';
  const prev=clampedIdx>0?slSteps[clampedIdx-1]:null;

  // Stats
  if(step.cmp&&step.cmp.length===2) slCmps=Math.max(slCmps,slCmps+(clampedIdx>slIdx-1?0:0));
  document.getElementById('sl-cmps').textContent=slCmps;
  document.getElementById('sl-swps').textContent=slSwps;
  document.getElementById('sl-step-num').textContent=clampedIdx+1;
  document.getElementById('sl-counter').textContent=`Slide ${clampedIdx+1} of ${slSteps.length}`;
  const pct=Math.round((clampedIdx/Math.max(slSteps.length-1,1))*100);
  document.getElementById('sl-progress').style.width=pct+'%';

  // Sorted %
  const sortedCount=step.su>=0?Math.min(step.su+1,n):0;
  const sortedPct=step.su===n-1?100:Math.round((sortedCount/n)*100);
  document.getElementById('sl-sorted-pct').textContent=sortedPct+'%';

  // Phase badge
  const phase=getPhase(step,slAlgo);
  const badge=document.getElementById('sl-phase-badge');
  badge.textContent=phase.label;
  badge.style.color=phase.color;
  badge.style.background=phase.bg;
  badge.style.border=`1px solid ${phase.color}40`;

  // Title
  document.getElementById('sl-title').innerHTML=getSlideTitle(step,slAlgo);

  // Explanation
  document.getElementById('sl-explain').textContent=step.msg||'';

  // Pseudocode highlight
  const pseudoLine=(PSEUDO_MAP[slAlgo]||{})[step.l]??-1;
  renderSlidePseudo(slAlgo, pseudoLine);

  // Swap arrow
  const swapEl=document.getElementById('sl-swap-arrow');
  const didSwap=prev&&JSON.stringify(prev.a)!==JSON.stringify(step.a)&&step.cmp&&step.cmp.length===2;
  if(didSwap){
    const [i1,i2]=step.cmp;
    swapEl.style.display='flex';
    swapEl.innerHTML=`‚Üî Swapped <strong style="color:var(--accent2)">${step.a[i1]}</strong> and <strong style="color:var(--accent2)">${step.a[i2]}</strong>`;
  } else {
    swapEl.style.display='none';
  }

  // Render cells
  const cellsEl=document.getElementById('sl-cells');
  cellsEl.innerHTML='';
  const isNotFound = isSearch && step.range && step.range[0]===-1 && step.range[1]===-1 && step.found===-1;
  step.a.forEach((val,i)=>{
    const isSorted=step.su===n-1||(step.su>=0&&i<=step.su&&!isSearch);
    const isComp=step.cmp&&step.cmp.includes(i);
    const isHi=step.hi===i;
    const isFound=step.found===i;
    const inRange=isSearch&&!isNotFound&&step.range&&i>=step.range[0]&&i<=step.range[1];

    let fill,border,text,extraClass='';
    if(isNotFound){fill='rgba(255,107,107,.07)';border='rgba(255,107,107,.25)';text='rgba(255,107,107,.4)';}
    else if(isFound){fill='rgba(0,245,196,.25)';border='#00f5c4';text='#00f5c4';extraClass='active bounce';}
    else if(step.su===n-1&&!isSearch){fill='rgba(0,245,196,.12)';border='#00f5c4';text='#00f5c4';}
    else if(isComp){fill='rgba(255,107,107,.2)';border='#ff6b6b';text='#ff6b6b';extraClass='active';}
    else if(isHi){fill='rgba(255,217,61,.2)';border='#ffd93d';text='#ffd93d';extraClass='active';}
    else if(isSorted){fill='rgba(0,245,196,.1)';border='rgba(0,245,196,.3)';text='#00f5c4';}
    else if(inRange){fill='rgba(167,139,250,.15)';border='#a78bfa';text='#a78bfa';}
    else{fill='rgba(58,58,110,.4)';border='#3a3a6e';text='#7070aa';}

    const cell=document.createElement('div');
    cell.className=`slide-cell ${extraClass}`;
    cell.innerHTML=`
      <div class="slide-cell-box" style="background:${fill};border-color:${border};color:${text};${(!isNotFound&&(isComp||isHi||isFound))?`box-shadow:0 0 20px ${border}55;`:''}">
        ${val}
        ${isHi&&!isComp?`<div style="position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-size:.6rem;color:#ffd93d;font-family:'Space Mono',monospace;white-space:nowrap;">MIN</div>`:''}
        ${isFound?`<div style="position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-size:.6rem;color:#00f5c4;font-family:'Space Mono',monospace;white-space:nowrap;">FOUND</div>`:''}
      </div>
      <div class="slide-cell-idx" style="${isNotFound?'color:rgba(255,107,107,.3);':''}">[${i}]</div>`;
    cellsEl.appendChild(cell);
  });

  // Not-found overlay message
  const existingNFBanner = document.getElementById('sl-notfound-banner');
  if(existingNFBanner) existingNFBanner.remove();
  if(isNotFound){
    const nfb = document.createElement('div');
    nfb.id='sl-notfound-banner';
    nfb.style.cssText='margin-top:10px;padding:10px 18px;background:rgba(255,107,107,.1);border:1.5px solid rgba(255,107,107,.4);border-radius:10px;font-family:Space Mono,monospace;font-size:.8rem;color:#ff6b6b;text-align:center;font-weight:700;';
    nfb.textContent='‚ùå  Element NOT FOUND in array  ‚Üí  return -1';
    cellsEl.parentNode.insertBefore(nfb, cellsEl.nextSibling);
  }

  // Buttons
  document.getElementById('sl-first-btn').disabled=clampedIdx===0;
  document.getElementById('sl-prev-btn').disabled=clampedIdx===0;
  document.getElementById('sl-next-btn').disabled=clampedIdx>=slSteps.length-1;
  document.getElementById('sl-last-btn').disabled=clampedIdx>=slSteps.length-1;
}

function applySlideStep(){
  if(slIdx>=slSteps.length) return;
  const step=slSteps[slIdx];
  const prev=slIdx>0?slSteps[slIdx-1]:null;
  if(step.cmp&&step.cmp.length===2) slCmps++;
  if(prev&&JSON.stringify(prev.a)!==JSON.stringify(step.a)){slSwps++;}
  renderSlide(slIdx);
  slIdx++;
}

function slideNext(){
  if(slIdx<slSteps.length) applySlideStep();
  if(slIdx>=slSteps.length){
    if(slIv){clearInterval(slIv);slIv=null;}
    slPlaying=false;
    document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';
  }
  // Manual step: just speak current slide if auto-speak on
  if(!slPlaying && document.getElementById('auto-speak')&&document.getElementById('auto-speak').checked){
    const idx=Math.max(0,slIdx-1);
    const step=slSteps[Math.min(idx,slSteps.length-1)];
    if(step) speakText(getNarration(step,idx,slAlgo,voiceLang));
  }
}

function slidePrev(){
  stopSpeaking();
  slIdx=Math.max(0,slIdx-2);
  slCmps=0;slSwps=0;
  const target=slIdx;slIdx=0;
  for(let i=0;i<target;i++){
    const s=slSteps[i],p=i>0?slSteps[i-1]:null;
    if(s.cmp&&s.cmp.length===2)slCmps++;
    if(p&&JSON.stringify(p.a)!==JSON.stringify(s.a))slSwps++;
  }
  slIdx=target;
  renderSlide(slIdx);
  slIdx++;
  // Speak on manual prev if auto-speak on
  if(document.getElementById('auto-speak')&&document.getElementById('auto-speak').checked){
    const idx=Math.max(0,slIdx-1);
    const step=slSteps[Math.min(idx,slSteps.length-1)];
    if(step) speakText(getNarration(step,idx,slAlgo,voiceLang));
  }
}
function slideGo(idx){
  stopSpeaking();
  slIdx=0;slCmps=0;slSwps=0;
  renderSlide(0);slIdx=1;
}
function slideGoLast(){
  stopSpeaking();
  slIdx=0;slCmps=0;slSwps=0;
  for(let i=0;i<slSteps.length;i++){
    const s=slSteps[i],p=i>0?slSteps[i-1]:null;
    if(s.cmp&&s.cmp.length===2)slCmps++;
    if(p&&JSON.stringify(p.a)!==JSON.stringify(s.a))slSwps++;
  }
  slIdx=slSteps.length-1;
  renderSlide(slIdx);
}

// ---- Synchronized play engine ----
// When auto-speak is ON:  show slide ‚Üí speak ‚Üí wait for speech END ‚Üí pause (gap) ‚Üí next slide
// When auto-speak is OFF: use setInterval with speed delay (fast, no waiting)

// slChainActive declared above with slide state variables

function slidePlayPause(){
  if(slIdx>=slSteps.length){ slideGo(0); }
  slPlaying=!slPlaying;
  document.getElementById('sl-play-btn').textContent=slPlaying?'‚è∏ Pause':'‚ñ∂ Play';

  if(slPlaying){
    const autoSpeak=document.getElementById('auto-speak')&&document.getElementById('auto-speak').checked;
    if(autoSpeak){
      // Voice-synchronized chain: each step waits for speech to finish
      slChainActive=true;
      runVoiceChain();
    } else {
      // Normal timer-based play (no voice sync needed)
      const spd=+document.getElementById('sl-speed').value;
      const delays=[0,1800,1400,1100,850,650,500,380,260];
      slIv=setInterval(()=>{
        if(!slPlaying||slIdx>=slSteps.length){
          clearInterval(slIv);slIv=null;
          slPlaying=false;
          document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';
          return;
        }
        applySlideStep();
        if(slIdx>=slSteps.length){
          clearInterval(slIv);slIv=null;
          slPlaying=false;
          document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';
        }
      }, delays[spd]||700);
    }
  } else {
    // Pause
    slChainActive=false;
    stopSpeaking();
    if(slIv){clearInterval(slIv);slIv=null;}
  }
}

function runVoiceChain(){
  // Stop if paused or finished
  if(!slPlaying||!slChainActive||slIdx>=slSteps.length){
    if(slIdx>=slSteps.length){
      slPlaying=false;slChainActive=false;
      document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';
    }
    return;
  }

  // 1. Show the slide
  applySlideStep();
  const currentIdx=slIdx-1;
  const step=slSteps[Math.min(currentIdx,slSteps.length-1)];

  // 2. Get narration text
  const text=getNarration(step,currentIdx,slAlgo,voiceLang);

  // 3. Get the inter-slide gap from speed slider (even in voice mode, speed = pause gap between slides)
  const spd=+document.getElementById('sl-speed').value;
  const gaps=[0,600,450,300,200,120,80,50,20]; // gap AFTER speech ends before next slide
  const gapAfter=gaps[spd]||200;

  // 4. Speak, then schedule next slide after speech + gap
  speakText(text, ()=>{
    // speech finished callback
    if(!slPlaying||!slChainActive) return; // paused during speech
    if(slIdx>=slSteps.length){
      slPlaying=false;slChainActive=false;
      document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';
      return;
    }
    setTimeout(()=>{
      if(!slPlaying||!slChainActive) return;
      runVoiceChain(); // next slide
    }, gapAfter);
  });
}

// When auto-speak checkbox is toggled mid-play, restart the engine
document.addEventListener('DOMContentLoaded',()=>{
  const cb=document.getElementById('auto-speak');
  if(cb){
    cb.addEventListener('change',()=>{
      if(slPlaying){
        // Restart playback in the correct mode
        slChainActive=false;
        stopSpeaking();
        if(slIv){clearInterval(slIv);slIv=null;}
        slPlaying=false;
        document.getElementById('sl-play-btn').textContent='‚ñ∂ Play';
        // Small delay then resume
        setTimeout(()=>slidePlayPause(),100);
      }
    });
  }
});

// Speed label
document.getElementById('sl-speed').addEventListener('input',function(){
  const autoSpeak=document.getElementById('auto-speak')&&document.getElementById('auto-speak').checked;
  const labels=['','Very Slow','Slow','Medium','Normal','Fast','Faster','Very Fast','Max'];
  const hint=autoSpeak?' (gap after speech)':' (slide speed)';
  document.getElementById('sl-speed-label').textContent=(labels[this.value]||'')+hint;
});

// Keyboard
document.addEventListener('keydown',e=>{
  if(document.getElementById('page-slide').classList.contains('active')){
    if(e.key==='ArrowRight'||e.key==='ArrowDown'){e.preventDefault();slideNext();}
    if(e.key==='ArrowLeft'||e.key==='ArrowUp'){e.preventDefault();slidePrev();}
    if(e.key===' '){e.preventDefault();slidePlayPause();}
  }
});

// ============================================================
// NAV
// ============================================================
function showPage(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(el)el.classList.add('active');
  if(name==='compare'&&cmpStepsA.length===0)initCompare();
  // Only auto-init slide if it has never been initialized (not synced from viz)
  if(name==='slide'&&slSteps.length===0&&!slSyncedFromViz)slideInit();
  if(name!=='slide') stopSpeaking();
  if(name==='programs'&&document.getElementById('prog-list').innerHTML==='')renderProgList();
}

// ============================================================
// DATA STRUCTURES VISUALIZER
// ============================================================
const DS_CONFIG = {
  array:{
    subtypes:['Linear Array'],
    ops:['Insert','Delete','Search','Update','Traverse','Reverse'],
    info:`An Array stores elements in contiguous memory locations. Access is O(1) by index. Insert/Delete at middle is O(n).`,
    code:{
      'Insert':`def insert(arr, pos, val):\n    arr.insert(pos, val)\n    return arr`,
      'Delete':`def delete(arr, pos):\n    arr.pop(pos)\n    return arr`,
      'Search':`def search(arr, val):\n    for i,v in enumerate(arr):\n        if v == val: return i\n    return -1`,
      'Update':`def update(arr, pos, val):\n    arr[pos] = val\n    return arr`,
      'Traverse':`def traverse(arr):\n    for i,v in enumerate(arr):\n        print(f"[{i}] = {v}")`,
      'Reverse':`def reverse(arr):\n    left,right = 0,len(arr)-1\n    while left < right:\n        arr[left],arr[right]=arr[right],arr[left]\n        left+=1;right-=1`,
    }
  },
  linkedlist:{
    subtypes:['Singly','Doubly','Circular','Circular Doubly'],
    ops:['Insert Head','Insert Tail','Insert At','Delete Head','Delete Tail','Delete At','Search','Traverse'],
    info:`A Linked List stores nodes with data + pointer(s). No contiguous memory needed. Insert/Delete at head is O(1). Search is O(n).`,
    code:{
      'Insert Head':`class Node:\n    def __init__(self,data):\n        self.data=data\n        self.next=None\ndef insert_head(head,val):\n    node=Node(val)\n    node.next=head\n    return node`,
      'Insert Tail':`def insert_tail(head,val):\n    node=Node(val)\n    if not head: return node\n    cur=head\n    while cur.next: cur=cur.next\n    cur.next=node\n    return head`,
      'Delete Head':`def delete_head(head):\n    if not head: return None\n    return head.next`,
      'Search':`def search(head,val):\n    cur,i=head,0\n    while cur:\n        if cur.data==val: return i\n        cur=cur.next;i+=1\n    return -1`,
      'Traverse':`def traverse(head):\n    cur=head\n    while cur:\n        print(cur.data,end=" -> ")\n        cur=cur.next\n    print("None")`,
    }
  },
  stack:{
    subtypes:['Array Stack','Linked Stack'],
    ops:['Push','Pop','Peek','isEmpty','Display'],
    info:`A Stack is LIFO (Last In First Out). Push/Pop at top are O(1). Used in function calls, undo operations, expression evaluation.`,
    code:{
      'Push':`stack = []\ndef push(stack, val):\n    stack.append(val)\n    print(f"Pushed {val}")`,
      'Pop':`def pop(stack):\n    if not stack:\n        return "Underflow!"\n    return stack.pop()`,
      'Peek':`def peek(stack):\n    if not stack:\n        return "Empty!"\n    return stack[-1]`,
      'isEmpty':`def is_empty(stack):\n    return len(stack) == 0`,
      'Display':`def display(stack):\n    for v in reversed(stack):\n        print(f"| {v} |")\n    print("-----")`,
    }
  },
  queue:{
    subtypes:['Linear Queue','Circular Queue','Priority Queue','Deque'],
    ops:['Enqueue','Dequeue','Peek','isEmpty','Display'],
    info:`A Queue is FIFO (First In First Out). Enqueue at rear, Dequeue from front are O(1). Used in scheduling, BFS, print spoolers.`,
    code:{
      'Enqueue':`from collections import deque\nqueue = deque()\ndef enqueue(queue, val):\n    queue.append(val)\n    print(f"Enqueued {val}")`,
      'Dequeue':`def dequeue(queue):\n    if not queue:\n        return "Underflow!"\n    return queue.popleft()`,
      'Peek':`def peek(queue):\n    if not queue:\n        return "Empty!"\n    return queue[0]`,
      'isEmpty':`def is_empty(queue):\n    return len(queue) == 0`,
    }
  }
};

let dsCategory='array', dsSubtype='Linear Array', dsOp='Insert';
let dsData=[], dsAnimSteps=[], dsAnimIdx=0, dsAnimIv=null;
const dsCanvas=document.getElementById('ds-canvas');
const dsCtx=dsCanvas.getContext('2d');

function dsSelectCategory(cat, el){
  dsCategory=cat;
  document.querySelectorAll('.ds-cat-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const cfg=DS_CONFIG[cat];
  dsSubtype=cfg.subtypes[0];
  dsOp=cfg.ops[0];
  dsData=[];
  // Generate default data
  if(cat==='stack'||cat==='queue') dsData=[10,20,30,40,50];
  else dsData=Array.from({length:8},()=>Math.floor(Math.random()*80)+5);
  renderDsSubtypes(cfg.subtypes);
  renderDsOps(cfg.ops);
  dsUpdateInfo();
  document.getElementById('ds-input-row').style.display='flex';
  dsDraw();
}

function renderDsSubtypes(subtypes){
  const row=document.getElementById('ds-subtype-row');
  row.innerHTML=subtypes.map((s,i)=>
    `<button class="ds-sub-btn${i===0?' active':''}" onclick="dsSetSubtype('${s}',this)">${s}</button>`
  ).join('');
}
function dsSetSubtype(sub,el){
  dsSubtype=sub;
  document.querySelectorAll('.ds-sub-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  dsData=[];
  if(dsCategory==='stack'||dsCategory==='queue') dsData=[10,20,30,40,50];
  else dsData=Array.from({length:8},()=>Math.floor(Math.random()*80)+5);
  dsDraw();
}
function renderDsOps(ops){
  const row=document.getElementById('ds-ops-row');
  row.innerHTML=ops.map((op,i)=>
    `<button class="ds-op-btn${i===0?' active':''}" onclick="dsSetOp('${op}',this)">${op}</button>`
  ).join('');
}
function dsSetOp(op,el){
  dsOp=op;
  document.querySelectorAll('.ds-op-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  dsUpdateInfo();
}
function dsUpdateInfo(){
  const cfg=DS_CONFIG[dsCategory];
  document.getElementById('ds-info-title').textContent=`${dsCategory.charAt(0).toUpperCase()+dsCategory.slice(1)} ‚Äî ${dsSubtype}`;
  document.getElementById('ds-info-body').textContent=cfg.info;
  document.getElementById('ds-code-title').textContent=`${dsCategory}_${dsOp.toLowerCase().replace(/ /g,'_')}.py`;
  const codeEl=document.getElementById('ds-code-display');
  codeEl.textContent=cfg.code[dsOp]||`# Code for ${dsOp}`;
}

function dsExecuteOp(){
  const val=parseInt(document.getElementById('ds-val-input').value)||Math.floor(Math.random()*90)+5;
  const pos=parseInt(document.getElementById('ds-pos-input').value);
  const steps=[];
  const d=[...dsData];

  switch(dsCategory){
    case 'array':
      if(dsOp==='Insert'){
        const p=isNaN(pos)?d.length:Math.min(pos,d.length);
        steps.push({data:[...d],hi:-1,msg:`Inserting ${val} at position ${p}`});
        for(let i=d.length;i>p;i--){
          const tmp=[...d];tmp.splice(i,0,tmp[i-1]);tmp.splice(i-1,1);
          steps.push({data:[...d],hi:i,shifting:i-1,msg:`Shifting element at [${i-1}] ‚Üí [${i}]`});
        }
        d.splice(p,0,val);
        steps.push({data:[...d],hi:p,msg:`‚úÖ ${val} inserted at index ${p}`});
      } else if(dsOp==='Delete'){
        const p=isNaN(pos)?d.length-1:Math.min(pos,d.length-1);
        steps.push({data:[...d],hi:p,msg:`Deleting element at index ${p}, value=${d[p]}`});
        d.splice(p,1);
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Element deleted. Array shifted left.`});
      } else if(dsOp==='Search'){
        for(let i=0;i<d.length;i++){
          steps.push({data:[...d],hi:i,searching:val,msg:`Checking index [${i}] = ${d[i]}. Target = ${val}`});
          if(d[i]===val){steps.push({data:[...d],found:i,searching:val,msg:`‚úÖ Found ${val} at index ${i}!`});break;}
          if(i===d.length-1)steps.push({data:[...d],hi:-1,msg:`‚ùå ${val} not found in array.`});
        }
      } else if(dsOp==='Update'){
        const p=isNaN(pos)?0:Math.min(pos,d.length-1);
        steps.push({data:[...d],hi:p,msg:`Updating index ${p} from ${d[p]} ‚Üí ${val}`});
        d[p]=val;
        steps.push({data:[...d],hi:p,msg:`‚úÖ Updated! arr[${p}] = ${val}`});
      } else if(dsOp==='Traverse'){
        for(let i=0;i<d.length;i++) steps.push({data:[...d],hi:i,msg:`Visiting index [${i}] = ${d[i]}`});
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Traversal complete. Visited ${d.length} elements.`});
      } else if(dsOp==='Reverse'){
        let l=0,r=d.length-1;
        while(l<r){
          steps.push({data:[...d],hi:l,hi2:r,msg:`Swapping arr[${l}]=${d[l]} ‚Üî arr[${r}]=${d[r]}`});
          [d[l],d[r]]=[d[r],d[l]];
          steps.push({data:[...d],hi:l,hi2:r,msg:`Swapped! Moving pointers inward.`});
          l++;r--;
        }
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Array reversed!`});
      }
      break;

    case 'stack':
      if(dsOp==='Push'){
        steps.push({data:[...d],hi:-1,msg:`Pushing ${val} onto stack top`});
        d.push(val);
        steps.push({data:[...d],hi:d.length-1,msg:`‚úÖ ${val} pushed. Stack size = ${d.length}`});
      } else if(dsOp==='Pop'){
        if(!d.length){steps.push({data:[],hi:-1,msg:`‚ùå Stack Underflow! Cannot pop from empty stack.`});break;}
        steps.push({data:[...d],hi:d.length-1,msg:`Popping top element: ${d[d.length-1]}`});
        const popped=d.pop();
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Popped ${popped}. Stack size = ${d.length}`});
      } else if(dsOp==='Peek'){
        if(!d.length){steps.push({data:[],hi:-1,msg:`‚ùå Stack is empty!`});break;}
        steps.push({data:[...d],hi:d.length-1,msg:`üëÄ Peek: Top element is ${d[d.length-1]} (not removed)`});
      } else if(dsOp==='Display'){
        for(let i=d.length-1;i>=0;i--) steps.push({data:[...d],hi:i,msg:`Stack[${i}] = ${d[i]}${i===d.length-1?' ‚Üê TOP':''}`});
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Stack has ${d.length} elements.`});
      }
      break;

    case 'queue':
      if(dsOp==='Enqueue'){
        steps.push({data:[...d],hi:-1,msg:`Enqueueing ${val} at rear of queue`});
        d.push(val);
        steps.push({data:[...d],hi:d.length-1,msg:`‚úÖ ${val} enqueued at rear. Size = ${d.length}`});
      } else if(dsOp==='Dequeue'){
        if(!d.length){steps.push({data:[],hi:-1,msg:`‚ùå Queue Underflow! Cannot dequeue from empty queue.`});break;}
        steps.push({data:[...d],hi:0,msg:`Dequeuing front element: ${d[0]}`});
        const dq=d.shift();
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Dequeued ${dq}. Queue size = ${d.length}`});
      } else if(dsOp==='Peek'){
        if(!d.length){steps.push({data:[],hi:-1,msg:`‚ùå Queue is empty!`});break;}
        steps.push({data:[...d],hi:0,msg:`üëÄ Front element is ${d[0]} (not removed)`});
      } else if(dsOp==='Display'){
        for(let i=0;i<d.length;i++) steps.push({data:[...d],hi:i,msg:`Queue[${i}] = ${d[i]}${i===0?' ‚Üê FRONT':i===d.length-1?' ‚Üê REAR':''}`});
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Queue has ${d.length} elements.`});
      }
      break;

    case 'linkedlist':
      if(dsOp==='Insert Head'){
        steps.push({data:[...d],hi:-1,newNode:val,msg:`Creating new node with value ${val}`});
        d.unshift(val);
        steps.push({data:[...d],hi:0,msg:`‚úÖ ${val} inserted at head. New head = ${d[0]}`});
      } else if(dsOp==='Insert Tail'){
        steps.push({data:[...d],hi:-1,msg:`Traversing to tail to insert ${val}...`});
        for(let i=0;i<d.length;i++) steps.push({data:[...d],hi:i,msg:`Visiting node ${i}: value=${d[i]}`});
        d.push(val);
        steps.push({data:[...d],hi:d.length-1,msg:`‚úÖ ${val} inserted at tail.`});
      } else if(dsOp==='Delete Head'){
        if(!d.length){steps.push({data:[],hi:-1,msg:`‚ùå List is empty!`});break;}
        steps.push({data:[...d],hi:0,msg:`Deleting head node: value=${d[0]}`});
        d.shift();
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Head deleted. New head = ${d[0]??'null'}`});
      } else if(dsOp==='Search'){
        for(let i=0;i<d.length;i++){
          steps.push({data:[...d],hi:i,msg:`Checking node ${i}: value=${d[i]}. Target=${val}`});
          if(d[i]===val){steps.push({data:[...d],found:i,msg:`‚úÖ Found ${val} at node ${i}!`});break;}
          if(i===d.length-1)steps.push({data:[...d],hi:-1,msg:`‚ùå ${val} not found.`});
        }
      } else if(dsOp==='Traverse'){
        for(let i=0;i<d.length;i++) steps.push({data:[...d],hi:i,msg:`Node ${i}: data=${d[i]} ‚Üí ${d[i+1]??'NULL'}`});
        steps.push({data:[...d],hi:-1,msg:`‚úÖ Traversal complete. ${d.length} nodes.`});
      } else {
        // Insert At
        const p=isNaN(pos)?0:Math.min(pos,d.length);
        steps.push({data:[...d],hi:-1,msg:`Inserting ${val} at position ${p}`});
        d.splice(p,0,val);
        steps.push({data:[...d],hi:p,msg:`‚úÖ ${val} inserted at position ${p}`});
      }
      break;
  }

  dsData=[...d];
  dsAnimSteps=steps;
  dsAnimIdx=0;
  dsRunAnim();
}

function dsRunAnim(){
  if(dsAnimIv)clearInterval(dsAnimIv);
  dsAnimIv=setInterval(()=>{
    if(dsAnimIdx>=dsAnimSteps.length){clearInterval(dsAnimIv);return;}
    const step=dsAnimSteps[dsAnimIdx];
    document.getElementById('ds-step-text').textContent=step.msg||'';
    dsDrawStep(step);
    dsAnimIdx++;
  },420);
}

function dsReset(){
  if(dsAnimIv)clearInterval(dsAnimIv);
  if(dsCategory==='stack'||dsCategory==='queue') dsData=[10,20,30,40,50];
  else dsData=Array.from({length:8},()=>Math.floor(Math.random()*80)+5);
  document.getElementById('ds-step-text').textContent='Reset done. Choose an operation.';
  dsDraw();
}

function dsDraw(){dsDrawStep({data:dsData,hi:-1,msg:''});}

function dsDrawStep(step){
  const cvs=dsCanvas;
  cvs.width=cvs.offsetWidth; cvs.height=cvs.offsetHeight;
  const W=cvs.width,H=cvs.height,c=dsCtx;
  c.clearRect(0,0,W,H);
  const data=step.data||[];
  if(!data.length){
    c.fillStyle='#6b6b8a';c.font='14px Space Mono,monospace';c.textAlign='center';
    c.fillText('Empty',W/2,H/2);return;
  }

  if(dsCategory==='stack') drawStack(c,W,H,data,step);
  else if(dsCategory==='queue') drawQueue(c,W,H,data,step,dsSubtype);
  else if(dsCategory==='linkedlist') drawLinkedList(c,W,H,data,step,dsSubtype);
  else drawArrayDS(c,W,H,data,step);
}

function drawArrayDS(c,W,H,data,step){
  const n=data.length,gap=8;
  const cellW=Math.min(70,(W-60-gap*(n-1))/n),cellH=60;
  const startX=(W-n*(cellW+gap)+gap)/2,cellY=(H-cellH)/2;
  data.forEach((val,i)=>{
    const x=startX+i*(cellW+gap);
    const isHi=step.hi===i||step.hi2===i,isFound=step.found===i,isShift=step.shifting===i;
    let fill='rgba(58,58,110,.5)',border='#3a3a6e',text='#7070aa';
    if(isFound){fill='rgba(0,245,196,.25)';border='#00f5c4';text='#00f5c4';}
    else if(isHi){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
    else if(isShift){fill='rgba(255,217,61,.2)';border='#ffd93d';text='#ffd93d';}
    c.shadowColor=border;c.shadowBlur=(isHi||isFound)?16:0;
    c.fillStyle=fill;c.strokeStyle=border;c.lineWidth=2;
    rRect(c,x,cellY,cellW,cellH,8);c.fill();c.stroke();c.shadowBlur=0;
    c.fillStyle=text;c.font=`bold ${Math.min(18,cellW*.32)}px Space Mono,monospace`;
    c.textAlign='center';c.textBaseline='middle';c.fillText(val,x+cellW/2,cellY+cellH/2);
    c.fillStyle='#3a3a5e';c.font='10px Space Mono,monospace';c.textBaseline='alphabetic';
    c.fillText(`[${i}]`,x+cellW/2,cellY+cellH+16);
  });
  if(step.newNode!==undefined){
    c.fillStyle='rgba(167,139,250,.25)';c.strokeStyle='#a78bfa';c.lineWidth=2;
    rRect(c,W-70,cellY,56,cellH,8);c.fill();c.stroke();
    c.fillStyle='#a78bfa';c.font='bold 14px Space Mono,monospace';c.textAlign='center';c.textBaseline='middle';
    c.fillText(step.newNode,W-42,cellY+cellH/2);
    c.fillStyle='#a78bfa';c.font='10px Space Mono,monospace';c.textBaseline='top';c.fillText('new',W-42,cellY+cellH+4);
  }
}

function drawStack(c,W,H,data,step){
  const cellH=44,cellW=160,gap=4,startX=(W-cellW)/2;
  const total=data.length;
  const startY=H-30-total*(cellH+gap);
  // Base
  c.strokeStyle='#3a3a6e';c.lineWidth=2;
  c.beginPath();c.moveTo(startX-2,H-28);c.lineTo(startX+cellW+2,H-28);c.stroke();
  data.forEach((val,i)=>{
    const y=startY+i*(cellH+gap);
    const isTop=i===total-1,isHi=step.hi===i;
    let fill='rgba(58,58,110,.5)',border='#3a3a6e',text='#7070aa';
    if(isHi&&isTop){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
    else if(isTop){fill='rgba(0,245,196,.12)';border='#00f5c4';text='#00f5c4';}
    c.shadowColor=border;c.shadowBlur=isTop?14:0;
    c.fillStyle=fill;c.strokeStyle=border;c.lineWidth=2;
    rRect(c,startX,y,cellW,cellH,6);c.fill();c.stroke();c.shadowBlur=0;
    c.fillStyle=text;c.font='bold 15px Space Mono,monospace';c.textAlign='center';c.textBaseline='middle';
    c.fillText(val,startX+cellW/2,y+cellH/2);
    if(isTop){c.fillStyle='#00f5c4';c.font='bold 10px Space Mono,monospace';c.textAlign='left';c.fillText('‚Üê TOP',startX+cellW+8,y+cellH/2);}
  });
}

function drawQueue(c,W,H,data,step,subtype){
  const isCircular=subtype.includes('Circular');
  const n=data.length,cellW=Math.min(70,(W-80)/(Math.max(n,5))),cellH=60,gap=8;
  const totalW=n*(cellW+gap)-gap,startX=(W-totalW)/2,cellY=(H-cellH)/2;
  if(isCircular&&n>0){
    // Draw circular ring
    const cx=W/2,cy=H/2,radius=Math.min(W,H)/2-50;
    data.forEach((val,i)=>{
      const angle=(2*Math.PI/n)*i-Math.PI/2;
      const nx=cx+radius*Math.cos(angle),ny=cy+radius*Math.sin(angle);
      const isHi=step.hi===i,isFound=step.found===i;
      let fill='rgba(58,58,110,.5)',border='#3a3a6e',text='#7070aa';
      if(isFound){fill='rgba(0,245,196,.25)';border='#00f5c4';text='#00f5c4';}
      else if(isHi){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
      else if(i===0){fill='rgba(0,245,196,.1)';border='rgba(0,245,196,.4)';text='#00f5c4';}
      c.shadowColor=border;c.shadowBlur=isHi?14:0;
      c.fillStyle=fill;c.strokeStyle=border;c.lineWidth=2;
      rRect(c,nx-25,ny-22,50,44,8);c.fill();c.stroke();c.shadowBlur=0;
      c.fillStyle=text;c.font='bold 13px Space Mono,monospace';c.textAlign='center';c.textBaseline='middle';
      c.fillText(val,nx,ny);
      // Arrow to next
      const nextAngle=(2*Math.PI/n)*(i+1)-Math.PI/2;
      const nx2=cx+radius*Math.cos(nextAngle),ny2=cy+radius*Math.sin(nextAngle);
      c.strokeStyle='#3a3a6e';c.lineWidth=1.5;c.setLineDash([4,4]);
      c.beginPath();c.moveTo(nx+(nx2-nx)*0.35,ny+(ny2-ny)*0.35);c.lineTo(nx+(nx2-nx)*0.65,ny+(ny2-ny)*0.65);c.stroke();
      c.setLineDash([]);
    });
    c.fillStyle='#6b6b8a';c.font='10px Space Mono,monospace';c.textAlign='center';
    c.fillText('‚Ü∫ Circular Queue',W/2,H-10);
  } else {
    // Linear queue
    data.forEach((val,i)=>{
      const x=startX+i*(cellW+gap);
      const isFront=i===0,isRear=i===n-1,isHi=step.hi===i,isFound=step.found===i;
      let fill='rgba(58,58,110,.5)',border='#3a3a6e',text='#7070aa';
      if(isFound){fill='rgba(0,245,196,.25)';border='#00f5c4';text='#00f5c4';}
      else if(isHi){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
      else if(isFront){fill='rgba(0,245,196,.1)';border='rgba(0,245,196,.4)';text='#00f5c4';}
      else if(isRear){fill='rgba(167,139,250,.15)';border='#a78bfa';text='#a78bfa';}
      c.shadowColor=border;c.shadowBlur=isHi?14:0;
      c.fillStyle=fill;c.strokeStyle=border;c.lineWidth=2;
      rRect(c,x,cellY,cellW,cellH,8);c.fill();c.stroke();c.shadowBlur=0;
      c.fillStyle=text;c.font=`bold ${Math.min(16,cellW*.28)}px Space Mono,monospace`;
      c.textAlign='center';c.textBaseline='middle';c.fillText(val,x+cellW/2,cellY+cellH/2);
      if(isFront){c.fillStyle='#00f5c4';c.font='bold 9px Space Mono,monospace';c.fillText('FRONT',x+cellW/2,cellY-12);}
      if(isRear){c.fillStyle='#a78bfa';c.font='bold 9px Space Mono,monospace';c.fillText('REAR',x+cellW/2,cellY-12);}
      // Arrow
      if(i<n-1){c.strokeStyle='#3a3a6e';c.lineWidth=1.5;c.beginPath();c.moveTo(x+cellW+2,cellY+cellH/2);c.lineTo(x+cellW+gap-2,cellY+cellH/2);c.stroke();}
    });
  }
}

function drawLinkedList(c,W,H,data,step,subtype){
  const isDbl=subtype.includes('Doubly'),isCirc=subtype.includes('Circular');
  const n=data.length,nodeW=80,nodeH=50,gap=36;
  const totalW=n*(nodeW+gap)-gap,startX=Math.max(20,(W-totalW)/2),nodeY=(H-nodeH)/2;
  data.forEach((val,i)=>{
    const x=startX+i*(nodeW+gap);
    const isHi=step.hi===i||step.hi2===i,isFound=step.found===i;
    let fill='rgba(58,58,110,.5)',border='#3a3a6e',text='#7070aa';
    if(isFound){fill='rgba(0,245,196,.25)';border='#00f5c4';text='#00f5c4';}
    else if(isHi){fill='rgba(255,107,107,.22)';border='#ff6b6b';text='#ff6b6b';}
    c.shadowColor=border;c.shadowBlur=isHi?14:0;
    // Data section
    c.fillStyle=fill;c.strokeStyle=border;c.lineWidth=2;
    rRect(c,x,nodeY,52,nodeH,6);c.fill();c.stroke();c.shadowBlur=0;
    c.fillStyle=text;c.font='bold 14px Space Mono,monospace';c.textAlign='center';c.textBaseline='middle';
    c.fillText(val,x+26,nodeY+nodeH/2);
    // Next pointer box
    c.fillStyle='rgba(42,42,62,.8)';c.strokeStyle=border;c.lineWidth=1.5;
    rRect(c,x+54,nodeY,26,nodeH,4);c.fill();c.stroke();
    c.fillStyle='#4a4a6a';c.font='9px Space Mono,monospace';c.textAlign='center';
    c.fillText('‚Üí',x+67,nodeY+nodeH/2+1);
    // Arrow to next node
    if(i<n-1){
      c.strokeStyle='#5a5a8a';c.lineWidth=1.5;
      c.beginPath();c.moveTo(x+80,nodeY+nodeH/2);c.lineTo(x+80+gap-4,nodeY+nodeH/2);c.stroke();
      // Arrowhead
      c.fillStyle='#5a5a8a';c.beginPath();
      c.moveTo(x+80+gap-2,nodeY+nodeH/2);c.lineTo(x+80+gap-9,nodeY+nodeH/2-4);c.lineTo(x+80+gap-9,nodeY+nodeH/2+4);c.closePath();c.fill();
    }
    // Doubly: back arrow
    if(isDbl&&i>0){
      c.strokeStyle='#6b6b8a';c.lineWidth=1;c.setLineDash([3,3]);
      c.beginPath();c.moveTo(x,nodeY+8);c.lineTo(x-gap,nodeY+8);c.stroke();c.setLineDash([]);
    }
    // Labels
    c.fillStyle='#4a4a6a';c.font='9px Space Mono,monospace';c.textAlign='center';
    if(i===0)c.fillText('HEAD',x+26,nodeY+nodeH+14);
    if(i===n-1)c.fillText('TAIL',x+26,nodeY+nodeH+14);
  });
  // Circular: arc back to head
  if(isCirc&&n>1){
    c.strokeStyle='rgba(167,139,250,.5)';c.lineWidth=1.5;c.setLineDash([5,5]);
    const lastX=startX+(n-1)*(nodeW+gap)+nodeW;
    c.beginPath();c.moveTo(lastX,nodeY+nodeH/2);c.lineTo(lastX+12,nodeY+nodeH/2);
    c.lineTo(lastX+12,nodeY+nodeH+22);c.lineTo(startX-12,nodeY+nodeH+22);
    c.lineTo(startX-12,nodeY+nodeH/2);c.lineTo(startX,nodeY+nodeH/2);c.stroke();c.setLineDash([]);
    c.fillStyle='#a78bfa';c.font='9px Space Mono,monospace';c.textAlign='center';
    c.fillText('circular ‚Üí',W/2,nodeY+nodeH+34);
  }
  // Null terminator
  if(!isCirc){
    const lx=startX+n*(nodeW+gap);
    c.fillStyle='rgba(42,42,62,.8)';c.strokeStyle='#3a3a6e';c.lineWidth=1.5;
    rRect(c,lx,nodeY+nodeH/4,36,nodeH/2,4);c.fill();c.stroke();
    c.fillStyle='#4a4a6a';c.font='bold 10px Space Mono,monospace';c.textAlign='center';c.textBaseline='middle';
    c.fillText('NULL',lx+18,nodeY+nodeH/2);
  }
}

function rRect(c,x,y,w,h,r){
  c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath();
}

// Init DS page
// DS initialized on load

// ============================================================
// COMMON PROGRAMS VISUALIZER
// ============================================================
const PROGRAMS = {
  number:[
    {id:'even',icon:'2Ô∏è‚É£',name:'Even Numbers',desc:'Print even numbers up to N',needsN2:false,
     code:`for i in range(1, n+1):\n    if i % 2 == 0:\n        print(i)`,
     run(n){const s=[];for(let i=1;i<=n;i++){s.push({step:`i=${i}`,check:`${i} % 2 = ${i%2}`,isResult:i%2===0,val:i,msg:i%2===0?`${i} is EVEN ‚úì`:`${i} is odd, skip`});}return s;}
    },
    {id:'odd',icon:'1Ô∏è‚É£',name:'Odd Numbers',desc:'Print odd numbers up to N',needsN2:false,
     code:`for i in range(1, n+1):\n    if i % 2 != 0:\n        print(i)`,
     run(n){const s=[];for(let i=1;i<=n;i++){s.push({step:`i=${i}`,check:`${i} % 2 = ${i%2}`,isResult:i%2!==0,val:i,msg:i%2!==0?`${i} is ODD ‚úì`:`${i} is even, skip`});}return s;}
    },
    {id:'prime',icon:'üî¢',name:'Prime Numbers',desc:'Print primes up to N',needsN2:false,
     code:`def is_prime(n):\n    if n < 2: return False\n    for i in range(2, int(n**0.5)+1):\n        if n % i == 0: return False\n    return True\nfor i in range(2, n+1):\n    if is_prime(i): print(i)`,
     run(n){
       const s=[];
       function ip(x){if(x<2)return false;for(let i=2;i<=Math.sqrt(x);i++)if(x%i===0)return false;return true;}
       for(let i=2;i<=n;i++){s.push({step:`i=${i}`,check:`isPrime(${i})`,isResult:ip(i),val:i,msg:ip(i)?`${i} is PRIME ‚úì`:`${i} is not prime`});}
       return s;
     }
    },
    {id:'fibonacci',icon:'üåÄ',name:'Fibonacci Series',desc:'Print Fibonacci up to N terms',needsN2:false,
     code:`a, b = 0, 1\nfor i in range(n):\n    print(a, end=" ")\n    a, b = b, a + b`,
     run(n){const s=[];let a=0,b=1;for(let i=0;i<n;i++){s.push({step:`term ${i+1}`,isResult:true,val:a,msg:`F(${i})=${a}, next = ${a}+${b}=${a+b}`});[a,b]=[b,a+b];}return s;}
    },
    {id:'factorial',icon:'‚ùó',name:'Factorial',desc:'Compute N!',needsN2:false,
     code:`result = 1\nfor i in range(1, n+1):\n    result *= i\nprint(result)`,
     run(n){const s=[];let r=1;for(let i=1;i<=n;i++){r*=i;s.push({step:`i=${i}`,isResult:false,val:r,msg:`result = result √ó ${i} = ${r}`});}s.push({step:'done',isResult:true,val:r,msg:`${n}! = ${r}`});return s;}
    },
    {id:'armstrong',icon:'üí™',name:'Armstrong Numbers',desc:'Armstrong numbers up to N',needsN2:false,
     code:`for n in range(1, N+1):\n    d=len(str(n))\n    s=sum(int(x)**d for x in str(n))\n    if s==n: print(n)`,
     run(n){
       const s=[];
       for(let i=1;i<=n;i++){
         const d=String(i).length,sm=[...String(i)].reduce((a,x)=>a+Math.pow(+x,d),0);
         const isA=sm===i;s.push({step:`n=${i}`,isResult:isA,val:i,msg:`digits=${d}, sum of powers=${sm}${isA?' ‚Üí ARMSTRONG ‚úì':''}`});
       }return s;
     }
    },
    {id:'palindrome',icon:'üîÅ',name:'Palindrome Check',desc:'Check if N is palindrome',needsN2:false,
     code:`s = str(n)\nif s == s[::-1]:\n    print(f"{n} is palindrome")\nelse:\n    print(f"{n} is not palindrome")`,
     run(n){const s=[];const str=String(n),rev=str.split('').reverse().join('');
       s.push({step:'original',isResult:false,val:n,msg:`Original = "${str}"`});
       s.push({step:'reverse',isResult:false,val:rev,msg:`Reversed = "${rev}"`});
       const isPalin=str===rev;
       s.push({step:'compare',isResult:isPalin,val:n,msg:isPalin?`"${str}" == "${rev}" ‚Üí PALINDROME ‚úì`:`"${str}" ‚â† "${rev}" ‚Üí Not palindrome`});
       return s;
     }
    },
    {id:'perfect',icon:'‚≠ê',name:'Perfect Numbers',desc:'Perfect numbers up to N',needsN2:false,
     code:`for n in range(1, N+1):\n    s = sum(i for i in range(1,n) if n%i==0)\n    if s == n: print(n)`,
     run(n){
       const s=[];
       for(let i=1;i<=n;i++){
         let sum=0;for(let j=1;j<i;j++)if(i%j===0)sum+=j;
         const isP=sum===i&&i>1;
         if(i<=6||isP)s.push({step:`n=${i}`,isResult:isP,val:i,msg:`Divisors sum=${sum}${isP?' ‚Üí PERFECT ‚úì':''}`});
       }return s;
     }
    },
    {id:'gcd',icon:'√∑',name:'GCD / HCF',desc:'Find GCD of two numbers',needsN2:true,
     code:`def gcd(a, b):\n    while b:\n        a, b = b, a % b\n    return a`,
     run(n,m=12){const s=[];let a=n,b=m;s.push({step:'start',isResult:false,val:a,msg:`GCD(${n},${m}) using Euclidean algorithm`});
       while(b){const r=a%b;s.push({step:`${a}%${b}=${r}`,isResult:r===0,val:b,msg:`GCD(${a},${b}) ‚Üí GCD(${b},${r})`});a=b;b=r;}
       s.push({step:'done',isResult:true,val:a,msg:`GCD(${n},${m}) = ${a}`});return s;
     }
    },
    {id:'reverse',icon:'‚Ü©',name:'Reverse Number',desc:'Reverse digits of N',needsN2:false,
     code:`rev = 0\nwhile n > 0:\n    rev = rev*10 + n%10\n    n //= 10\nprint(rev)`,
     run(n){const s=[];let num=n,rev=0;s.push({step:'start',isResult:false,val:n,msg:`Reversing ${n}`});
       while(num>0){const d=num%10;rev=rev*10+d;num=Math.floor(num/10);s.push({step:`digit=${d}`,isResult:false,val:rev,msg:`Extract digit ${d}, rev becomes ${rev}`});}
       s.push({step:'done',isResult:true,val:rev,msg:`Reversed: ${rev}`});return s;
     }
    },
  ],
  pattern:[
    {id:'star_right',icon:'‚≠ê',name:'Right Triangle',desc:'Right triangle star pattern',needsN2:false,
     code:`for i in range(1, n+1):\n    print("*" * i)`,
     run(n){const s=[];for(let i=1;i<=n;i++){s.push({step:`row ${i}`,isResult:true,stars:i,totalRows:n,patId:'right',msg:`Row ${i}: print ${'*'.repeat(i)}`});}return s;}
    },
    {id:'star_inv',icon:'üîª',name:'Inverted Triangle',desc:'Inverted right triangle',needsN2:false,
     code:`for i in range(n, 0, -1):\n    print("*" * i)`,
     run(n){const s=[];for(let i=n;i>=1;i--){s.push({step:`row ${n-i+1}`,isResult:true,stars:i,totalRows:n,patId:'inverted',msg:`Row ${n-i+1}: print ${'*'.repeat(i)}`});}return s;}
    },
    {id:'pyramid',icon:'‚ñ≥',name:'Pyramid',desc:'Centered pyramid pattern',needsN2:false,
     code:`for i in range(1, n+1):\n    print(" "*(n-i) + "*"*(2*i-1))`,
     run(n){const s=[];for(let i=1;i<=n;i++){s.push({step:`row ${i}`,isResult:true,stars:2*i-1,totalRows:n,patId:'pyramid',msg:`Row ${i}: spaces=${n-i}, stars=${2*i-1}`});}return s;}
    },
    {id:'diamond',icon:'üíé',name:'Diamond',desc:'Diamond star pattern',needsN2:false,
     code:`for i in range(1, n+1): print(" "*(n-i)+"*"*(2*i-1))\nfor i in range(n-1,0,-1): print(" "*(n-i)+"*"*(2*i-1))`,
     run(n){const s=[];
       for(let i=1;i<=n;i++)s.push({step:`row ${i}`,isResult:true,stars:2*i-1,totalRows:2*n-1,patId:'diamond',msg:`Upper row ${i}: stars=${2*i-1}`});
       for(let i=n-1;i>=1;i--)s.push({step:`row ${2*n-i}`,isResult:true,stars:2*i-1,totalRows:2*n-1,patId:'diamond',msg:`Lower row ${2*n-i}: stars=${2*i-1}`});
       return s;}
    },
    {id:'number_tri',icon:'üî¢',name:'Number Triangle',desc:'Number triangle pattern',needsN2:false,
     code:`for i in range(1, n+1):\n    print(*range(1, i+1))`,
     run(n){const s=[];for(let i=1;i<=n;i++){const nums=[...Array(i)].map((_,j)=>j+1);s.push({step:`row ${i}`,isResult:true,nums,totalRows:n,patId:'numbers',msg:`Row ${i}: ${nums.join(' ')}`});}return s;}
    },
    {id:'pascal',icon:'üî∫',name:"Pascal's Triangle",desc:"Pascal's Triangle up to N rows",needsN2:false,
     code:`row=[1]\nfor i in range(n):\n    print(row)\n    row=[1]+[row[j]+row[j+1] for j in range(len(row)-1)]+[1]`,
     run(n){const s=[];let row=[1];for(let i=0;i<n;i++){s.push({step:`row ${i+1}`,isResult:true,nums:[...row],totalRows:n,patId:'pascal',msg:`Pascal row ${i+1}: [${row.join(', ')}]`});row=[1,...row.slice(0,-1).map((v,j)=>v+row[j+1]),1];}return s;}
    },
    {id:'hollow_square',icon:'‚¨ú',name:'Hollow Square',desc:'Hollow square border pattern',needsN2:false,
     code:`for i in range(n):\n    for j in range(n):\n        if i==0 or i==n-1 or j==0 or j==n-1:\n            print("*",end="")\n        else: print(" ",end="")\n    print()`,
     run(n){const s=[];for(let i=0;i<n;i++){const row=[];for(let j=0;j<n;j++)row.push(i===0||i===n-1||j===0||j===n-1?1:0);s.push({step:`row ${i+1}`,isResult:true,grid:row,totalRows:n,patId:'hollow',msg:`Row ${i+1}: border=${i===0||i===n-1?'full':'sides only'}`});}return s;}
    },
  ],
  math:[
    {id:'power',icon:'‚ö°',name:'Power (x^n)',desc:'Compute x to the power n',needsN2:true,
     code:`result = 1\nfor i in range(n):\n    result *= x`,
     run(n,m=3){const s=[];let r=1;s.push({step:'start',isResult:false,val:1,msg:`Computing ${n}^${m}`});
       for(let i=0;i<m;i++){r*=n;s.push({step:`√ó${n}`,isResult:false,val:r,msg:`Step ${i+1}: result = ${r}`});}
       s.push({step:'done',isResult:true,val:r,msg:`${n}^${m} = ${r}`});return s;}
    },
    {id:'sqrt',icon:'‚àö',name:'Square Root',desc:'Babylonian square root method',needsN2:false,
     code:`x = n\nfor _ in range(10):\n    x = (x + n/x) / 2\nprint(round(x, 4))`,
     run(n){const s=[];let x=n;s.push({step:'start',isResult:false,val:x,msg:`Approximating ‚àö${n}`});
       for(let i=0;i<8;i++){x=(x+n/x)/2;s.push({step:`iter ${i+1}`,isResult:false,val:+x.toFixed(6),msg:`x = ${x.toFixed(6)}`});}
       s.push({step:'done',isResult:true,val:+Math.sqrt(n).toFixed(6),msg:`‚àö${n} ‚âà ${Math.sqrt(n).toFixed(6)}`});return s;}
    },
    {id:'sum_natural',icon:'‚àë',name:'Sum of N Numbers',desc:'Sum 1+2+...+N',needsN2:false,
     code:`total = 0\nfor i in range(1, n+1):\n    total += i\nprint(total)`,
     run(n){const s=[];let t=0;for(let i=1;i<=n;i++){t+=i;s.push({step:`+${i}`,isResult:false,val:t,msg:`Sum so far: ${t}`});}
       s.push({step:'done',isResult:true,val:t,msg:`Sum = ${t} (formula: n*(n+1)/2 = ${n*(n+1)/2})`});return s;}
    },
    {id:'lcm',icon:'√ó',name:'LCM',desc:'Least Common Multiple of two numbers',needsN2:true,
     code:`import math\nlcm = abs(a*b)//math.gcd(a,b)`,
     run(n,m=8){function gcd(a,b){return b?gcd(b,a%b):a;}const g=gcd(n,m),l=Math.abs(n*m)/g;
       return [{step:'GCD',isResult:false,val:g,msg:`GCD(${n},${m}) = ${g}`},{step:'LCM',isResult:true,val:l,msg:`LCM = |${n}√ó${m}| / ${g} = ${l}`}];}
    },
    {id:'digit_sum',icon:'üî£',name:'Digit Sum',desc:'Sum of all digits of N',needsN2:false,
     code:`total = sum(int(d) for d in str(n))`,
     run(n){const s=[];const digits=String(n).split('').map(Number);let t=0;
       digits.forEach(d=>{t+=d;s.push({step:`+${d}`,isResult:false,val:t,msg:`Add digit ${d}, sum = ${t}`});});
       s.push({step:'done',isResult:true,val:t,msg:`Digit sum of ${n} = ${t}`});return s;}
    },
  ],
  string:[
    {id:'vowel_count',icon:'üî§',name:'Count Vowels',desc:'Count vowels in your word',isString:true,needsStr2:false,
     code:`word = input("Enter word: ")\nvowels = "aeiouAEIOU"\ncount = 0\nfor ch in word:\n    if ch in vowels:\n        count += 1\nprint(f"Vowels: {count}")`,
     run(str1){
       const w=str1||'hello';const s=[];let c=0;
       s.push({step:'start',isResult:false,val:w,msg:`Checking each character in "${w}"`});
       [...w].forEach((ch)=>{const isV='aeiouAEIOU'.includes(ch);if(isV)c++;
         s.push({step:`'${ch}'`,isResult:isV,val:ch,msg:`'${ch}' is ${isV?'a VOWEL ‚úì':'a consonant, skip'}`});});
       s.push({step:'done',isResult:true,val:c,msg:`"${w}" has ${c} vowel${c!==1?'s':''}`});return s;}
    },
    {id:'consonant_count',icon:'üî°',name:'Count Consonants',desc:'Count consonants in your word',isString:true,needsStr2:false,
     code:`word = input("Enter word: ")\nvowels = "aeiouAEIOU"\ncount = sum(1 for c in word if c.isalpha() and c not in vowels)\nprint(f"Consonants: {count}")`,
     run(str1){
       const w=str1||'hello';const s=[];let c=0;
       s.push({step:'start',isResult:false,val:w,msg:`Checking consonants in "${w}"`});
       [...w].forEach((ch)=>{const isAlpha=/[a-zA-Z]/.test(ch),isV='aeiouAEIOU'.includes(ch),isCons=isAlpha&&!isV;if(isCons)c++;
         s.push({step:`'${ch}'`,isResult:isCons,val:ch,msg:`'${ch}' is ${!isAlpha?'not a letter':isV?'a vowel':'a CONSONANT'}`});});
       s.push({step:'done',isResult:true,val:c,msg:`"${w}" has ${c} consonant${c!==1?'s':''}`});return s;}
    },
    {id:'str_reverse',icon:'‚Ü©',name:'Reverse String',desc:'Reverse your word step-by-step',isString:true,needsStr2:false,
     code:`word = input("Enter word: ")\nresult = ""\nfor ch in reversed(word):\n    result += ch\nprint(result)`,
     run(str1){
       const w=str1||'hello';const arr=[...w];let l=0,r=arr.length-1;const s=[];
       s.push({step:'start',isResult:false,val:arr.join(''),msg:`Reversing "${w}" using two-pointer technique`});
       while(l<r){
         s.push({step:`swap[${l}]‚Üî[${r}]`,isResult:false,val:arr.join(''),msg:`Swapping '${arr[l]}' at [${l}] with '${arr[r]}' at [${r}]`});
         [arr[l],arr[r]]=[arr[r],arr[l]];
         s.push({step:'after swap',isResult:false,val:arr.join(''),msg:`After swap: "${arr.join('')}"`});
         l++;r--;
       }
       s.push({step:'done',isResult:true,val:arr.join(''),msg:`Reversed "${w}" ‚Üí "${arr.join('')}"`});return s;}
    },
    {id:'palindrome_str',icon:'üîÅ',name:'Palindrome String',desc:'Check if your word is palindrome',isString:true,needsStr2:false,
     code:`word = input("Enter word: ").lower()\nif word == word[::-1]:\n    print("Palindrome")\nelse:\n    print("Not palindrome")`,
     run(str1){
       const w=(str1||'racecar').toLowerCase();const rev=[...w].reverse().join('');const s=[];
       s.push({step:'original',isResult:false,val:w,msg:`Original: "${w}"`});
       [...w].forEach((ch,i)=>{s.push({step:`[${i}]‚Üî[${w.length-1-i}]`,isResult:ch===rev[i],val:`${ch}=${rev[i]}`,msg:`Comparing '${ch}' with '${rev[i]}'`});});
       const isPalin=w===rev;
       s.push({step:'result',isResult:isPalin,val:isPalin?'PALINDROME ‚úì':'NOT Palindrome',msg:isPalin?`"${w}" reads same forwards and backwards!`:`"${w}" ‚â† "${rev}"`});return s;}
    },
    {id:'anagram',icon:'üîÄ',name:'Anagram Check',desc:'Check if two words are anagrams',isString:true,needsStr2:true,
     code:`s1 = input("Word 1: ").lower()\ns2 = input("Word 2: ").lower()\nif sorted(s1) == sorted(s2):\n    print("Anagram")\nelse:\n    print("Not anagram")`,
     run(str1,str2){
       const a=(str1||'listen').toLowerCase(),b=(str2||'silent').toLowerCase();const s=[];
       s.push({step:'word1',isResult:false,val:a,msg:`Word 1: "${a}" (${a.length} chars)`});
       s.push({step:'word2',isResult:false,val:b,msg:`Word 2: "${b}" (${b.length} chars)`});
       if(a.length!==b.length){s.push({step:'length check',isResult:false,val:'‚úó',msg:`Different lengths! ${a.length} ‚â† ${b.length}. Cannot be anagram.`});return s;}
       const sa=[...a].sort().join(''),sb=[...b].sort().join('');
       s.push({step:'sort word1',isResult:false,val:sa,msg:`Sorted "${a}" ‚Üí "${sa}"`});
       s.push({step:'sort word2',isResult:false,val:sb,msg:`Sorted "${b}" ‚Üí "${sb}"`});
       const isA=sa===sb;
       s.push({step:'compare',isResult:isA,val:isA?'ANAGRAM ‚úì':'NOT Anagram',msg:isA?`"${sa}" == "${sb}" ‚Üí ANAGRAM!`:`"${sa}" ‚â† "${sb}" ‚Üí Not anagram`});return s;}
    },
    {id:'str_upper',icon:'üî†',name:'Upper & Lower Case',desc:'Convert your string case',isString:true,needsStr2:false,
     code:`word = input("Enter string: ")\nupper = word.upper()\nlower = word.lower()\nprint(upper, lower)`,
     run(str1){
       const w=str1||'Hello World';const s=[];
       s.push({step:'original',isResult:false,val:w,msg:`Input: "${w}"`});
       [...w].forEach((ch,i)=>{
         const u=ch.toUpperCase(),l=ch.toLowerCase();
         const changed=u!==l;
         s.push({step:`[${i}]='${ch}'`,isResult:changed,val:`${l}‚Üí${u}`,msg:changed?`'${ch}' ‚Üí upper:'${u}' lower:'${l}'`:`'${ch}' is not a letter (unchanged)`});
       });
       s.push({step:'UPPER',isResult:true,val:w.toUpperCase(),msg:`Upper: "${w.toUpperCase()}"`});
       s.push({step:'lower',isResult:true,val:w.toLowerCase(),msg:`Lower: "${w.toLowerCase()}"`});return s;}
    },
    {id:'count_words',icon:'üìù',name:'Count Words',desc:'Count words in a sentence',isString:true,needsStr2:false,
     code:`sentence = input("Enter sentence: ")\nwords = sentence.split()\nprint(f"Word count: {len(words)}")`,
     run(str1){
       const sentence=str1||'hello world how are you';
       const words=sentence.trim().split(/\s+/).filter(Boolean);const s=[];
       s.push({step:'input',isResult:false,val:sentence,msg:`Sentence: "${sentence}"`});
       words.forEach((w,i)=>{s.push({step:`word ${i+1}`,isResult:true,val:w,msg:`Found word ${i+1}: "${w}"`});});
       s.push({step:'done',isResult:true,val:words.length,msg:`Total words: ${words.length}`});return s;}
    },
    {id:'str_freq',icon:'üìä',name:'Character Frequency',desc:'Count frequency of each character',isString:true,needsStr2:false,
     code:`word = input("Enter word: ")\nfreq = {}\nfor ch in word:\n    freq[ch] = freq.get(ch, 0) + 1\nprint(freq)`,
     run(str1){
       const w=str1||'programming';const freq={};const s=[];
       s.push({step:'start',isResult:false,val:w,msg:`Counting characters in "${w}"`});
       [...w].forEach((ch)=>{freq[ch]=(freq[ch]||0)+1;
         s.push({step:`'${ch}'`,isResult:true,val:`${ch}:${freq[ch]}`,msg:`'${ch}' count = ${freq[ch]}`});});
       s.push({step:'done',isResult:true,val:JSON.stringify(freq).replace(/"/g,''),msg:`Final frequency map`});return s;}
    },
  ],
};

let progCategory='number',progProgramId='even',progSteps=[],progStepIdx=0,progPlayIv=null;
let progVoiceLang='en', progCurrentStep=null;

function progSetLang(lang){
  progVoiceLang=lang;
  document.getElementById('prog-lang-en').classList.toggle('active',lang==='en');
  document.getElementById('prog-lang-hi').classList.toggle('active',lang==='hi');
  if(synth)synth.cancel();
}
function progStopSpeak(){if(synth)synth.cancel();const b=document.getElementById('prog-speak-btn');if(b){b.classList.remove('speaking');b.innerHTML='üîä <span id="prog-speak-label">Speak Step</span>';}}
function progSpeakText(text){
  if(!synth||!text)return;synth.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang=progVoiceLang==='hi'?'hi-IN':'en-US';u.rate=progVoiceLang==='hi'?0.88:0.92;u.pitch=1.05;
  if(progVoiceLang==='hi'&&voiceHI)u.voice=voiceHI;else if(voiceEN)u.voice=voiceEN;
  const btn=document.getElementById('prog-speak-btn');
  const bubble=document.getElementById('prog-voice-bubble');
  if(btn){btn.classList.add('speaking');btn.innerHTML=`<span class="wave"><span></span><span></span><span></span></span> <span>Speaking...</span>`;}
  if(bubble){bubble.style.display='block';bubble.textContent=text;}
  u.onend=u.onerror=()=>{if(btn){btn.classList.remove('speaking');btn.innerHTML='üîä <span id="prog-speak-label">Speak Step</span>';}};
  synth.speak(u);
}
function progSpeakCurrent(){
  if(progCurrentStep)progSpeakText(progGetNarration(progCurrentStep));
}
function progGetNarration(step){
  if(!step) return '';
  const msg=step.msg||'';
  if(progVoiceLang==='en') return msg;

  // Full Hindi narration per step content
  const id=progProgramId;
  const cat=progCategory;

  // ---- NUMBER PROGRAMS ----
  if(id==='even'){
    const m=msg.match(/(\d+) is EVEN/);if(m)return `${m[1]} ek even number hai kyunki yeh 2 se puri tarah divide ho jaata hai.`;
    const m2=msg.match(/(\d+) is odd/);if(m2)return `${m2[1]} odd hai, isliye hum ise chhod dete hain.`;
    return msg;
  }
  if(id==='odd'){
    const m=msg.match(/(\d+) is ODD/);if(m)return `${m[1]} ek odd number hai kyunki yeh 2 se divide hone par remainder aata hai.`;
    const m2=msg.match(/(\d+) is even/);if(m2)return `${m2[1]} even hai, isliye hum ise skip karte hain.`;
    return msg;
  }
  if(id==='prime'){
    const m=msg.match(/(\d+) is PRIME/);if(m)return `${m[1]} ek prime number hai. Iska koi bhi factor 1 aur khud ke alawa nahi hai.`;
    const m2=msg.match(/(\d+) is not prime/);if(m2)return `${m2[1]} prime number nahi hai, iska koi factor maujood hai.`;
    return msg;
  }
  if(id==='fibonacci'){
    const m=msg.match(/F\((\d+)\)=(\d+)/);if(m)return `Fibonacci ka term number ${m[1]} hai, aur uski value ${m[2]} hai.`;
    return msg;
  }
  if(id==='factorial'){
    const m=msg.match(/result = result √ó (\d+) = (\d+)/);if(m)return `Result ko ${m[1]} se multiply kiya, ab result ${m[2]} ho gaya.`;
    const m2=msg.match(/(\d+)! = (\d+)/);if(m2)return `${m2[1]} ka factorial ${m2[2]} hai. Yeh saare numbers ka product hai 1 se lekar ${m2[1]} tak.`;
    return msg;
  }
  if(id==='armstrong'){
    const m=msg.match(/(\d+) ‚Üí ARMSTRONG/);if(m)return `${m[1]} ek Armstrong number hai! Iske digits ke powers ka sum khud ${m[1]} ke barabar hai.`;
    return msg;
  }
  if(id==='palindrome'){
    if(msg.includes('PALINDROME'))return `Yeh number palindrome hai! Aage aur peechhe se padho toh same lagta hai.`;
    if(msg.includes('Not palindrome'))return `Yeh number palindrome nahi hai, kyunki ulta karne par alag dikhta hai.`;
    return msg;
  }
  if(id==='perfect'){
    const m=msg.match(/(\d+) ‚Üí PERFECT/);if(m)return `${m[1]} ek perfect number hai! Iske saare proper divisors ka sum khud uski value ke barabar hai.`;
    return msg;
  }
  if(id==='gcd'){
    const m=msg.match(/GCD\((\d+),(\d+)\)/);if(m)return `Ab hum ${m[1]} aur ${m[2]} ka GCD nikaal rahe hain, Euclidean algorithm se.`;
    const m2=msg.match(/GCD\((\d+),(\d+)\) = (\d+)/);if(m2)return `${m2[1]} aur ${m2[2]} ka GCD yani HCF ${m2[3]} hai.`;
    return msg;
  }
  if(id==='reverse'){
    const m=msg.match(/Extract digit (\d+), rev becomes (\d+)/);if(m)return `Digit ${m[1]} nikala, aur ulta number ab ${m[2]} ho gaya.`;
    const m2=msg.match(/Reversed: (\d+)/);if(m2)return `Number ko ulta kar diya. Final answer hai ${m2[1]}.`;
    return msg;
  }

  // ---- PATTERN PROGRAMS ----
  if(cat==='pattern'){
    const rm=msg.match(/Row (\d+):.*stars=(\d+)/);if(rm)return `Row number ${rm[1]} mein ${rm[2]} stars hain, jo bilkul beech mein print honge.`;
    const rm2=msg.match(/Row (\d+): print (.+)/);if(rm2)return `Row ${rm2[1]}: ab ${rm2[2]} print ho raha hai.`;
    const pm=msg.match(/Pascal row (\d+): \[(.+)\]/);if(pm)return `Pascal triangle ki ${pm[1]}vi row hai, jisme values ${pm[2]} hain.`;
    if(msg.includes('Upper row'))return msg.replace('Upper row','Upar wali row');
    if(msg.includes('Lower row'))return msg.replace('Lower row','Neeche wali row');
    return msg;
  }

  // ---- MATH PROGRAMS ----
  if(id==='power'){
    const m=msg.match(/Computing (\d+)\^(\d+)/);if(m)return `${m[1]} ki power ${m[2]} nikaal rahe hain, ek ek karke multiply karenge.`;
    const m2=msg.match(/(\d+)\^(\d+) = (\d+)/);if(m2)return `${m2[1]} ki power ${m2[2]}, yani ${m2[1]}^${m2[2]}, ka jawab ${m2[3]} hai.`;
    return msg;
  }
  if(id==='sqrt'){
    const m=msg.match(/Approximating ‚àö(\d+)/);if(m)return `${m[1]} ka square root Babylonian method se nikaal rahe hain.`;
    const m2=msg.match(/‚àö(\d+) ‚âà ([\d.]+)/);if(m2)return `${m2[1]} ka square root lagbhag ${m2[2]} hai.`;
    return msg;
  }
  if(id==='sum_natural'){
    const m=msg.match(/Sum so far: (\d+)/);if(m)return `Abhi tak ka yog ${m[1]} hai.`;
    const m2=msg.match(/Sum = (\d+)/);if(m2)return `1 se N tak ke saare numbers ka yog ${m2[1]} hai.`;
    return msg;
  }
  if(id==='lcm'){
    const m=msg.match(/LCM = .* = (\d+)/);if(m)return `Dono numbers ka LCM yani Laghu Samapavartya ${m[1]} hai.`;
    return msg;
  }
  if(id==='digit_sum'){
    const m=msg.match(/Add digit (\d+), sum = (\d+)/);if(m)return `Digit ${m[1]} ko sum mein jo‡§°‡§ºa, ab sum ${m[2]} ho gaya.`;
    const m2=msg.match(/Digit sum of (\d+) = (\d+)/);if(m2)return `${m2[1]} ke saare digits ka yog ${m2[2]} hai.`;
    return msg;
  }

  // ---- STRING PROGRAMS ----
  if(id==='vowel_count'){
    const m=msg.match(/'(.+)' is a VOWEL/);if(m)return `'${m[1]}' ek swar hai. Swar hote hain a, e, i, o, u.`;
    const m2=msg.match(/'(.+)' is a consonant/);if(m2)return `'${m2[1]}' ek vyanjan hai, isliye hum ise chhod dete hain.`;
    const m3=msg.match(/"(.+)" has (\d+) vowel/);if(m3)return `"${m3[1]}" mein kul ${m3[2]} swar hain.`;
    return msg;
  }
  if(id==='consonant_count'){
    const m=msg.match(/'(.+)' is a CONSONANT/);if(m)return `'${m[1]}' ek vyanjan hai.`;
    const m2=msg.match(/'(.+)' is a vowel/);if(m2)return `'${m2[1]}' ek swar hai, isliye count nahi hoga.`;
    const m3=msg.match(/"(.+)" has (\d+) consonant/);if(m3)return `"${m3[1]}" mein kul ${m3[2]} vyanjan hain.`;
    return msg;
  }
  if(id==='str_reverse'){
    const m=msg.match(/Reversing "(.+)" using two-pointer/);if(m)return `"${m[1]}" ko ulta karne ke liye do pointer use karenge. Ek shuruaat se, ek ant se.`;
    const m2=msg.match(/Swapping '(.+)' at \[(\d+)\] with '(.+)' at \[(\d+)\]/);if(m2)return `Index ${m2[2]} par '${m2[1]}' aur index ${m2[4]} par '${m2[3]}' ko swap kar rahe hain.`;
    const m3=msg.match(/Reversed ".+" ‚Üí "(.+)"/);if(m3)return `Shabad ko ulta kar diya. Naya shabad hai "${m3[1]}".`;
    return msg;
  }
  if(id==='palindrome_str'){
    const m=msg.match(/Original: "(.+)"/);if(m)return `Hamara shabad hai "${m[1]}". Ab hum check karenge ki yeh palindrome hai ya nahi.`;
    if(msg.includes('PALINDROME'))return `Yeh shabad palindrome hai! Aage aur peechhe se padho toh same lagta hai.`;
    if(msg.includes('NOT Palindrome'))return `Yeh shabad palindrome nahi hai.`;
    return msg;
  }
  if(id==='anagram'){
    const m=msg.match(/Word 1: "(.+)"/);if(m)return `Pehla shabad hai "${m[1]}". Ab iska comparison karenge.`;
    const m2=msg.match(/Sorted "(.+)" ‚Üí "(.+)"/);if(m2)return `"${m2[1]}" ke letters sort karne ke baad "${m2[2]}" bana.`;
    if(msg.includes('ANAGRAM'))return `Dono shabdon ke sorted letters same hain, isliye yeh anagram hain!`;
    if(msg.includes('Not anagram'))return `Sorted letters alag hain, isliye yeh anagram nahi hain.`;
    return msg;
  }
  if(id==='str_upper'){
    const m=msg.match(/'(.+)' ‚Üí upper:'(.+)' lower:'(.+)'/);if(m)return `'${m[1]}' ka uppercase '${m[2]}' aur lowercase '${m[3]}' hai.`;
    const m2=msg.match(/Upper: "(.+)"/);if(m2)return `Uppercase version hai: "${m2[1]}".`;
    const m3=msg.match(/Lower: "(.+)"/);if(m3)return `Lowercase version hai: "${m3[1]}".`;
    return msg;
  }
  if(id==='count_words'){
    const m=msg.match(/Found word (\d+): "(.+)"/);if(m)return `Word number ${m[1]} mila: "${m[2]}".`;
    const m2=msg.match(/Total words: (\d+)/);if(m2)return `Vakya mein kul ${m2[1]} shabd hain.`;
    return msg;
  }
  if(id==='str_freq'){
    const m=msg.match(/'(.+)' count = (\d+)/);if(m)return `Letter '${m[1]}' ab tak ${m[2]} baar aaya hai.`;
    if(msg.includes('frequency map'))return `Saare letters ki frequency map taiyaar ho gayi.`;
    return msg;
  }

  return msg; // fallback: return English
}

function progSelectCat(cat,el){
  progCategory=cat;
  document.querySelectorAll('.prog-cats .ds-cat-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  progProgramId='';
  document.getElementById('prog-input-row').style.display='none';
  document.getElementById('prog-viz-area').style.display='none';
  document.getElementById('prog-pattern-area').style.display='none';
  document.getElementById('prog-step-box').style.display='none';
  document.getElementById('prog-code-area').style.display='none';
  document.getElementById('prog-voice-bar').style.display='none';
  renderProgList();
}

function renderProgList(){
  const list=document.getElementById('prog-list');
  const progs=PROGRAMS[progCategory]||[];
  list.innerHTML=progs.map(p=>`
    <div class="prog-card${p.id===progProgramId?' active':''}" onclick="selectProgram('${p.id}',this)">
      <div class="prog-card-icon">${p.icon}</div>
      <div class="prog-card-name">${p.name}</div>
      <div class="prog-card-desc">${p.desc}</div>
    </div>`).join('');
}

function selectProgram(id,el){
  progProgramId=id;
  document.querySelectorAll('.prog-card').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  resetProgram();
  const prog=PROGRAMS[progCategory].find(p=>p.id===id);
  if(!prog)return;
  const isStr=progCategory==='string';
  const isPat=progCategory==='pattern';

  // Show input row
  document.getElementById('prog-input-row').style.display='block';
  document.getElementById('prog-voice-bar').style.display='flex';

  // Toggle number vs string inputs
  document.getElementById('prog-num-inputs').style.display=isStr?'none':'flex';
  document.getElementById('prog-str-inputs').style.display=isStr?'flex':'none';
  document.getElementById('prog-n2-wrap').style.display=(!isStr&&prog.needsN2)?'block':'none';
  document.getElementById('prog-str2-wrap').style.display=(isStr&&prog.needsStr2)?'block':'none';

  // Show correct visual area
  document.getElementById('prog-pattern-area').style.display=isPat?'block':'none';
  document.getElementById('prog-viz-area').style.display=isPat?'none':'block';
  document.getElementById('prog-step-box').style.display='block';
  document.getElementById('prog-code-area').style.display='block';
  document.getElementById('prog-code-title').textContent=`${id}.py`;
  document.getElementById('prog-code-display').textContent=prog.code;
  document.getElementById('prog-step-text').textContent=isStr?'Enter your word and press Run.':'Enter N and press Run.';

  // Label N input
  const nLabel=document.getElementById('prog-n-label');
  if(nLabel)nLabel.textContent=prog.needsN2?'First Number (a)':'N';

  // Fit pattern canvas
  if(isPat){
    setTimeout(()=>{
      const cvs=document.getElementById('prog-pattern-canvas');
      if(cvs){cvs.width=cvs.offsetWidth;cvs.height=Math.max(280,cvs.offsetWidth*0.4);}
    },50);
  }
}

// Accumulated pattern rows for canvas drawing
let patternRows=[];

function runProgram(){
  resetProgram();
  const prog=PROGRAMS[progCategory].find(p=>p.id===progProgramId);if(!prog)return;
  const isStr=progCategory==='string';
  let steps;
  if(isStr){
    const s1=(document.getElementById('prog-str-input').value||'hello').toLowerCase().trim();
    const s2=(document.getElementById('prog-str2-input').value||'world').toLowerCase().trim();
    steps=prog.run(s1,s2);
  } else {
    const n=parseInt(document.getElementById('prog-n-input').value)||10;
    const m=parseInt(document.getElementById('prog-n2-input').value)||8;
    steps=prog.run(n,m);
  }
  progSteps=steps;progStepIdx=0;
  const spd=+document.getElementById('prog-speed').value;
  const delay=Math.round(1200/spd);
  progPlayIv=setInterval(()=>{
    if(progStepIdx>=progSteps.length){clearInterval(progPlayIv);return;}
    renderProgStep(progSteps[progStepIdx]);progStepIdx++;
  },delay);
}

function stepProgram(){
  if(progStepIdx>=progSteps.length)return;
  renderProgStep(progSteps[progStepIdx]);progStepIdx++;
}

function resetProgram(){
  if(progPlayIv)clearInterval(progPlayIv);
  progStopSpeak();
  progStepIdx=0;progCurrentStep=null;patternRows=[];
  document.getElementById('prog-visual').innerHTML='';
  document.getElementById('prog-step-text').textContent='Ready.';
  document.getElementById('prog-voice-bubble').style.display='none';
  // Clear pattern canvas
  const cvs=document.getElementById('prog-pattern-canvas');
  if(cvs){const c=cvs.getContext('2d');c.clearRect(0,0,cvs.width,cvs.height);}
}

function renderProgStep(step){
  progCurrentStep=step;
  document.getElementById('prog-step-text').textContent=step.msg||'';

  // Auto-speak
  if(document.getElementById('prog-auto-speak')&&document.getElementById('prog-auto-speak').checked){
    progSpeakText(progGetNarration(step));
  }

  if(progCategory==='pattern'){
    renderPatternStep(step);
  } else {
    const vis=document.getElementById('prog-visual');
    const chip=document.createElement('span');
    const val=typeof step.val==='string'?step.val:String(step.val??'');
    chip.style.cssText=`display:inline-block;margin:3px;padding:6px 12px;border-radius:8px;font-family:'Space Mono',monospace;font-size:.82rem;font-weight:700;animation:fadeIn .2s ease;background:${step.isResult?'rgba(0,245,196,.18)':'rgba(58,58,110,.5)'};border:1.5px solid ${step.isResult?'#00f5c4':'#3a3a6e'};color:${step.isResult?'#00f5c4':'#7070aa'};`;
    chip.textContent=val;
    vis.appendChild(chip);
    vis.scrollTop=vis.scrollHeight;
  }
}

// Pattern canvas renderer ‚Äî TRUE center alignment, no space offsets
function renderPatternStep(step){
  if(!step.isResult) return;
  const cvs=document.getElementById('prog-pattern-canvas');
  if(!cvs) return;
  patternRows.push(step);

  const CELL=30, GAP=4, PAD=24;
  const totalR=patternRows.length;
  const W=cvs.offsetWidth||800;
  cvs.width=W;
  cvs.height=Math.max(300, PAD*2 + totalR*(CELL+GAP));

  const c=cvs.getContext('2d');
  c.fillStyle='#0a0a0f';
  c.fillRect(0,0,W,cvs.height);
  // subtle grid
  c.strokeStyle='rgba(255,255,255,0.02)';c.lineWidth=1;
  for(let gx=0;gx<W;gx+=50){c.beginPath();c.moveTo(gx,0);c.lineTo(gx,cvs.height);c.stroke();}

  patternRows.forEach((row,ri)=>{
    const y=PAD+ri*(CELL+GAP);
    const isCurrent=ri===totalR-1;
    const fade=0.4+0.6*(ri/Math.max(totalR-1,1));

    if(row.patId==='hollow' && row.grid){
      const n=row.grid.length;
      const rowW=n*(CELL+GAP)-GAP;
      const rx=Math.floor((W-rowW)/2);
      row.grid.forEach((filled,ci)=>{
        patDrawCell(c,rx+ci*(CELL+GAP),y,CELL,filled,isCurrent,fade,null);
      });
    } else if(row.nums){
      const nums=row.nums;
      const cw=row.patId==='pascal'?CELL+8:CELL;
      const rowW=nums.length*(cw+GAP)-GAP;
      const rx=Math.floor((W-rowW)/2);
      nums.forEach((v,ci)=>patDrawCell(c,rx+ci*(cw+GAP),y,cw,true,isCurrent,fade,String(v)));
    } else {
      // *** KEY FIX: center ONLY by star count ‚Äî ignore any space offsets ***
      const stars=row.stars||1;
      const rowW=stars*(CELL+GAP)-GAP;
      const rx=Math.floor((W-rowW)/2);
      for(let s=0;s<stars;s++) patDrawCell(c,rx+s*(CELL+GAP),y,CELL,true,isCurrent,fade,null);
    }

    // Row number label
    const labelX=Math.floor(W/2)+Math.floor(((row.stars||1)*(CELL+GAP))/2)+14;
    c.fillStyle=isCurrent?'rgba(255,217,61,.8)':'rgba(80,80,120,.7)';
    c.font=`${isCurrent?'bold ':''}10px Space Mono,monospace`;
    c.textAlign='left';c.textBaseline='middle';
    c.fillText(`row ${ri+1}`, Math.min(labelX, W-56), y+CELL/2);
  });
}

function patDrawCell(c,x,y,w,filled,isCurrent,fade,label){
  if(!filled){
    c.fillStyle='rgba(20,20,40,.6)';c.strokeStyle='rgba(58,58,110,.25)';c.lineWidth=1;
    patRR(c,x+2,y+2,w-4,w-4,5);c.fill();c.stroke();
    return;
  }
  const col=isCurrent?'#ffd93d':fade>0.7?'#00f5c4':'#a78bfa';
  c.shadowColor=col;c.shadowBlur=isCurrent?18:6;
  c.fillStyle=isCurrent?'rgba(255,217,61,.22)':fade>0.7?'rgba(0,245,196,.1)':'rgba(167,139,250,.1)';
  c.strokeStyle=col;c.lineWidth=isCurrent?2.2:1.5;
  patRR(c,x+2,y+2,w-4,w-4,6);c.fill();c.stroke();
  c.shadowBlur=0;
  c.fillStyle=isCurrent?'#ffd93d':col;
  c.font=`bold ${label?Math.min(12,w-8):13}px Space Mono,monospace`;
  c.textAlign='center';c.textBaseline='middle';
  c.fillText(label||'‚òÖ',x+w/2,y+w/2);
}

function patRR(c,x,y,w,h,r){
  c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath();
}
function rRectProg(c,x,y,w,h,r){patRR(c,x,y,w,h,r);}

// ============================================================
// GLOBAL SEARCH
// ============================================================
const SEARCH_INDEX=[
  // Algos
  {name:'Selection Sort',cat:'Sorting',icon:'üîÄ',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('selection',document.querySelector('.algo-tab'))}},
  {name:'Bubble Sort',cat:'Sorting',icon:'ü´ß',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('bubble',null)}},
  {name:'Insertion Sort',cat:'Sorting',icon:'üì•',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('insertion',null)}},
  {name:'Merge Sort',cat:'Sorting',icon:'üîÄ',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('merge',null)}},
  {name:'Quick Sort',cat:'Sorting',icon:'‚ö°',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('quick',null)}},
  {name:'Heap Sort',cat:'Sorting',icon:'üèî',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('heap',null)}},
  {name:'Shell Sort',cat:'Sorting',icon:'üêö',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('shell',null)}},
  {name:'Counting Sort',cat:'Sorting',icon:'üî¢',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('counting',null)}},
  {name:'Binary Search',cat:'Searching',icon:'üéØ',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('binary',null)}},
  {name:'Linear Search',cat:'Searching',icon:'üîç',badge:'Algorithm',color:'#00f5c4',action:()=>{showPageByName('single');selectAlgo('linear',null)}},
  // DS
  {name:'Array',cat:'Data Structure',icon:'üì¶',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');dsSelectCategory('array',document.querySelector('.ds-cat-btn'))}},
  {name:'Linked List',cat:'Data Structure',icon:'üîó',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('linkedlist',document.querySelectorAll('.ds-cat-btn')[1]),100)}},
  {name:'Singly Linked List',cat:'Data Structure',icon:'‚Üí',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('linkedlist',document.querySelectorAll('.ds-cat-btn')[1]),100)}},
  {name:'Doubly Linked List',cat:'Data Structure',icon:'‚Üî',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('linkedlist',document.querySelectorAll('.ds-cat-btn')[1]),100)}},
  {name:'Circular Linked List',cat:'Data Structure',icon:'üîÑ',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('linkedlist',document.querySelectorAll('.ds-cat-btn')[1]),100)}},
  {name:'Stack',cat:'Data Structure',icon:'üìö',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('stack',document.querySelectorAll('.ds-cat-btn')[2]),100)}},
  {name:'Queue',cat:'Data Structure',icon:'üö∂',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('queue',document.querySelectorAll('.ds-cat-btn')[3]),100)}},
  {name:'Circular Queue',cat:'Data Structure',icon:'üîÑ',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('queue',document.querySelectorAll('.ds-cat-btn')[3]),100)}},
  {name:'Priority Queue',cat:'Data Structure',icon:'‚≠ê',badge:'DS',color:'#ff6b6b',action:()=>{showPageByName('ds');setTimeout(()=>dsSelectCategory('queue',document.querySelectorAll('.ds-cat-btn')[3]),100)}},
  // Programs
  {name:'Even Numbers',cat:'Programs',icon:'2Ô∏è‚É£',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();setTimeout(()=>selectProgram('even',document.querySelector('.prog-card')),100)}},
  {name:'Odd Numbers',cat:'Programs',icon:'1Ô∏è‚É£',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();}},
  {name:'Prime Numbers',cat:'Programs',icon:'üî¢',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();}},
  {name:'Fibonacci',cat:'Programs',icon:'üåÄ',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();}},
  {name:'Factorial',cat:'Programs',icon:'‚ùó',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();}},
  {name:'Palindrome',cat:'Programs',icon:'üîÅ',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();}},
  {name:'Armstrong Numbers',cat:'Programs',icon:'üí™',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('number',document.querySelector('.prog-cats .ds-cat-btn'));renderProgList();}},
  {name:'Pyramid Pattern',cat:'Programs',icon:'‚ñ≥',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('pattern',document.querySelectorAll('.prog-cats .ds-cat-btn')[1]);renderProgList();}},
  {name:'Diamond Pattern',cat:'Programs',icon:'üíé',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('pattern',document.querySelectorAll('.prog-cats .ds-cat-btn')[1]);renderProgList();}},
  {name:"Pascal's Triangle",cat:'Programs',icon:'üî∫',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('pattern',document.querySelectorAll('.prog-cats .ds-cat-btn')[1]);renderProgList();}},
  {name:'GCD / HCF',cat:'Programs',icon:'√∑',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('math',document.querySelectorAll('.prog-cats .ds-cat-btn')[2]);renderProgList();}},
  {name:'LCM',cat:'Programs',icon:'√ó',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('math',document.querySelectorAll('.prog-cats .ds-cat-btn')[2]);renderProgList();}},
  {name:'Sum of N Numbers',cat:'Programs',icon:'‚àë',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('math',document.querySelectorAll('.prog-cats .ds-cat-btn')[2]);renderProgList();}},
  {name:'Count Vowels',cat:'Programs',icon:'üî§',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('string',document.querySelectorAll('.prog-cats .ds-cat-btn')[3]);renderProgList();}},
  {name:'Reverse String',cat:'Programs',icon:'‚Ü©',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('string',document.querySelectorAll('.prog-cats .ds-cat-btn')[3]);renderProgList();}},
  {name:'Anagram Check',cat:'Programs',icon:'üîÄ',badge:'Program',color:'#a78bfa',action:()=>{showPageByName('programs');progSelectCat('string',document.querySelectorAll('.prog-cats .ds-cat-btn')[3]);renderProgList();}},
];

function globalSearch(q){
  const dd=document.getElementById('search-results-dropdown');
  if(!q.trim()){dd.style.display='none';return;}
  const results=SEARCH_INDEX.filter(item=>
    item.name.toLowerCase().includes(q.toLowerCase())||
    item.cat.toLowerCase().includes(q.toLowerCase())
  ).slice(0,10);
  if(!results.length){dd.style.display='none';return;}
  dd.style.display='block';
  dd.innerHTML=results.map((r,i)=>`
    <div class="search-result-item" onclick="searchGo(${i},this)" data-idx="${i}">
      <span class="sr-icon">${r.icon}</span>
      <div>
        <div class="sr-name">${r.name}</div>
        <div class="sr-cat">${r.cat}</div>
      </div>
      <span class="sr-badge" style="background:${r.color}22;color:${r.color};border:1px solid ${r.color}44;">${r.badge}</span>
    </div>`).join('');
  // Store results for action
  dd._results=results;
}

function searchGo(idx,el){
  const dd=document.getElementById('search-results-dropdown');
  const results=dd._results||[];
  if(results[idx]) results[idx].action();
  dd.style.display='none';
  document.getElementById('global-search').value='';
}

function clearSearch(){
  document.getElementById('global-search').value='';
  document.getElementById('search-results-dropdown').style.display='none';
}

function showPageByName(name){
  const tabs=document.querySelectorAll('.nav-tab');
  tabs.forEach(t=>{
    if(t.getAttribute('onclick')&&t.getAttribute('onclick').includes(`'${name}'`)){
      showPage(name,t);
      tabs.forEach(tt=>tt.classList.remove('active'));
      t.classList.add('active');
    }
  });
}

// Close search on outside click
document.addEventListener('click',e=>{
  if(!e.target.closest('#global-search-bar'))
    document.getElementById('search-results-dropdown').style.display='none';
});

window.addEventListener('load',()=>{
  renderCode('code-display','selection');
  updateRecapCard('selection');
  randomize();
  slArray=Array.from({length:12},()=>Math.floor(Math.random()*85)+8);
  // Init DS section with default array category
  dsSelectCategory('array', document.querySelector('#page-ds .ds-cat-btn'));
  // Init programs list
  renderProgList();
  // Init interview questions
  iqRender();
});
window.addEventListener('resize',()=>{
  if(steps.length)drawVizStep(canvas,ctx,steps,Math.max(0,stepIdx-1),curAlgo);
});
</script>
</body>
</html>
